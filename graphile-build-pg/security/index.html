<!DOCTYPE html>
 <html lang="en"><head><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous"/><script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="preload" href="/page-component---src-templates-page-js-7c7ac3f6709c5c7bb323.js" as="script"/><link rel="preload" href="/path---graphile-build-pg-security-b1a7d5a8d05f31f1f555.js" as="script"/><link rel="preload" href="/layout-component---index-6fa9b1d9bb85d2942f83.js" as="script"/><link rel="preload" href="/app-d9a489cf6c787f5764be.js" as="script"/><link rel="preload" href="/commons-b2b3eb6e53cc89aeda26.js" as="script"/><script id="webpack-manifest">
            //<![CDATA[
            window.webpackManifest = {"15178676390636814000":"app-d9a489cf6c787f5764be.js","10721449141870815000":"page-component---src-templates-marketing-js-a61fee54bf340a965e2e.js","11888651905112195000":"page-component---src-templates-page-js-7c7ac3f6709c5c7bb323.js","9347362237655822000":"path---index-5a16fa82b07cee0795e6.js","10353779828982186000":"path---graphile-build-pg-computed-columns-e31b225091310d21e8a3.js","4492181321655063000":"path---graphile-build-pg-connections-d7a04caef5e770a7e0db.js","14439627953788086000":"path---graphile-build-pg-crud-mutations-3fba39be60116f5537ad.js","10309254943916003000":"path---graphile-build-pg-custom-queries-479ff7fa6a5b94c49a6a.js","12287433332214546000":"path---graphile-build-pg-custom-mutations-2eb2f8791797477004b6.js","14459479492863674000":"path---graphile-build-pg-introduction-89f6317e72faea8e9e76.js","18368979182311373000":"path---graphile-build-pg-introspection-2eec6de59ac99dee5a09.js","845781737597514100":"path---graphile-build-pg-relations-7f6e882121b5ae9886fa.js","12610637221850356000":"path---graphile-build-pg-security-b1a7d5a8d05f31f1f555.js","12766977628268323000":"path---graphile-build-pg-settings-a956ed9819c7316958c7.js","6239648629531338000":"path---graphile-build-pg-usage-89fff6a67e47b0de4363.js","8428063392933112000":"path---graphile-build-all-hooks-5aec9ca658da1a3600ae.js","4195836923314832400":"path---graphile-build-build-object-7f094da2a729a52ba9a5.js","4555055688090620000":"path---graphile-build-context-object-6e8a50c422c405ddce7b.js","8250511738979511000":"path---graphile-build-default-plugins-bf03467d72f417aa1660.js","7205504750529626000":"path---graphile-build-getting-started-0285b8e9310ed9d7701c.js","1062387460204904600":"path---graphile-build-graphile-build-28422e48b1feaa74d204.js","3771791408109622300":"path---graphile-build-hooks-a51f252aa6e3bc0154fd.js","5002895319514266000":"path---graphile-build-look-ahead-4d844d57a4c4455a5b2a.js","2390399147881533400":"path---graphile-build-omitting-plugins-6d9d7f9bb92f604ecb19.js","18106655623105920000":"path---graphile-build-plugin-options-664cd65ec2477f832992.js","8948711028338852000":"path---graphile-build-plugins-a2ae718535cbed8ffb14.js","18184767599037770000":"path---graphile-build-schema-builder-e128ebb030f6855fa54f.js","17241999800008180000":"layout-component---index-6fa9b1d9bb85d2942f83.js"}
            //]]>
            </script><title data-react-helmet="true">Graphile | Security</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = location.hash.replace('#', '')
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><script>
  !function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",[
  "/commons-b2b3eb6e53cc89aeda26.js","/app-d9a489cf6c787f5764be.js","/layout-component---index-6fa9b1d9bb85d2942f83.js","/path---graphile-build-pg-security-b1a7d5a8d05f31f1f555.js","/page-component---src-templates-page-js-7c7ac3f6709c5c7bb323.js"
])
  </script><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><link rel="stylesheet" href="/styles.css"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="864950649"><div class="template-page" data-reactid="2"><!-- react-empty: 3 --><header data-reactid="4"><nav class="navbar navbar-toggleable-md navbar-inverse bg-inverse" data-reactid="5"><button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="6"><span class="navbar-toggler-icon" data-reactid="7"></span></button><a class="navbar-brand" href="/" data-reactid="8">Graphile</a><div class="collapse navbar-collapse" id="navbarSupportedContent" data-reactid="9"><ul class="navbar-nav mr-auto" data-reactid="10"><li class="nav-item" data-reactid="11"><a class="nav-link " href="/" data-reactid="12">Home</a></li><li class="nav-item" data-reactid="13"><a class="nav-link " href="/graphile-build/getting-started/" data-reactid="14">Graphile-Build</a></li><li class="nav-item" data-reactid="15"><a class="nav-link active" href="/graphile-build-pg/introduction/" data-reactid="16">Graphile-Build-PG</a></li></ul><span class="navbar-text" data-reactid="17"><a href="https://github.com/graphile/graphile-build" data-reactid="18"><img src="/images/GitHub-Mark-Light-120px-plus.png" width="26" data-reactid="19"/></a></span></div></nav></header><section style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0;" class="page-content" data-reactid="20"><div class="container" data-reactid="21"><div class="row" data-reactid="22"><div class="col-12 col-md-3 push-md-9" data-reactid="23"><div data-reactid="24"><h4 data-reactid="25">Guides</h4><ul class="nav flex-column" data-reactid="26"><li class="nav-item" data-reactid="27"><a class="nav-link " href="/graphile-build-pg/introduction/" data-reactid="28">Introduction</a></li><li class="nav-item" data-reactid="29"><a class="nav-link " href="/graphile-build-pg/usage/" data-reactid="30">Usage</a></li><li class="nav-item" data-reactid="31"><a class="nav-link " href="/graphile-build-pg/settings/" data-reactid="32">Settings</a></li><li class="nav-item" data-reactid="33"><a class="nav-link " href="/graphile-build-pg/connections/" data-reactid="34">Connections</a></li><li class="nav-item" data-reactid="35"><a class="nav-link " href="/graphile-build-pg/relations/" data-reactid="36">Relations</a></li><li class="nav-item" data-reactid="37"><a class="nav-link " href="/graphile-build-pg/crud-mutations/" data-reactid="38">CRUD Mutations</a></li><li class="nav-item" data-reactid="39"><a class="nav-link " href="/graphile-build-pg/computed-columns/" data-reactid="40">Computed Columns</a></li><li class="nav-item" data-reactid="41"><a class="nav-link " href="/graphile-build-pg/custom-queries/" data-reactid="42">Custom Queries</a></li><li class="nav-item" data-reactid="43"><a class="nav-link " href="/graphile-build-pg/custom-mutations/" data-reactid="44">Custom Mutations</a></li><li class="nav-item" data-reactid="45"><a class="nav-link active" href="/graphile-build-pg/security/" data-reactid="46">Security</a></li><li class="nav-item" data-reactid="47"><a class="nav-link " href="/graphile-build-pg/introspection/" data-reactid="48">Introspection</a></li></ul></div></div><div class="col-12 col-md-9 pull-md-3" data-reactid="49"><div class="container" data-reactid="50"><div class="row" data-reactid="51"><div style="width:100%;" data-reactid="52"><h2 id="security"><a href="#security" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security</h2>
<p>Traditionally in web application architectures the security is implemented in
the server layer and the database is treated as a dumb store of data - people
tend to figure that this reduces the workload on the database and thus
increases scalability. As their application grows, they start needing other
services to interact with the database too - which can mean that they need to
duplicate the authentication/authorization logic in multiple places which can
lead to discrepancies and increases the surface area for potential issues.</p>
<p>Instead, we advise that you protect your lowest level - the data itself. By
doing so you can be sure that no matter how many services interact with your
database they will all be protected by the same underlying permissions logic
which you only need to maintain in one place.</p>
<p>PostgreSQL already had a powerful permissions system built in with it's roles
and grants; but in PostgreSQL 9.5 Row Level Security policies were introduced.
These allow your application to be considerably more specific about permissions,
moving from table- and column-based permissions to row-level permissions.</p>
<p>When enabled, all rows are by default not visible to any roles (except database
administration roles and the role who created the database/table); and
permission is selectively granted with the use of policies.</p>
<p>If you already have a secure database schema that implements these technologies
to protect your data at the lowest levels then you can leverage
<code>graphile-build-pg</code> to generate a powerful, secure and fast API in minimal
time. All you need to do is pass a pre-authenticated pgClient to the <code>graphql</code>
resolve function.</p>
<h3 id="example"><a href="#example" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example</h3>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createPostGraphQLSchema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'graphile-build-pg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pgPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">pg<span class="token punctuation">.</span>Pool</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createPostGraphQLSchema</span><span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'users_schema'</span><span class="token punctuation">,</span> <span class="token string">'posts_schema'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      dynamicJson<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      pgJwtSecret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>JWT_SECRET<span class="token punctuation">,</span>
      pgJwtTypeIdentifier<span class="token punctuation">:</span> <span class="token string">'users_schema.jwt_type'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Fetch a postgres client from the pool</span>
  <span class="token keyword">const</span> pgClient <span class="token operator">=</span> <span class="token keyword">await</span> pgPool<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Start a transaction so we can apply settings local to the transaction</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The following statement is equivalent to (but faster than):</span>
    <span class="token comment" spellcheck="true">//    await pgClient.query("set local role to 'postgraphql_user'");</span>
    <span class="token comment" spellcheck="true">//    await pgClient.query("set local jwt.claims.user_id to '27'");</span>
    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`select
<span class="gatsby-highlight-code-line">      set_config('role', 'postgraphql_user', true),
</span><span class="gatsby-highlight-code-line">      set_config('jwt.claims.user_id', '27', true)
</span>    `</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">graphql</span><span class="token punctuation">(</span>
      schema<span class="token punctuation">,</span>
      query<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">      <span class="token comment" spellcheck="true">/* CONTEXT > */</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        pgClient<span class="token punctuation">:</span> pgClient<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* &lt; CONTEXT */</span>
</span>      variables
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// commit the transaction (or rollback if there was an error) to clear the local settings</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
    <span class="token comment" spellcheck="true">// Release the pgClient back to the pool.</span>
    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">runQuery</span><span class="token punctuation">(</span>
  <span class="token string">"query MyQuery { allPosts { nodes { id, title, author: userByAuthorId { username } } } }"</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>result <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pgPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>TODO: ensure this example works.</p>
<p>To see how this works in a real application, check out
<a href="https://github.com/postgraphql/postgraphql/blob/master/src/postgraphql/withPostGraphQLContext.ts"><code>withPostGraphQLContext</code> in
PostGraphQL</a></p></div></div><div class="row" data-reactid="53"><a class="btn btn-secondary btn-large" href="/graphile-build-pg/custom-mutations/" data-reactid="54"><!-- react-text: 55 -->« <!-- /react-text --><!-- react-text: 56 -->Custom Mutations<!-- /react-text --></a><div class="ml-auto" data-reactid="57"><a class="btn btn-primary btn-large" href="/graphile-build-pg/introspection/" data-reactid="58"><!-- react-text: 59 -->Introspection<!-- /react-text --><!-- react-text: 60 --> »<!-- /react-text --></a></div></div></div></div></div></div></section><footer data-reactid="61"><div class="container" data-reactid="62">Copyright © Benjie Gillam 2017</div></footer></div></div></div></body></html>