<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><script src="https://use.fontawesome.com/c72bfae6f9.js"></script><link rel="preload" href="/component---src-layouts-index-js-e7d7f19fc35a5d4bedc5.js" as="script"/><link rel="preload" href="/component---src-templates-page-js-aef27fe6fab65fb206bf.js" as="script"/><link rel="preload" href="/path---graphile-build-pg-security-d9a667e3f23772680caf.js" as="script"/><link rel="preload" href="/app-f5778d46f8140f35433d.js" as="script"/><link rel="preload" href="/commons-af24df79ddc393e5cf48.js" as="script"/><script id="webpack-manifest">
            //<![CDATA[
            window.webpackManifest = {"15178676390636814000":"app-f5778d46f8140f35433d.js","3918056598153407000":"component---src-templates-marketing-js-b965387c11eeb57eec09.js","6354438848726490000":"component---src-templates-page-js-aef27fe6fab65fb206bf.js","3954140758598355500":"path----557518bd178906f8d58a.js","3000790572835897000":"path---history-19a8fd5d25f630a6d3d7.js","12610637221850356000":"path---graphile-build-pg-security-d9a667e3f23772680caf.js","9347362237655822000":"path---index-68976614b350865386c7.js","8428063392933112000":"path---graphile-build-all-hooks-8cc99d780d7a593a4a8b.js","8772566600393005000":"path---postgraphile-settings-0eafbdeaadcec2d1f765.js","4195836923314832400":"path---graphile-build-build-object-eff863f6654f230ed8ef.js","8250511738979511000":"path---graphile-build-default-plugins-ee5f0fe396ceb8459a1b.js","4555055688090620000":"path---graphile-build-context-object-ab250a4101801fc81c2d.js","7205504750529626000":"path---graphile-build-getting-started-400eabb715fd586acace.js","1062387460204904600":"path---graphile-build-graphile-build-095c33d5ef736a5a7550.js","3771791408109622300":"path---graphile-build-hooks-7fe05959a7cda8f0a0a5.js","7184560962273474000":"path---graphile-build-a8175f8da4353d96750e.js","5002895319514266000":"path---graphile-build-look-ahead-eae8a967be6e7625cf54.js","2390399147881533400":"path---graphile-build-omitting-plugins-caf20fcc93f87017bc2c.js","18106655623105920000":"path---graphile-build-plugin-options-785549757a5ff8948e86.js","8948711028338852000":"path---graphile-build-plugins-f4707615d948d05e75fd.js","18184767599037770000":"path---graphile-build-schema-builder-2436ebebbe5cb64e7722.js","6515005643110327000":"path---postgraphile-computed-columns-90f4570f4e3ff398fb97.js","16069087941836857000":"path---postgraphile-connections-d3feb075260d12482450.js","14828157494412298000":"path---postgraphile-crud-mutations-6c7e0ccde045e7c2b684.js","13726931753980498000":"path---postgraphile-custom-mutations-8376c409442fc815e6f2.js","17185268450471195000":"path---postgraphile-custom-queries-26ada8bc0f94030f0071.js","11994700922543962000":"path---postgraphile-default-role-b3ba3a13d8e57fdf77ba.js","3021897627100894700":"path---postgraphile-evaluating-e7af33ce822b130aecac.js","1943873715935326000":"path---postgraphile-filtering-d8cdf533858d6f1822a1.js","3195847254699379700":"path---postgraphile-fa1849be2bfb658b6547.js","15157997279410745000":"path---postgraphile-introduction-5741cd995bbab10fbbbd.js","2227050697239772200":"path---postgraphile-introspection-691da7e4f148a53fdefd.js","16111252123784985000":"path---postgraphile-performance-96dbede3d43ec9865fea.js","14254897639210230000":"path---postgraphile-jwt-guide-d0170bbbacd9fa08e70b.js","2838144339183239000":"path---postgraphile-postgresql-indexes-e03e34cf6af24c56093a.js","1169112013285621200":"path---postgraphile-postgresql-schema-design-1d5c9bfc68144de802a7.js","16885969067605012000":"path---postgraphile-procedures-82aabd0c9d59677ea69b.js","8958514494574895000":"path---postgraphile-relations-3af5ddddbfaddf6c305f.js","12274565075711388000":"path---postgraphile-requirements-23284ab2f0dffc54aa86.js","9432930456023296000":"path---postgraphile-security-6914d7dd14a4c4dd5ef4.js","214018445676298080":"path---postgraphile-usage-cli-eca7fabfb3650f7e477d.js","9703967671503860000":"path---postgraphile-usage-library-9b38a59a4c7e19d7aa10.js","17830146079722576000":"path---postgraphile-usage-schema-a009f12037354ab21bdb.js","16226825268806257000":"path---postgraphile-usage-2542275161eeedc1f6c5.js","7489246917808536000":"component---src-layouts-index-js-e7d7f19fc35a5d4bedc5.js"}
            //]]>
            </script><title data-react-helmet="true">Graphile | Security</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = location.hash.replace('#', '')
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><script>
  !function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",[
  "/commons-af24df79ddc393e5cf48.js","/app-f5778d46f8140f35433d.js","/path---graphile-build-pg-security-d9a667e3f23772680caf.js","/component---src-templates-page-js-aef27fe6fab65fb206bf.js","/component---src-layouts-index-js-e7d7f19fc35a5d4bedc5.js"
])
  </script><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:125%/1.45em 'Quattrocento Sans','serif';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Quattrocento Sans','serif';font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Work Sans','sans-serif';font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Work Sans','sans-serif';font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Work Sans','sans-serif';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Work Sans','sans-serif';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Work Sans','sans-serif';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:hsla(0,0%,0%,0.9);font-family:'Work Sans','sans-serif';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}ul{margin-left:1.45rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.45rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:0.85rem;line-height:1.45rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}blockquote{margin-left:1.45rem;margin-right:1.45rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.45rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.45rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}li > ul{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.45rem / 2);}code{font-size:0.85rem;line-height:1.45rem;}kbd{font-size:0.85rem;line-height:1.45rem;}samp{font-size:0.85rem;line-height:1.45rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.96667rem;padding-right:0.96667rem;padding-top:0.725rem;padding-bottom:calc(0.725rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{text-shadow:initial;color:initial;background-color:initial;}</style><link href="//fonts.googleapis.com/css?family=Work+Sans:600|Quattrocento+Sans:400,400i,700" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="/styles.css?t=2017-08-16T19-12-04.521Z"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div tabindex="-1" data-reactroot="" data-reactid="1" data-react-checksum="-628251191"><div class="template-page" data-reactid="2"><!-- react-empty: 3 --><header class="content" data-reactid="4"><nav class="navbar" data-reactid="5"><div class="container" data-reactid="6"><input type="checkbox" class="navbar-toggler" id="toggle" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="7"/><div class="nav-controls" data-reactid="8"><div class="navbar-crosses" data-reactid="9"><span class="line line-1" data-reactid="10"> </span><span class="line line-2" data-reactid="11"> </span><span class="line line-3" data-reactid="12"> </span></div><ul class="navbar-nav" data-reactid="13"><li class="navbar-item navbar-item--left" data-reactid="14"><a class="nav-link " href="/" data-reactid="15"><span class="fa fa-home" data-reactid="16"></span><!-- react-text: 17 --> <!-- /react-text --><span class="home" data-reactid="18">Home</span></a></li><li class="navbar-item navbar-item--left" data-reactid="19"><a class="nav-link " href="/postgraphile/" data-reactid="20">PostGraphile</a></li><li class="navbar-item navbar-item--left" data-reactid="21"><a class="nav-link " href="/graphile-build/" data-reactid="22">Graphile Build</a></li><li class="navbar-item ml-auto navbar-item navbar-item--right" data-reactid="23"><span class="searchbox-container" data-reactid="24"><input id="search-box" placeholder="Search" data-reactid="25"/><span class="fa fa-search searchbox-search" data-reactid="26"></span></span></li><li class="navbar-item navbar-item--right" data-reactid="27"><a class="nav-github-link nav-link" href="https://github.com/graphile/graphile-build" data-reactid="28"><span class="fa fa-github" data-reactid="29"></span><!-- react-text: 30 --> <!-- /react-text --><span class="github" data-reactid="31">Github</span></a></li></ul></div></div></nav></header><div class="page-content" data-reactid="32"><section data-reactid="33"><div class="container" data-reactid="34"><div class="row between-xs" data-reactid="35"><aside class="sidebar col-xs-12 col-md-3 last-xs" data-reactid="36"><section data-reactid="37"><h4 class="sidebar-title" data-reactid="38">Usage</h4><ul class="page-list nav flex-column" data-reactid="39"><li class="nav-item" data-reactid="40"><a class="nav-link " href="/postgraphile/settings/" data-reactid="41">Settings</a></li></ul></section></aside><div class="col-xs-12 col-md-9 first-xs main-content" data-reactid="42"><div class="row" data-reactid="43"><div class="col-xs-12" style="width:100%;" data-reactid="44"><h2 id="security"><a href="#security" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security</h2>
<p>Traditionally in web application architectures the security is implemented in
the server layer and the database is treated as a simple store of data - people
tend to figure that this reduces the workload on the database and thus
increases scalability. As their application grows, they start needing other
services to interact with the database too - which can mean that they need to
duplicate the authentication/authorization logic in multiple places which can
lead to discrepancies and increases the surface area for potential issues.</p>
<p>Instead, we advise that you protect your lowest level - the data itself. By
doing so you can be sure that no matter how many services interact with your
database they will all be protected by the same underlying permissions logic
which you only need to maintain in one place.</p>
<p>PostgreSQL already had a powerful permissions system built in with it's roles
and grants; but in PostgreSQL 9.5 Row Level Security policies were introduced.
These allow your application to be considerably more specific about permissions,
moving from table- and column-based permissions to row-level permissions.</p>
<p>When enabled, all rows are by default not visible to any roles (except database
administration roles and the role who created the database/table); and
permission is selectively granted with the use of policies.</p>
<p>If you already have a secure database schema that implements these technologies
to protect your data at the lowest levels then you can leverage
<code>postgraphile</code> to generate a powerful, secure and fast API in minimal
time. All you need to do is pass a pre-authenticated pgClient to the <code>graphql</code>
resolve function.</p>
<h3 id="example"><a href="#example" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example</h3>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createPostGraphQLSchema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postgraphile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pgPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">pg<span class="token punctuation">.</span>Pool</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createPostGraphQLSchema</span><span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'users_schema'</span><span class="token punctuation">,</span> <span class="token string">'posts_schema'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      dynamicJson<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      pgJwtSecret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>JWT_SECRET<span class="token punctuation">,</span>
      pgJwtTypeIdentifier<span class="token punctuation">:</span> <span class="token string">'users_schema.jwt_type'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Fetch a postgres client from the pool</span>
  <span class="token keyword">const</span> pgClient <span class="token operator">=</span> <span class="token keyword">await</span> pgPool<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Start a transaction so we can apply settings local to the transaction</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The following statement is equivalent to (but faster than):</span>
    <span class="token comment" spellcheck="true">//    await pgClient.query("set local role to 'postgraphql_user'");</span>
    <span class="token comment" spellcheck="true">//    await pgClient.query("set local jwt.claims.user_id to '27'");</span>
    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`select
<span class="gatsby-highlight-code-line">      set_config('role', 'postgraphql_user', true),
</span><span class="gatsby-highlight-code-line">      set_config('jwt.claims.user_id', '27', true)
</span>    `</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">graphql</span><span class="token punctuation">(</span>
      schema<span class="token punctuation">,</span>
      query<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">      <span class="token comment" spellcheck="true">/* CONTEXT > */</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        pgClient<span class="token punctuation">:</span> pgClient<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* &lt; CONTEXT */</span>
</span>      variables
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// commit the transaction (or rollback if there was an error) to clear the local settings</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
    <span class="token comment" spellcheck="true">// Release the pgClient back to the pool.</span>
    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">runQuery</span><span class="token punctuation">(</span>
  <span class="token string">"query MyQuery { allPosts { nodes { id, title, author: userByAuthorId { username } } } }"</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>result <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pgPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>TODO: ensure this example works.</p>
<p>To see how this works in a real application, check out
<a href="https://github.com/postgraphql/postgraphql/blob/master/src/postgraphql/withPostGraphQLContext.ts"><code>withPostGraphQLContext</code> in
PostGraphQL</a></p></div><br data-reactid="45"/><br data-reactid="46"/><div class="col-xs-12" data-reactid="47"><div class="row between-xs" data-reactid="48"><div class="col-xs-6" data-reactid="49"></div><div class="col-xs-6 right" data-reactid="50"></div></div></div></div></div></div></div></section></div><footer data-reactid="51"><div class="container" data-reactid="52"><div class="row justify-content-center" data-reactid="53"><div class="col-xs-12 col-md-1-5" data-reactid="54"></div><div class="col-xs-12 col-md-8" data-reactid="55"><div class="container" data-reactid="56"><div class="row" data-reactid="57"><div class="col-xs-12 col-md-4" data-reactid="58"><h6 data-reactid="59">PostGraphile</h6><ul data-reactid="60"><li data-reactid="61"><a href="/postgraphile/" data-reactid="62">About</a></li><li data-reactid="63"><a href="/postgraphile/introduction/" data-reactid="64">Introduction</a></li><li data-reactid="65"><a href="/postgraphile/security/" data-reactid="66">Security</a></li></ul></div><div class="col-xs-12 col-md-4" data-reactid="67"><h6 data-reactid="68">Graphile Build</h6><ul data-reactid="69"><li data-reactid="70"><a href="/graphile-build/" data-reactid="71">About</a></li><li data-reactid="72"><a href="/graphile-build/getting-started/" data-reactid="73">Getting Started</a></li><li data-reactid="74"><a href="/graphile-build/plugins/" data-reactid="75">Plugins</a></li></ul></div><div class="col-xs-12 col-md-4" data-reactid="76"><h6 data-reactid="77">Community</h6><ul data-reactid="78"><li data-reactid="79"><a href="https://github.com/graphile" data-reactid="80">GitHub</a></li><li data-reactid="81"><a href="https://gitter.im/postgraphql/postgraphql" data-reactid="82">Gitter chat</a></li><li data-reactid="83"><a href="https://twitter.com/benjie" data-reactid="84">Twitter</a></li></ul></div></div></div></div></div><div class="row copyright justify-content-center" data-reactid="85"><div class="col-xs-12 col-md-8 center italic" data-reactid="86"><!-- react-text: 87 -->PostGraphile and Graphile Build are Open Source Software, maintained by <!-- /react-text --><a href="https://twitter.com/benjie" data-reactid="88">Benjie Gillam</a><!-- react-text: 89 -->.<!-- /react-text --><br data-reactid="90"/><!-- react-text: 91 -->PostGraphile was <!-- /react-text --><a href="/history/" data-reactid="92">originally authored</a><!-- react-text: 93 --> as PostGraphQL by<!-- /react-text --><!-- react-text: 94 --> <!-- /react-text --><a href="https://twitter.com/calebmer" data-reactid="95">Caleb Meredith</a><!-- react-text: 96 -->.<!-- /react-text --><br data-reactid="97"/><br data-reactid="98"/><!-- react-text: 99 -->This site is copyright © Benjie Gillam 2017.<!-- /react-text --></div></div></div></footer></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script></body></html>