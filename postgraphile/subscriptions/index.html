<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><script src="https://use.fontawesome.com/c72bfae6f9.js"></script><link rel="preload" href="/component---src-layouts-index-js-56ddf70e7703ea1b98d0.js" as="script"/><link rel="preload" href="/component---src-templates-page-js-e8492acfbe7760674006.js" as="script"/><link rel="preload" href="/path---postgraphile-subscriptions-5e1ab8fc966deac3dabe.js" as="script"/><link rel="preload" href="/app-61dca5fde6447231a1a9.js" as="script"/><link rel="preload" href="/commons-8c67ce4654896b174d16.js" as="script"/><title data-react-helmet="true">PostGraphile | GraphQL Subscriptions</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphile, PostGraphQL, Postgres-GraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><link rel="stylesheet" href="/styles.css?t=2018-06-09T15-49-08.166Z"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div tabindex="-1" data-reactroot="" data-reactid="1" data-react-checksum="-204278856"><div class="template-page postgraphile" data-reactid="2"><!-- react-empty: 3 --><header class="header content absolute z-999 w-100" data-reactid="4"><nav class="navbar" data-reactid="5"><div class="container" data-reactid="6"><input type="checkbox" class="navbar-toggler input-reset" id="toggle" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="7"/><div class="nav-controls nested-list-reset " data-reactid="8"><div class="navbar-crosses" data-reactid="9"><span class="line line-1" data-reactid="10"> </span><span class="line line-2" data-reactid="11"> </span><span class="line line-3" data-reactid="12"> </span></div><ul class="navbar-nav flex w-100" data-reactid="13"><li class="navbar-item" data-reactid="14"><a class="nav-link " href="/" data-reactid="15"><span class="home-icon fa fa-home" data-reactid="16"></span><!-- react-text: 17 --> <!-- /react-text --><span class="home" data-reactid="18">Home</span></a></li><!-- react-empty: 19 --><!-- react-empty: 20 --><!-- react-empty: 21 --><li class="navbar-item" data-reactid="22"><a class="nav-link " href="/postgraphile/" data-reactid="23">Overview</a></li><li class="navbar-item" data-reactid="24"><a class="nav-link active" href="/postgraphile/introduction/" data-reactid="25">Documentation</a></li><li class="navbar-item" data-reactid="26"><a class="nav-link " href="/postgraphile/pricing/" data-reactid="27">Go Pro!</a></li><!-- react-empty: 28 --><!-- react-empty: 29 --><!-- react-empty: 30 --><li class="navbar-item ml-auto navbar-item-right" data-reactid="31"><span class="searchbox-container" data-reactid="32"><input id="search-box" placeholder="Search" data-reactid="33"/><span class="fa fa-search searchbox-search" data-reactid="34"></span></span></li><li class="navbar-item navbar-item-right" data-reactid="35"><a class="nav-link " href="/support/" data-reactid="36">Services</a></li><li class="navbar-item navbar-item-right" data-reactid="37"><a class="nav-link" href="https://graphql-training.com" title="GraphQL Training in London, Europe and Remote" data-reactid="38"><!-- react-text: 39 -->GraphQL Training<!-- /react-text --><!-- react-text: 40 --> <!-- /react-text --><span class="fa fa-external-link-square" data-reactid="41"></span></a></li><li class="navbar-item navbar-item-right" data-reactid="42"><a class="nav-link nav-github-link flex items-center" href="https://github.com/graphile" data-reactid="43"><span class="f3 fa fa-github" data-reactid="44"></span><!-- react-text: 45 --> <!-- /react-text --><span class="github" data-reactid="46"><!-- react-text: 47 -->Github <!-- /react-text --><span class="fa fa-external-link-square" data-reactid="48"></span></span></a></li></ul></div></div></nav></header><div class="page-content" data-reactid="49"><section data-reactid="50"><div class="container" data-reactid="51"><div class="row between-xs" data-reactid="52"><aside class="sidebar col-xs-12 col-md-3 last-xs mt3" data-reactid="53"><section data-reactid="54"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="55"><span data-reactid="56">Overview</span></h4><div class="nested-list-reset" data-reactid="57"><ul class="page-list nav flex-column mb5" data-reactid="58"><li class="f6 lh-copy pv1" data-reactid="59"><a class="nav-link " href="/postgraphile/introduction/" data-reactid="60"><span data-reactid="61">Introduction</span></a></li><li class="f6 lh-copy pv1" data-reactid="62"><a class="nav-link " href="/postgraphile/quick-start-guide/" data-reactid="63"><span data-reactid="64">Quick Start Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="65"><a class="nav-link " href="/postgraphile/requirements/" data-reactid="66"><span data-reactid="67">Requirements</span></a></li><li class="f6 lh-copy pv1" data-reactid="68"><a class="nav-link " href="/postgraphile/performance/" data-reactid="69"><span data-reactid="70">Performance</span></a></li><li class="f6 lh-copy pv1" data-reactid="71"><a class="nav-link " href="/postgraphile/connections/" data-reactid="72"><span data-reactid="73">Connections</span></a></li><li class="f6 lh-copy pv1" data-reactid="74"><a class="nav-link " href="/postgraphile/filtering/" data-reactid="75"><span data-reactid="76">Filtering</span></a></li><li class="f6 lh-copy pv1" data-reactid="77"><a class="nav-link " href="/postgraphile/relations/" data-reactid="78"><span data-reactid="79">Relations</span></a></li><li class="f6 lh-copy pv1" data-reactid="80"><a class="nav-link " href="/postgraphile/crud-mutations/" data-reactid="81"><span data-reactid="82">CRUD Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="83"><a class="nav-link " href="/postgraphile/computed-columns/" data-reactid="84"><span data-reactid="85">Computed Columns</span></a></li><li class="f6 lh-copy pv1" data-reactid="86"><a class="nav-link " href="/postgraphile/custom-queries/" data-reactid="87"><span data-reactid="88">Custom Queries</span></a></li><li class="f6 lh-copy pv1" data-reactid="89"><a class="nav-link " href="/postgraphile/custom-mutations/" data-reactid="90"><span data-reactid="91">Custom Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="92"><a class="nav-link " href="/postgraphile/smart-comments/" data-reactid="93"><span data-reactid="94">Smart Comments</span></a></li><li class="f6 lh-copy pv1" data-reactid="95"><a class="nav-link " href="/postgraphile/security/" data-reactid="96"><span data-reactid="97">Security</span></a></li><li class="f6 lh-copy pv1" data-reactid="98"><a class="nav-link " href="/postgraphile/introspection/" data-reactid="99"><span data-reactid="100">Introspection</span></a></li><li class="f6 lh-copy pv1" data-reactid="101"><a class="nav-link " href="/postgraphile/extending/" data-reactid="102"><span data-reactid="103">Extending PostGraphile</span></a></li><li class="f6 lh-copy pv1" data-reactid="104"><a class="nav-link " href="/postgraphile/plugins/" data-reactid="105"><span data-reactid="106">Plugins <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a> <a href='/postgraphile/pricing/' class="plan-pro"><span class='first-letter'>p</span><span class='rest'>ro</span></a></span></a></li><li class="f6 lh-copy pv1" data-reactid="107"><a class="nav-link active" href="/postgraphile/subscriptions/" data-reactid="108"><span data-reactid="109">Subscriptions <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a></span></a></li><li class="f6 lh-copy pv1" data-reactid="110"><a class="nav-link " href="/postgraphile/production/" data-reactid="111"><span data-reactid="112">Running in Production</span></a></li><li class="f6 lh-copy pv1" data-reactid="113"><a class="nav-link " href="/postgraphile/reserved-keywords/" data-reactid="114"><span data-reactid="115">Reserved Keywords</span></a></li></ul></div></section><section data-reactid="116"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="117"><span data-reactid="118">Guides</span></h4><div class="nested-list-reset" data-reactid="119"><ul class="page-list nav flex-column mb5" data-reactid="120"><li class="f6 lh-copy pv1" data-reactid="121"><a class="nav-link " href="/postgraphile/evaluating/" data-reactid="122"><span data-reactid="123">Evaluating for your Project</span></a></li><li class="f6 lh-copy pv1" data-reactid="124"><a class="nav-link " href="/postgraphile/jwt-guide/" data-reactid="125"><span data-reactid="126">PostGraphile JWT Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="127"><a class="nav-link " href="/postgraphile/default-role/" data-reactid="128"><span data-reactid="129">The Default Role</span></a></li><li class="f6 lh-copy pv1" data-reactid="130"><a class="nav-link " href="/postgraphile/procedures/" data-reactid="131"><span data-reactid="132">PostgreSQL Procedures</span></a></li><li class="f6 lh-copy pv1" data-reactid="133"><a class="nav-link " href="/postgraphile/postgresql-schema-design/" data-reactid="134"><span data-reactid="135">PostgreSQL Schema Design</span></a></li><li class="f6 lh-copy pv1" data-reactid="136"><a class="nav-link " href="/postgraphile/postgresql-indexes/" data-reactid="137"><span data-reactid="138">PostgreSQL Indexes</span></a></li><li class="f6 lh-copy pv1" data-reactid="139"><a class="nav-link " href="/postgraphile/v4-new-features/" data-reactid="140"><span data-reactid="141">v4 Feature Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="142"><a class="nav-link " href="/postgraphile/v3-migration/" data-reactid="143"><span data-reactid="144">v3 → v4 Migration Guide</span></a></li></ul></div></section><section data-reactid="145"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="146"><span data-reactid="147">Usage</span></h4><div class="nested-list-reset" data-reactid="148"><ul class="page-list nav flex-column mb5" data-reactid="149"><li class="f6 lh-copy pv1" data-reactid="150"><a class="nav-link " href="/postgraphile/usage-cli/" data-reactid="151"><span data-reactid="152">CLI Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="153"><a class="nav-link " href="/postgraphile/usage-library/" data-reactid="154"><span data-reactid="155">Library Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="156"><a class="nav-link " href="/postgraphile/usage-schema/" data-reactid="157"><span data-reactid="158">Schema-only Usage</span></a></li></ul></div></section></aside><div class="col-xs-12 col-md-7 col-md-offset-1 first-xs main-content" data-reactid="159"><div class="row" data-reactid="160"><div class="col-xs-12" style="width:100%;" data-reactid="161"><h2 id="graphql-subscriptions-supporter"><a href="#graphql-subscriptions-supporter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GraphQL Subscriptions <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a></h2>
<p>Using the <a href="/postgraphile/plugins">Supporter Plugin</a> PostGraphile
gains a simple subscriptions ability.</p>
<p>To enable this, use the <code class="language-text">--simple-subscriptions</code> CLI flag (or
<code class="language-text">simpleSubscriptions: true</code> middleware option).</p>
<p>This will expose a <code class="language-text">listen</code> subscription field that can be used for generic
subscriptions to a named topic which can be triggered using PostgreSQL's built
in LISTEN/NOTIFY functionality.</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">type ListenPayload <span class="token punctuation">{</span>
  <span class="token attr-name">query</span><span class="token punctuation">:</span> Query
  <span class="token attr-name">relatedNode</span><span class="token punctuation">:</span> Node
  <span class="token attr-name">relatedNodeId</span><span class="token punctuation">:</span> ID
<span class="token punctuation">}</span>

type Subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> String<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ListenPayload<span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<h3 id="topic-prefix"><a href="#topic-prefix" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Topic prefix</h3>
<p>All topics are automatically prefixed with <code class="language-text">postgraphile:</code> (but you can
customise this with the <code class="language-text">pgSubscriptionPrefix</code> setting if you're using the
middleware version) - GraphQL consumers will not need to know about this,
but you will need to remember to add it to your <code class="language-text">NOTIFY</code> topic otherwise
subscribers will not see the messages.</p>
<p>For example a user may perform the following subscription:</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relatedNodeId
    relatedNode <span class="token punctuation">{</span>
      nodeId
      <span class="token operator">...</span> <span class="token keyword">on</span> Foo <span class="token punctuation">{</span>
        id
        title
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>To cause the subscription to receive a message, you could run:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  <span class="token string">'{}'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Resulting in this GraphQL payload:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"listen"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"relatedNodeId"</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
      <span class="token property">"relatedNode"</span><span class="token operator">:</span> <span class="token null">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>Which is sufficient to know that the event <em>occurred</em>, but chances are that you
want to know more than this...</p>
<p>It's also possible to send a <code class="language-text">Node</code> along with your GraphQL payload using the
<code class="language-text">__node__</code> field on the <code class="language-text">pg_notify</code> body (which is interpreted as JSON). The
<code class="language-text">__node__</code> field is similar to the <code class="language-text">nodeId</code> (or <code class="language-text">id</code> if you use
<code class="language-text">--classic-ids</code>) field in your GraphQL requests, except it's the raw JSON
before it gets stringified and base64 encoded. (The reason for this is that
Postgres' JSON functions leave some optional spaces in, so when they are base64
encoded the strings do not match.)</p>
<p>Assuming that you have a table of the form
<code class="language-text">foos(id serial primary key, title text, ...)</code> you can add the <code class="language-text">__node__</code> field
as follows and the record with id=32 will be made available as the <code class="language-text">relatedNode</code>
in the GraphQL subscription payload:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span>
    <span class="token string">'__node__'</span><span class="token punctuation">,</span> json_build_array<span class="token punctuation">(</span><span class="token string">'foos'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Resulting in this GraphQL payload:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"listen"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"relatedNodeId"</span><span class="token operator">:</span> <span class="token string">"WyJmb29zIiwzMl0="</span><span class="token punctuation">,</span>
      <span class="token property">"relatedNode"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"nodeId"</span><span class="token operator">:</span> <span class="token string">"WyJmb29zIiwzMl0="</span><span class="token punctuation">,</span>
        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Howdy!"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<blockquote>
<p><strong>NOTE</strong>: This solution is still taking shape, so it's not yet certain how other fields
on the NOTIFY message JSON will be exposed via GraphQL. You are advised to
treat the content of this message JSON as if it's visible to the user, as at
some point it may be.</p>
</blockquote>
<blockquote>
<p><strong>NOTE</strong>: In PostgreSQL the channel is an "identifier" which by default is
limited to 63 characters. Subtracting the <code class="language-text">postgraphile:</code> prefix leaves 50
characters for your topic name.</p>
</blockquote>
<h3 id="subscription-security"><a href="#subscription-security" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscription security</h3>
<p>By default, any user may subscribe to any topic, whether logged in or not, and
they will remain subscribed until they close the connection themselves. This
can cause a number of security issues; so we give you a method to implement
security around subscriptions.</p>
<p>By specifying <code class="language-text">--subscription-authorization-function [fn]</code> on the PostGraphile CLI (or using the
<code class="language-text">subscriptionAuthorizationFunction</code> option) you can have PostGraphile call the
function you specified to ensure that the user is
allowed to subscribe to the relevant topic. The function must accept one text
argument <code class="language-text">topic</code> and must return a string or raise an exception (note: the <code class="language-text">topic</code>
argument WILL be sent including the <code class="language-text">postgraphile:</code> prefix).</p>
<p>The function will probably take the following form:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span>
  app_hidden<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
  <span class="token keyword">IF</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">THEN</span>
    <span class="token keyword">RETURN</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    RAISE EXCEPTION <span class="token string">'Subscription denied'</span>
      <span class="token keyword">USING</span> errcode <span class="token operator">=</span> <span class="token string">'.....'</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql VOLATILE SECURITY <span class="token keyword">DEFINER</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You must define this function with your custom security logic.  To use this
function you'd pass the CLI flag:
<code class="language-text">--subscription-authorization-function app_private.validate_subscription</code></p>
<p>The text value returned is used to tell the system when to cancel the
subscription - if you don't need this functionality then you may return a
<em>static</em> unique value, e.g.  generate a random UUID (manually) and then return
this same UUID over and over from your function, e.g.:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> app_hidden<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
  <span class="token keyword">IF</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">THEN</span>
    <span class="token keyword">RETURN</span> <span class="token string">'4A2D27CD-7E67-4585-9AD8-50AF17D98E0B'</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    RAISE EXCEPTION <span class="token string">'Subscription denied'</span> <span class="token keyword">USING</span> errcode <span class="token operator">=</span> <span class="token string">'.....'</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql VOLATILE SECURITY <span class="token keyword">DEFINER</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>When a message is published to the topic identified by the return value of this
function (NOTE: this topic will NOT be prefixed with <code class="language-text">postgraphile:</code> because it
should be private), the associated subscription will automatically be terminated.</p>
<h3 id="naming-your-topics"><a href="#naming-your-topics" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Naming your topics</h3>
<p>You might want to make the topic a combination of things, for example the
subject type and identifier - e.g. 'channel:123'. If you do this then your
function could determine which subject the user is attempting to subscribe to,
check the user has access to that subject, and finally return a PostgreSQL
topic that will be published to in the event the user is kicked from the
channel, e.g.  <code class="language-text">&#39;channel:123:kick:987&#39;</code> (assuming '987' is the id
of the current user).</p>
<h3 id="example-walk-through"><a href="#example-walk-through" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example walk-through</h3>
<p>First, set up a <code class="language-text">.postgraphilerc.js</code> containing the following:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"@graphile/plugin-supporter"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    connection<span class="token punctuation">:</span> <span class="token string">"postgres://localhost/subs"</span><span class="token punctuation">,</span>
    schema<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"app_public"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Next, in terminal 1, run:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">createdb subs || true
postgraphile</code></pre>
      </div>
<p>In terminal 2, connect to the subs DB using <code class="language-text">psql subs</code> and run the following:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">schema</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_public<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">schema</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_private<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_public<span class="token punctuation">.</span>foo <span class="token punctuation">(</span>
 id <span class="token keyword">serial</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
 title <span class="token keyword">text</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span>
  app_private<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
  <span class="token keyword">returns</span> <span class="token keyword">text</span> <span class="token keyword">as</span>
$$
 <span class="token keyword">select</span> <span class="token string">'CANCEL_ALL_SUBSCRIPTIONS'</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
$$ <span class="token keyword">language</span> <span class="token keyword">sql</span> stable<span class="token punctuation">;</span></code></pre>
      </div>
<p>Then using a GraphQL client that supports subscriptions, such as <a href="https://github.com/graphcool/graphql-playground">GraphQL Playground</a>,
perform the following subscription:</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">subscription <span class="token punctuation">{</span>
 listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span><span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   relatedNodeId
   relatedNode <span class="token punctuation">{</span>
     nodeId
     <span class="token operator">...</span> <span class="token keyword">on</span> Foo <span class="token punctuation">{</span>
       id
       title
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>You are not expecting an immediate result; first you have to trigger the event. To do so, back in your <code class="language-text">psql</code> session in terminal 2, execute:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> app_public<span class="token punctuation">.</span>foo <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Howdy!'</span><span class="token punctuation">)</span> returning <span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span>
    <span class="token string">'__node__'</span><span class="token punctuation">,</span> json_build_array<span class="token punctuation">(</span>
      <span class="token string">'foos'</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> app_public<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You should find that the event has been received by the client and the 'Howdy!'
node has come through. You can run the above a few more times, or experiment a
bit by changing the values if you like.</p>
<p>Finally to cancel the subscription, execute the following SQL:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'CANCEL_ALL_SUBSCRIPTIONS'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span><span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You should notice that your client is no longer subscribed.</p>
<p><strong>Bonus</strong>: the SQL commands in this walk-through can be automated with this handy
bash script:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -e
createdb subs <span class="token operator">||</span> <span class="token boolean">true</span>
psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
create schema if not exists app_public;
create table if not exists app_public.foo (
 id serial primary key,
 title text not null
);
create schema if not exists app_private;
create or replace function app_private.validate_subscription(topic text)
returns text as \$\$
 select 'CANCEL_ALL_SUBSCRIPTIONS'::text;
\$\$ language sql stable;
HERE</span>

<span class="token function">sleep</span> 1

psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
 do \$\$
 declare
   v_foo app_public.foo;
 begin
   insert into app_public.foo (title) values ('Howdy!') returning * into v_foo;
   perform pg_notify(
     'postgraphile:hello',
     json_build_object('__node__', json_build_array('foos', v_foo.id))::text
   );
 end;
 \$\$ language plpgsql;
HERE</span>

<span class="token function">sleep</span> 3

psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
 do \$\$
 declare
   v_foo app_public.foo;
 begin
   insert into app_public.foo (title) values ('Goodbye!') returning * into v_foo;
   perform pg_notify(
     'postgraphile:hello',
     json_build_object('__node__', json_build_array('foos', v_foo.id))::text
   );
   perform pg_notify(
     'CANCEL_ALL_SUBSCRIPTIONS',
     json_build_object()::text
   );
 end;
 \$\$ language plpgsql;
HERE</span></code></pre>
      </div></div><br data-reactid="162"/><br data-reactid="163"/><div class="col-xs-12 mt3 mb5" data-reactid="164"><div class="row between-xs" data-reactid="165"><div class="col-xs-6" data-reactid="166"><a class="" href="/postgraphile/plugins/" data-reactid="167"><span class="fa fa-fw fa-long-arrow-left" data-reactid="168"></span><!-- react-text: 169 --> <!-- /react-text --><!-- react-text: 170 -->Plugins [SUPPORTER] [PRO]<!-- /react-text --></a></div><div class="col-xs-6 tr" data-reactid="171"><a class="" href="/postgraphile/production/" data-reactid="172"><!-- react-text: 173 -->Running in Production<!-- /react-text --><!-- react-text: 174 --> <!-- /react-text --><span class="fa fa-fw fa-long-arrow-right" data-reactid="175"></span></a></div></div></div></div></div></div></div></section></div><footer class="bg-white pv5 bt b--black f6 lh-copy" data-reactid="176"><div class="container" data-reactid="177"><div class="row" data-reactid="178"><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="179"><h6 data-reactid="180">PostGraphile</h6><ul data-reactid="181"><li data-reactid="182"><a href="/postgraphile/introduction/" data-reactid="183">Introduction</a></li><li data-reactid="184"><a href="/postgraphile/security/" data-reactid="185">Security</a></li><li data-reactid="186"><a href="/postgraphile/extending/" data-reactid="187">Extending</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="188"><h6 data-reactid="189">Graphile Build</h6><ul data-reactid="190"><li data-reactid="191"><a href="/graphile-build/" data-reactid="192">About</a></li><li data-reactid="193"><a href="/graphile-build/getting-started/" data-reactid="194">Getting Started</a></li><li data-reactid="195"><a href="/graphile-build/plugins/" data-reactid="196">Plugins</a></li></ul></div><div class="col-xs-12 col-md-4 nested-list-reset" data-reactid="197"><h6 data-reactid="198">Community</h6><ul data-reactid="199"><li data-reactid="200"><a href="https://github.com/graphile" data-reactid="201">GitHub</a></li><li data-reactid="202"><a href="https://gitter.im/graphile/postgraphile" data-reactid="203">Gitter chat</a></li><li data-reactid="204"><a href="https://twitter.com/benjie" data-reactid="205">Twitter</a></li></ul></div><div class="col-xs-12 col-md-4" data-reactid="206"><h6 data-reactid="207">About</h6><!-- react-text: 208 -->PostGraphile and Graphile Build are Open Source Software, maintained by <!-- /react-text --><a href="https://twitter.com/benjie" data-reactid="209">Benjie Gillam</a><!-- react-text: 210 -->.<!-- /react-text --><br data-reactid="211"/><!-- react-text: 212 -->PostGraphile was <!-- /react-text --><a href="/history/" data-reactid="213">originally authored</a><!-- react-text: 214 --> as PostGraphQL by<!-- /react-text --><!-- react-text: 215 --> <!-- /react-text --><a href="https://twitter.com/calebmer" data-reactid="216">Caleb Meredith</a><!-- react-text: 217 -->.<!-- /react-text --><br data-reactid="218"/><br data-reactid="219"/><!-- react-text: 220 -->This site is copyright © Benjie Gillam <!-- /react-text --><!-- react-text: 221 -->2018<!-- /react-text --><!-- react-text: 222 -->. Design and logos copyright © Benjie Gillam and Jof Arnold<!-- /react-text --><!-- react-text: 223 --> <!-- /react-text --><!-- react-text: 224 -->2018<!-- /react-text --><!-- react-text: 225 -->.<!-- /react-text --></div></div></div></footer></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-61dca5fde6447231a1a9.js","266772403791747":"component---src-templates-home-js-5589d857f0b7a4025661.js","59784799166159":"component---src-templates-marketing-js-6a89c0cb7acb3a3a3f95.js","96961042003272":"component---src-templates-page-js-e8492acfbe7760674006.js","60335399758886":"path----557518bd178906f8d58a.js","142629428675168":"path---index-04361dfa1e873f59fc7b.js","141666846945901":"path---support-536ff0b3e08bd80f1310.js","45788430371641":"path---history-7f27c1165e2491ad849e.js","192423053311925":"path---graphile-build-pg-security-89835d75bb5c08145cdd.js","133858743292129":"path---postgraphile-settings-b7697578fb787f019b43.js","128602041518144":"path---graphile-build-all-hooks-efa04a27b5dcef866ec0.js","64023390553510":"path---graphile-build-build-object-ffef44f805cc7cfffad4.js","125892818282768":"path---graphile-build-default-plugins-55d9f082db8f7a3516b7.js","16210746157911":"path---graphile-build-graphile-build-00f6a468e00afa692504.js","109947277077173":"path---graphile-build-getting-started-701742c5a21f87b0c106.js","69504633912515":"path---graphile-build-context-object-6cfabe41a0182688f7c9.js","57552969484094":"path---graphile-build-hooks-247cb76b20a594f717d8.js","109627700230002":"path---graphile-build-2db41d1ba8e5671d3014.js","36474596372704":"path---graphile-build-omitting-plugins-0e2b41c0ce1b776a15e8.js","76338124382236":"path---graphile-build-look-ahead-49694b3458ec4fd30ef7.js","276285638780302":"path---graphile-build-plugin-options-73077d32abcef043e839.js","277477532944301":"path---graphile-build-schema-builder-6c3eaf3677411f18c830.js","136546493962690":"path---graphile-build-plugins-6fbf5a1ebd74205e6fe3.js","99411096849217":"path---postgraphile-computed-columns-ab757b316a0a6ce2f6c7.js","245194823331250":"path---postgraphile-connections-a979f2e253ed66230c52.js","209456356109321":"path---postgraphile-custom-mutations-8f00ecc19734588223d5.js","226259727392765":"path---postgraphile-crud-mutations-ad5b5cc16d94bb55724c.js","262226386268176":"path---postgraphile-custom-queries-da6383486ed3e8ac3c7b.js","183024611244872":"path---postgraphile-default-role-4d3c5ffdadd55e7fa752.js","46110498460401":"path---postgraphile-evaluating-f1d2b31fba0f6a3c3612.js","1465359564156":"path---postgraphile-extending-30d6f8d42b90f53b8689.js","29661158995595":"path---postgraphile-filtering-dbecf09ebf8b3233fa61.js","48764759135427":"path---postgraphile-3bbd0088b625e823ced0.js","33982096820675":"path---postgraphile-introspection-e6df19b971eb6d625370.js","231292683096477":"path---postgraphile-introduction-9c4e41d5dc5408d8db48.js","217512476184238":"path---postgraphile-jwt-guide-04f481a61558ac209ac0.js","245838197689590":"path---postgraphile-performance-d6580bb0e6949b57061d.js","85182451526728":"path---postgraphile-pricing-fb5b71367e166dd79812.js","43306645800525":"path---postgraphile-postgresql-indexes-5120170e321c70651236.js","257659440118484":"path---postgraphile-procedures-a333730a11dfa21189e1.js","34112019379484":"path---postgraphile-plugins-7995a301d27f42d4124c.js","17839233601159":"path---postgraphile-postgresql-schema-design-e294f3bf3b6404854d10.js","20524195157075":"path---postgraphile-quick-start-guide-90d3d383a11075d10c57.js","136696082986067":"path---postgraphile-relations-bf22b8e47aeaf0b02b78.js","163587040327238":"path---postgraphile-production-1c6d13a5de0a5a845aa9.js","187294999324209":"path---postgraphile-requirements-8f76df264b7c2f43e1eb.js","143935096069691":"path---postgraphile-security-9cf08d28a1ac76c5e9f7.js","126695865748518":"path---postgraphile-reserved-keywords-087e7c76c8001c05b281.js","3265662318058":"path---postgraphile-usage-cli-eddfed763a18a47c7c45.js","27297302318019":"path---postgraphile-smart-comments-1d356041bfe1267007cb.js","112985368742066":"path---postgraphile-subscriptions-5e1ab8fc966deac3dabe.js","148070795768796":"path---postgraphile-usage-library-a149bd1e39edac420ce4.js","57656932303775":"path---postgraphile-v-4-new-features-e96f52db15500262b3ba.js","272066437984048":"path---postgraphile-usage-schema-7b881d54220541caa155.js","247601703930759":"path---postgraphile-usage-30c2e741ba5bcc9d9564.js","87638492893048":"path---postgraphile-v-3-migration-fe1dc69499e51b9db1b7.js","114276838955818":"component---src-layouts-index-js-56ddf70e7703ea1b98d0.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-8c67ce4654896b174d16.js","/app-61dca5fde6447231a1a9.js","/path---postgraphile-subscriptions-5e1ab8fc966deac3dabe.js","/component---src-templates-page-js-e8492acfbe7760674006.js","/component---src-layouts-index-js-56ddf70e7703ea1b98d0.js"])/*]]>*/</script><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script></body></html>