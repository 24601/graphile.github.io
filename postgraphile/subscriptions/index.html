<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"/><link rel="preload" href="/component---src-layouts-index-js-ace7914a8fea060c15f6.js" as="script"/><link rel="preload" href="/component---src-templates-page-js-44912100fe5a923703fa.js" as="script"/><link rel="preload" href="/path---postgraphile-subscriptions-802ef5e7c574b56640d8.js" as="script"/><link rel="preload" href="/app-2691d2104d4e5983bce4.js" as="script"/><link rel="preload" href="/commons-e9c5ebe9f9d03df65cb6.js" as="script"/><title data-react-helmet="true">PostGraphile | GraphQL Subscriptions</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphile, PostGraphQL, Postgres-GraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><link rel="stylesheet" href="/styles.css?t=2018-12-12T18-54-43.032Z"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div tabindex="-1" data-reactroot="" data-reactid="1" data-react-checksum="-653604758"><div class="template-page postgraphile" data-reactid="2"><!-- react-empty: 3 --><header class="header content absolute z-999 w-100" data-reactid="4"><nav class="navbar" data-reactid="5"><div class="container" data-reactid="6"><input type="checkbox" class="navbar-toggler input-reset" id="toggle" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="7"/><div class="nav-controls nested-list-reset " data-reactid="8"><div class="navbar-crosses" data-reactid="9"><span class="line line-1" data-reactid="10"> </span><span class="line line-2" data-reactid="11"> </span><span class="line line-3" data-reactid="12"> </span></div><ul class="navbar-nav flex w-100" data-reactid="13"><li class="navbar-item" data-reactid="14"><a class="nav-link " href="/" data-reactid="15"><span class="home-icon fas fa-home" data-reactid="16"></span><!-- react-text: 17 --> <!-- /react-text --><span class="home" data-reactid="18">Home</span></a></li><!-- react-empty: 19 --><!-- react-empty: 20 --><li class="navbar-item" data-reactid="21"><a class="nav-link " href="/postgraphile/" data-reactid="22">Overview</a></li><li class="navbar-item" data-reactid="23"><a class="nav-link active" href="/postgraphile/introduction/" data-reactid="24">Documentation</a></li><li class="navbar-item" data-reactid="25"><a class="nav-link " href="/sponsor/" data-reactid="26">Sponsor</a></li><li class="navbar-item" data-reactid="27"><a class="hide-when-small nav-link " href="/postgraphile/pricing/" data-reactid="28">Go Pro!</a></li><!-- react-empty: 29 --><!-- react-empty: 30 --><!-- react-empty: 31 --><!-- react-empty: 32 --><!-- react-empty: 33 --><li class="navbar-item ml-auto navbar-item-right" data-reactid="34"><span class="searchbox-container" data-reactid="35"><input id="search-box" placeholder="Search" data-reactid="36"/><span class="fas fa-search searchbox-search" data-reactid="37"></span></span></li><li class="navbar-item navbar-item-right" data-reactid="38"><a class="nav-link " href="/support/" data-reactid="39"><span data-reactid="40"><span class="hide-when-small" data-reactid="41">Support and </span><!-- react-text: 42 -->Services<!-- /react-text --></span></a></li><li class="navbar-item navbar-item-right" data-reactid="43"><a class="nav-link nav-github-link flex items-center" href="https://github.com/graphile/postgraphile" data-reactid="44"><span class="f3 fab fa-github" data-reactid="45"></span><!-- react-text: 46 --> <!-- /react-text --><span class="github" data-reactid="47"><!-- react-text: 48 -->Github<!-- /react-text --><!-- react-text: 49 --> <!-- /react-text --><span class="fas fa-external-link-square-alt" data-reactid="50"></span></span></a></li></ul></div></div></nav></header><div class="page-content" data-reactid="51"><section data-reactid="52"><div class="container" data-reactid="53"><div class="row between-xs" data-reactid="54"><aside class="sidebar col-xs-12 col-md-3 last-xs mt3" data-reactid="55"><section data-reactid="56"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="57"><span data-reactid="58">Overview</span></h4><div class="nested-list-reset" data-reactid="59"><ul class="page-list nav flex-column mb5" data-reactid="60"><li class="f6 lh-copy pv1" data-reactid="61"><a class="nav-link " href="/postgraphile/introduction/" data-reactid="62"><span data-reactid="63">Introduction</span></a></li><li class="f6 lh-copy pv1" data-reactid="64"><a class="nav-link " href="/postgraphile/examples/" data-reactid="65"><span data-reactid="66"><strong>Example Gallery</strong></span></a></li><li class="f6 lh-copy pv1" data-reactid="67"><a class="nav-link " href="/postgraphile/usage/" data-reactid="68"><span data-reactid="69">Usage</span></a><ul class="page-list nav flex-column null" data-reactid="70"><li class="f6 lh-copy pv1" data-reactid="71"><a class="nav-link " href="/postgraphile/usage-cli/" data-reactid="72"><span data-reactid="73">CLI Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="74"><a class="nav-link " href="/postgraphile/usage-library/" data-reactid="75"><span data-reactid="76">Library Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="77"><a class="nav-link " href="/postgraphile/usage-schema/" data-reactid="78"><span data-reactid="79">Schema-only Usage</span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="80"><a class="nav-link " href="/postgraphile/performance/" data-reactid="81"><span data-reactid="82">Performance</span></a></li><li class="f6 lh-copy pv1" data-reactid="83"><a class="nav-link " href="/postgraphile/requirements/" data-reactid="84"><span data-reactid="85">Requirements</span></a></li></ul></div></section><section data-reactid="86"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="87"><span data-reactid="88">Operation</span></h4><div class="nested-list-reset" data-reactid="89"><ul class="page-list nav flex-column mb5" data-reactid="90"><li class="f6 lh-copy pv1" data-reactid="91"><a class="nav-link " href="/postgraphile/quick-start-guide/" data-reactid="92"><span data-reactid="93">Quick Start Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="94"><a class="nav-link " href="/postgraphile/namespaces/" data-reactid="95"><span data-reactid="96">Namespaces</span></a></li><li class="f6 lh-copy pv1" data-reactid="97"><a class="nav-link " href="/postgraphile/inflection/" data-reactid="98"><span data-reactid="99">Inflection</span></a></li><li class="f6 lh-copy pv1" data-reactid="100"><a class="nav-link " href="/postgraphile/tables/" data-reactid="101"><span data-reactid="102">Tables</span></a><ul class="page-list nav flex-column null" data-reactid="103"><li class="f6 lh-copy pv1" data-reactid="104"><a class="nav-link " href="/postgraphile/relations/" data-reactid="105"><span data-reactid="106">Relations</span></a></li><li class="f6 lh-copy pv1" data-reactid="107"><a class="nav-link " href="/postgraphile/connections/" data-reactid="108"><span data-reactid="109">Connections</span></a></li><li class="f6 lh-copy pv1" data-reactid="110"><a class="nav-link " href="/postgraphile/filtering/" data-reactid="111"><span data-reactid="112">Filtering</span></a></li><li class="f6 lh-copy pv1" data-reactid="113"><a class="nav-link " href="/postgraphile/crud-mutations/" data-reactid="114"><span data-reactid="115">CRUD Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="116"><a class="nav-link " href="/postgraphile/node-id/" data-reactid="117"><span data-reactid="118">nodeId / id</span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="119"><a class="nav-link " href="/postgraphile/functions/" data-reactid="120"><span data-reactid="121">Functions</span></a><ul class="page-list nav flex-column null" data-reactid="122"><li class="f6 lh-copy pv1" data-reactid="123"><a class="nav-link " href="/postgraphile/computed-columns/" data-reactid="124"><span data-reactid="125">Computed Columns</span></a></li><li class="f6 lh-copy pv1" data-reactid="126"><a class="nav-link " href="/postgraphile/custom-queries/" data-reactid="127"><span data-reactid="128">Custom Queries</span></a></li><li class="f6 lh-copy pv1" data-reactid="129"><a class="nav-link " href="/postgraphile/custom-mutations/" data-reactid="130"><span data-reactid="131">Custom Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="132"><a class="nav-link " href="/postgraphile/function-restrictions/" data-reactid="133"><span data-reactid="134">Function Restrictions</span></a></li><li class="f6 lh-copy pv1" data-reactid="135"><a class="nav-link " href="/postgraphile/function-gallery/" data-reactid="136"><span data-reactid="137"><strong>Function Gallery</strong></span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="138"><a class="nav-link " href="/postgraphile/postgresql-indexes/" data-reactid="139"><span data-reactid="140">PostgreSQL Indexes</span></a></li><li class="f6 lh-copy pv1" data-reactid="141"><a class="nav-link " href="/postgraphile/security/" data-reactid="142"><span data-reactid="143">Security</span></a></li><li class="f6 lh-copy pv1" data-reactid="144"><a class="nav-link active" href="/postgraphile/subscriptions/" data-reactid="145"><span data-reactid="146">Subscriptions</span></a></li><li class="f6 lh-copy pv1" data-reactid="147"><a class="nav-link " href="/postgraphile/reserved-keywords/" data-reactid="148"><span data-reactid="149">Reserved Keywords</span></a></li><li class="f6 lh-copy pv1" data-reactid="150"><a class="nav-link " href="/postgraphile/debugging/" data-reactid="151"><span data-reactid="152">Debugging</span></a></li></ul></div></section><section data-reactid="153"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="154"><span data-reactid="155">Customising</span></h4><div class="nested-list-reset" data-reactid="156"><ul class="page-list nav flex-column mb5" data-reactid="157"><li class="f6 lh-copy pv1" data-reactid="158"><a class="nav-link " href="/postgraphile/smart-comments/" data-reactid="159"><span data-reactid="160">Smart Comments</span></a></li><li class="f6 lh-copy pv1" data-reactid="161"><a class="nav-link " href="/postgraphile/extending/" data-reactid="162"><span data-reactid="163">Schema Plugins</span></a><ul class="page-list nav flex-column null" data-reactid="164"><li class="f6 lh-copy pv1" data-reactid="165"><a class="nav-link " href="/postgraphile/make-add-inflectors-plugin/" data-reactid="166"><span data-reactid="167">makeAddInflectorsPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="168"><a class="nav-link " href="/postgraphile/make-change-nullability-plugin/" data-reactid="169"><span data-reactid="170">makeChangeNullabilityPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="171"><a class="nav-link " href="/postgraphile/make-extend-schema-plugin/" data-reactid="172"><span data-reactid="173">makeExtendSchemaPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="174"><a class="nav-link " href="/postgraphile/make-process-schema-plugin/" data-reactid="175"><span data-reactid="176">makeProcessSchemaPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="177"><a class="nav-link " href="/postgraphile/make-wrap-resolvers-plugin/" data-reactid="178"><span data-reactid="179">makeWrapResolversPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="180"><a class="nav-link " href="/postgraphile/make-plugin-by-combining-plugins/" data-reactid="181"><span data-reactid="182">makePluginByCombiningPlugins</span></a></li><li class="f6 lh-copy pv1" data-reactid="183"><a class="nav-link " href="/postgraphile/extending-raw/" data-reactid="184"><span data-reactid="185">Graphile Engine</span></a></li><li class="f6 lh-copy pv1" data-reactid="186"><a class="nav-link " href="/postgraphile/plugin-gallery/" data-reactid="187"><span data-reactid="188"><strong>Plugin Gallery</strong></span></a></li><li class="f6 lh-copy pv1" data-reactid="189"><a class="nav-link " href="/postgraphile/community-plugins/" data-reactid="190"><span data-reactid="191">Community Plugins</span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="192"><a class="nav-link " href="/postgraphile/plugins/" data-reactid="193"><span data-reactid="194">Server Plugins</span></a></li></ul></div></section><section data-reactid="195"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="196"><span data-reactid="197">Guides</span></h4><div class="nested-list-reset" data-reactid="198"><ul class="page-list nav flex-column mb5" data-reactid="199"><li class="f6 lh-copy pv1" data-reactid="200"><a class="nav-link " href="/postgraphile/evaluating/" data-reactid="201"><span data-reactid="202">Evaluating for your Project</span></a></li><li class="f6 lh-copy pv1" data-reactid="203"><a class="nav-link " href="/postgraphile/postgresql-schema-design/" data-reactid="204"><span data-reactid="205">PostgreSQL Schema Design</span></a></li><li class="f6 lh-copy pv1" data-reactid="206"><a class="nav-link " href="/postgraphile/production/" data-reactid="207"><span data-reactid="208">Production Considerations</span></a></li><li class="f6 lh-copy pv1" data-reactid="209"><a class="nav-link " href="/postgraphile/jwt-guide/" data-reactid="210"><span data-reactid="211">PostGraphile JWT Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="212"><a class="nav-link " href="/postgraphile/jwk-verification/" data-reactid="213"><span data-reactid="214">JWK Verification (e.g. Auth0)</span></a></li><li class="f6 lh-copy pv1" data-reactid="215"><a class="nav-link " href="/postgraphile/default-role/" data-reactid="216"><span data-reactid="217">The Default Role</span></a></li><li class="f6 lh-copy pv1" data-reactid="218"><a class="nav-link " href="/postgraphile/v4-new-features/" data-reactid="219"><span data-reactid="220">v4 Feature Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="221"><a class="nav-link " href="/postgraphile/v3-migration/" data-reactid="222"><span data-reactid="223">v3 → v4 Migration Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="224"><a class="nav-link " href="/postgraphile/testing-jest/" data-reactid="225"><span data-reactid="226">Testing with Jest</span></a></li></ul></div></section><section data-reactid="227"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="228"><span data-reactid="229">Community</span></h4><div class="nested-list-reset" data-reactid="230"><ul class="page-list nav flex-column mb5" data-reactid="231"><li class="f6 lh-copy pv1" data-reactid="232"><a class="nav-link " href="/postgraphile/community-contributions/" data-reactid="233"><span data-reactid="234">Community Contributions</span></a></li><li class="f6 lh-copy pv1" data-reactid="235"><a class="nav-link " href="/postgraphile/community-chat/" data-reactid="236"><span data-reactid="237">Community Chat</span></a></li><li class="f6 lh-copy pv1" data-reactid="238"><a class="nav-link " href="/postgraphile/code-of-conduct/" data-reactid="239"><span data-reactid="240">Code of Conduct</span></a></li></ul></div></section><section data-reactid="241"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="242"><span data-reactid="243">FAQ</span></h4><div class="nested-list-reset" data-reactid="244"><ul class="page-list nav flex-column mb5" data-reactid="245"><li class="f6 lh-copy pv1" data-reactid="246"><a class="nav-link " href="/postgraphile/introspection/" data-reactid="247"><span data-reactid="248">Introspection?</span></a></li><li class="f6 lh-copy pv1" data-reactid="249"><a class="nav-link " href="/postgraphile/why-nullable/" data-reactid="250"><span data-reactid="251">Why is it nullable?</span></a></li><li class="f6 lh-copy pv1" data-reactid="252"><a class="nav-link " href="/postgraphile/versioning-policy/" data-reactid="253"><span data-reactid="254">Versioning policy?</span></a></li></ul></div></section></aside><div class="col-xs-12 col-md-9 first-xs main-content" data-reactid="255"><div class="row" data-reactid="256"><div class="col-xs-12" style="width:100%;" data-reactid="257"><div class="edit-this-page" style="display:;" data-reactid="258"><a href="https://github.com/graphile/graphile.github.io/edit/develop/src/pages/postgraphile/subscriptions.md" data-reactid="259">📝 Suggest improvements to this page</a></div><div data-reactid="260"><h2 id="graphql-subscriptions"><a href="#graphql-subscriptions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GraphQL Subscriptions</h2>
<p>PostGraphile Core doesn't yet have subscriptions support built in. There is
much talk about what a GraphQL subscriptions solution might look like in
<a href="https://github.com/graphile/postgraphile/issues/92">issue #92</a>.</p>
<p>Patreon backers (and those who have purchased the Pro plugin) may try out an
early simple subscriptions feature via the <a href="/postgraphile/plugins/">Supporter
Plugin</a>. We'd love to hear your feedback on this
implementation. The rest of this article details how to use this feature.</p>
<h2 id="custom-subscriptions-supporter"><a href="#custom-subscriptions-supporter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Subscriptions <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a></h2>
<p><em>(Requires <code class="language-text">@graphile/supporter</code> 0.7.3 or later.)</em></p>
<p>In this implementation, you use PostGraphile's extensibility to define the
exact subscriptions you need. We advise creating an extension using <a href="/postgraphile/make-extend-schema-plugin/">the
<code class="language-text">makeExtendSchemaPlugin</code> helper</a>.</p>
<h3 id="writing-the-plugin"><a href="#writing-the-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing the plugin</h3>
<p>Using <code class="language-text">makeExtendSchemaPlugin</code> we can define a new subscription field and the
subscription payload type that it returns. Using the <code class="language-text">@pgSubscription(topic: ...)</code>
directive, we can embed a function that will calculate the PostgreSQL
topic to subscribe to based on the arguments and context passed to the
GraphQL field (in this case factoring in the user ID).</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token comment">// MySubscriptionPlugin.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">currentUserTopicFromContext</span> <span class="token operator">=</span> <span class="token punctuation">(</span>_args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> _resolveInfo<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>jwtClaims<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`graphql:user:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span>jwtClaims<span class="token punctuation">.</span>user_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"You're not logged in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">makeExtendSchemaPlugin</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pgSql<span class="token punctuation">:</span> sql <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  typeDefs<span class="token punctuation">:</span> gql<span class="token template-string"><span class="token string">`
    type UserSubscriptionPayload {
      # This is populated by our resolver below
      user: User

      # This is returned directly from the PostgreSQL subscription payload (JSON object)
      event: String
    }

    extend type Subscription {
      """
      Triggered when the current user's data changes:

      - direct modifications to the user
      - when their organization membership changes
      """
      currentUserUpdated: UserSubscriptionPayload @pgSubscription(topic: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">embed</span><span class="token punctuation">(</span>
        currentUserTopicFromContext
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
    }
  `</span></span><span class="token punctuation">,</span>

  resolvers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    UserSubscriptionPayload<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// This method finds the user from the database based on the event</span>
      <span class="token comment">// published by PostgreSQL.</span>
      <span class="token comment">//</span>
      <span class="token comment">// In a future release, we hope to enable you to replace this entire</span>
      <span class="token comment">// method with a small schema directive above, should you so desire. It's</span>
      <span class="token comment">// mostly boilerplate.</span>
      <span class="token keyword">async</span> <span class="token function">user</span><span class="token punctuation">(</span>
        event<span class="token punctuation">,</span>
        _args<span class="token punctuation">,</span>
        _context<span class="token punctuation">,</span>
        <span class="token punctuation">{</span> graphile<span class="token punctuation">:</span> <span class="token punctuation">{</span> selectGraphQLResultFromTable <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">selectGraphQLResultFromTable</span><span class="token punctuation">(</span>
          sql<span class="token punctuation">.</span>fragment<span class="token template-string"><span class="token string">`app_public.users`</span></span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>tableAlias<span class="token punctuation">,</span> sqlBuilder<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            sqlBuilder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>
              sql<span class="token punctuation">.</span>fragment<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sqlBuilder<span class="token punctuation">.</span><span class="token function">getTableAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sql<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>
                event<span class="token punctuation">.</span>subject
              <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<details>
<summary>
I'm using a fairly complex PostgreSQL function so that I can just use `CREATE TRIGGER` to trigger events in future without having to define a function for
each trigger. Click this paragraph to expand and see the function.
</summary>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">function</span> app_public<span class="token punctuation">.</span>graphql_subscription<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">trigger</span> <span class="token keyword">as</span> $$
<span class="token keyword">declare</span>
  v_process_new <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token punctuation">(</span>TG_OP <span class="token operator">=</span> <span class="token string">'INSERT'</span> <span class="token operator">OR</span> TG_OP <span class="token operator">=</span> <span class="token string">'UPDATE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v_process_old <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token punctuation">(</span>TG_OP <span class="token operator">=</span> <span class="token string">'UPDATE'</span> <span class="token operator">OR</span> TG_OP <span class="token operator">=</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v_event <span class="token keyword">text</span> <span class="token operator">=</span> TG_ARGV<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  v_topic_template <span class="token keyword">text</span> <span class="token operator">=</span> TG_ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  v_attribute <span class="token keyword">text</span> <span class="token operator">=</span> TG_ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  v_record record<span class="token punctuation">;</span>
  v_sub <span class="token keyword">text</span><span class="token punctuation">;</span>
  v_topic <span class="token keyword">text</span><span class="token punctuation">;</span>
  v_i <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v_last_topic <span class="token keyword">text</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token keyword">for</span> v_i <span class="token operator">in</span> <span class="token number">0.</span><span class="token number">.1</span> <span class="token keyword">loop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v_i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">and</span> v_process_new <span class="token operator">is</span> <span class="token boolean">true</span> <span class="token keyword">then</span>
      v_record <span class="token operator">=</span> new<span class="token punctuation">;</span>
    elsif <span class="token punctuation">(</span>v_i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">and</span> v_process_old <span class="token operator">is</span> <span class="token boolean">true</span> <span class="token keyword">then</span>
      v_record <span class="token operator">=</span> old<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> v_attribute <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span>
      <span class="token keyword">execute</span> <span class="token string">'select $1.'</span> <span class="token operator">||</span> quote_ident<span class="token punctuation">(</span>v_attribute<span class="token punctuation">)</span>
        <span class="token keyword">using</span> v_record
        <span class="token keyword">into</span> v_sub<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> v_sub <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span>
      v_topic <span class="token operator">=</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>v_topic_template<span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">,</span> v_sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      v_topic <span class="token operator">=</span> v_topic_template<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> v_topic <span class="token operator">is</span> <span class="token keyword">distinct</span> <span class="token keyword">from</span> v_last_topic <span class="token keyword">then</span>
      <span class="token comment">-- This if statement prevents us from triggering the same notification twice</span>
      v_last_topic <span class="token operator">=</span> v_topic<span class="token punctuation">;</span>
      perform pg_notify<span class="token punctuation">(</span>v_topic<span class="token punctuation">,</span> json_build_object<span class="token punctuation">(</span>
        <span class="token string">'event'</span><span class="token punctuation">,</span> v_event<span class="token punctuation">,</span>
        <span class="token string">'subject'</span><span class="token punctuation">,</span> v_sub
      <span class="token punctuation">)</span>::<span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v_record<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$ <span class="token keyword">language</span> plpgsql volatile <span class="token keyword">set</span> search_path <span class="token keyword">from</span> <span class="token keyword">current</span><span class="token punctuation">;</span></code></pre>
      </div>
</details>
<p>Hooking the database up to a GraphQL subscription is now just the case of <code class="language-text">CREATE TRIGGER</code>:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> _500_gql_update
  <span class="token keyword">AFTER</span> <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> app_public<span class="token punctuation">.</span>users
  <span class="token keyword">FOR EACH ROW</span>
  <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> app_public<span class="token punctuation">.</span>graphql_subscription<span class="token punctuation">(</span>
    <span class="token string">'userChanged'</span><span class="token punctuation">,</span> <span class="token comment">-- the "event" string, useful for the client to know what happened</span>
    <span class="token string">'graphql:user:$1'</span><span class="token punctuation">,</span> <span class="token comment">-- the "topic" the event will be published to, as a template</span>
    <span class="token string">'id'</span> <span class="token comment">-- If specified, `$1` above will be replaced with NEW.id or OLD.id from the trigger.</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> _500_gql_update_member
  <span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span> <span class="token operator">OR</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> app_public<span class="token punctuation">.</span>organization_members
  <span class="token keyword">FOR EACH ROW</span>
  <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> app_public<span class="token punctuation">.</span>graphql_subscription<span class="token punctuation">(</span><span class="token string">'organizationsChanged'</span><span class="token punctuation">,</span> <span class="token string">'graphql:user:$1'</span><span class="token punctuation">,</span> <span class="token string">'member_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<h3 id="enabling-with-the-cli"><a href="#enabling-with-the-cli" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabling with the CLI</h3>
<p>Load the supporter server plugin and our custom subscription schema plugin.</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">postgraphile \
  --plugins @graphile/supporter \
  --append-plugins `pwd`/MySubscriptionPlugin.js \
  -c postgres:///mydb</code></pre>
      </div>
<h2 id="simple-subscriptions-supporter"><a href="#simple-subscriptions-supporter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simple Subscriptions <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a></h2>
<p>In this implementation, we expose a generic <code class="language-text">listen</code> handler that can be used
with arbitrary topics in PostgreSQL - it requires very little ahead-of-time
planning.</p>
<h3 id="enabling-with-the-cli-1"><a href="#enabling-with-the-cli-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabling with the CLI</h3>
<p>To enable Simple Subscriptions via the CLI, just load the supporter plugin
and pass the <code class="language-text">--simple-subscriptions</code> flag.</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">postgraphile \
  --plugins @graphile/supporter \
  --simple-subscriptions \
  -c postgres:///mydb</code></pre>
      </div>
<h3 id="enabling-with-an-express-app"><a href="#enabling-with-an-express-app" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabling with an Express app</h3>
<p>When using PostGraphile as a library, you may enable Simple Subscriptions by
passing the <code class="language-text">pluginHook</code> with the supporter plugin and using
<code class="language-text">simpleSubscriptions: true</code>.</p>
<p>We emulate part of the Express stack, so if you require sessions you can pass
additional Connect/Express middlewares (sorry, we don't support Koa middlewares
here at this time) via the <code class="language-text">websocketMiddlewares</code> option.</p>
<p>Here's an example:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> postgraphile<span class="token punctuation">,</span> makePluginHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"postgraphile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> GraphileSupporter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@graphile/supporter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pluginHook <span class="token operator">=</span> <span class="token function">makePluginHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span>GraphileSupporter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postgraphileOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  pluginHook<span class="token punctuation">,</span>
  simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  websocketMiddlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// Add whatever middlewares you need here, note that they should only</span>
    <span class="token comment">// manipulate properties on req/res, they must not sent response data. e.g.:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   require('express-session')(),</span>
    <span class="token comment">//   require('passport').initialize(),</span>
    <span class="token comment">//   require('passport').session(),</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">postgraphile</span><span class="token punctuation">(</span>databaseUrl<span class="token punctuation">,</span> <span class="token string">"app_public"</span><span class="token punctuation">,</span> postgraphileOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<h3 id="using"><a href="#using" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using</h3>
<p>Simple subscriptions exposes a <code class="language-text">listen</code> field to the <code class="language-text">Subscription</code> type that
can be used for generic subscriptions to a named topic. This topic can be
triggered using PostgreSQL's built in LISTEN/NOTIFY functionality (but
remember to add the prefix - see below).</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">type ListenPayload <span class="token punctuation">{</span>
  <span class="token attr-name">query</span><span class="token punctuation">:</span> Query
  <span class="token attr-name">relatedNode</span><span class="token punctuation">:</span> Node
  <span class="token attr-name">relatedNodeId</span><span class="token punctuation">:</span> ID
<span class="token punctuation">}</span>

type Subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> String<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ListenPayload<span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>Please note that PostGraphile's bundled copy of GraphiQL does not support
subscriptions at this time - you must use an alternative client such as
Altair or GraphQL Playground.</p>
<h3 id="topic-prefix"><a href="#topic-prefix" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Topic prefix</h3>
<p>All topics requested from GraphQL are automatically prefixed with
<code class="language-text">postgraphile:</code>* to avoid leaking other topics your application may be using</p>
<ul>
<li>GraphQL consumers will not need to know about this, but you will need to
remember to add it to the topic when you perform <code class="language-text">NOTIFY</code> otherwise
subscribers will not see the messages.</li>
</ul>
<p>* <em>Customisable via <code class="language-text">pgSubscriptionPrefix</code> setting.</em></p>
<p>For example a user may perform the following subscription:</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relatedNodeId
    relatedNode <span class="token punctuation">{</span>
      nodeId
      <span class="token operator">...</span> <span class="token keyword">on</span> Foo <span class="token punctuation">{</span>
        id
        title
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>To cause the subscription to receive a message, you could run the following
in PostgreSQL:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  <span class="token string">'{}'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Resulting in this GraphQL payload:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"listen"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"relatedNodeId"</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
      <span class="token property">"relatedNode"</span><span class="token operator">:</span> <span class="token null">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>Which is sufficient to know that the event <em>occurred</em>. Chances are that you
want to know more than this...</p>
<p>It's also possible to send a <code class="language-text">Node</code> along with your GraphQL payload using the
<code class="language-text">__node__</code> field on the <code class="language-text">pg_notify</code> body (which is interpreted as JSON). The
<code class="language-text">__node__</code> field is similar to the <code class="language-text">nodeId</code> (or <code class="language-text">id</code> if you use
<code class="language-text">--classic-ids</code>) field in your GraphQL requests, except it's the raw JSON
before it gets stringified and base64 encoded. (The reason for this is that
Postgres' JSON functions leave some optional spaces in, so when they are base64
encoded the strings do not match.)</p>
<p>Assuming that you have a table of the form
<code class="language-text">foos(id serial primary key, title text, ...)</code> you can add the <code class="language-text">__node__</code> field
as follows and the record with id=32 will be made available as the <code class="language-text">relatedNode</code>
in the GraphQL subscription payload:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span>
    <span class="token string">'__node__'</span><span class="token punctuation">,</span> json_build_array<span class="token punctuation">(</span><span class="token string">'foos'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Resulting in this GraphQL payload:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"listen"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"relatedNodeId"</span><span class="token operator">:</span> <span class="token string">"WyJmb29zIiwzMl0="</span><span class="token punctuation">,</span>
      <span class="token property">"relatedNode"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"nodeId"</span><span class="token operator">:</span> <span class="token string">"WyJmb29zIiwzMl0="</span><span class="token punctuation">,</span>
        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Howdy!"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<blockquote>
<p><strong>NOTE</strong>: This solution is still taking shape, so it's not yet certain how other fields
on the NOTIFY message JSON will be exposed via GraphQL. You are advised to
treat the content of this message JSON as if it's visible to the user, as at
some point it may be.</p>
</blockquote>
<blockquote>
<p><strong>NOTE</strong>: In PostgreSQL the channel is an "identifier" which by default is
limited to 63 characters. Subtracting the <code class="language-text">postgraphile:</code> prefix leaves 50
characters for your topic name.</p>
</blockquote>
<h3 id="subscription-security"><a href="#subscription-security" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscription security</h3>
<p>By default, any user may subscribe to any topic, whether logged in or not, and
they will remain subscribed until they close the connection themselves. This
can cause a number of security issues; so we give you a method to implement
security around subscriptions.</p>
<p>By specifying <code class="language-text">--subscription-authorization-function [fn]</code> on the PostGraphile CLI (or using the
<code class="language-text">subscriptionAuthorizationFunction</code> option) you can have PostGraphile call the
function you specified to ensure that the user is
allowed to subscribe to the relevant topic. The function must accept one text
argument <code class="language-text">topic</code> and must return a string or raise an exception (note: the <code class="language-text">topic</code>
argument WILL be sent including the <code class="language-text">postgraphile:</code> prefix).</p>
<p>A typical implementation will look like this:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span>
  app_hidden<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
  <span class="token keyword">IF</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">THEN</span>
    <span class="token keyword">RETURN</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    RAISE EXCEPTION <span class="token string">'Subscription denied'</span>
      <span class="token keyword">USING</span> errcode <span class="token operator">=</span> <span class="token string">'.....'</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql VOLATILE SECURITY <span class="token keyword">DEFINER</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You must define this function with your custom security logic. To use this
function you'd pass the CLI flag:
<code class="language-text">--subscription-authorization-function app_private.validate_subscription</code></p>
<p>The text value returned is used to tell the system when to cancel the
subscription - if you don't need this functionality then you may return a
<em>static</em> unique value, e.g. generate a random UUID (manually) and then return
this same UUID over and over from your function, e.g.:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> app_hidden<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
  <span class="token keyword">IF</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">THEN</span>
    <span class="token keyword">RETURN</span> <span class="token string">'4A2D27CD-7E67-4585-9AD8-50AF17D98E0B'</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    RAISE EXCEPTION <span class="token string">'Subscription denied'</span> <span class="token keyword">USING</span> errcode <span class="token operator">=</span> <span class="token string">'.....'</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql VOLATILE SECURITY <span class="token keyword">DEFINER</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>When a message is published to the topic identified by the return value of this
function (NOTE: this topic will NOT be prefixed with <code class="language-text">postgraphile:</code> because it
should be private), the associated subscription will automatically be terminated.</p>
<h3 id="naming-your-topics"><a href="#naming-your-topics" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Naming your topics</h3>
<p>You might want to make the topic a combination of things, for example the
subject type and identifier - e.g. 'channel:123'. If you do this then your
function could determine which subject the user is attempting to subscribe to,
check the user has access to that subject, and finally return a PostgreSQL
topic that will be published to in the event the user is kicked from the
channel, e.g. <code class="language-text">&#39;channel:123:kick:987&#39;</code> (assuming '987' is the id
of the current user).</p>
<h3 id="example-walk-through"><a href="#example-walk-through" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example walk-through</h3>
<p>First, set up a <code class="language-text">.postgraphilerc.js</code> containing the following:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"@graphile/supporter"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    connection<span class="token punctuation">:</span> <span class="token string">"postgres:///subs"</span><span class="token punctuation">,</span>
    schema<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"app_public"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Next, in terminal 1, run:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">createdb subs || true
postgraphile</code></pre>
      </div>
<p>In terminal 2, connect to the subs DB using <code class="language-text">psql subs</code> and run the following:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">schema</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_public<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">schema</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_private<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_public<span class="token punctuation">.</span>foo <span class="token punctuation">(</span>
 id <span class="token keyword">serial</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
 title <span class="token keyword">text</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span>
  app_private<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
  <span class="token keyword">returns</span> <span class="token keyword">text</span> <span class="token keyword">as</span>
$$
 <span class="token keyword">select</span> <span class="token string">'CANCEL_ALL_SUBSCRIPTIONS'</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
$$ <span class="token keyword">language</span> <span class="token keyword">sql</span> stable<span class="token punctuation">;</span></code></pre>
      </div>
<p>Then using a GraphQL client that supports subscriptions, such as <a href="https://github.com/graphcool/graphql-playground">GraphQL Playground</a>,
perform the following subscription:</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relatedNodeId
    relatedNode <span class="token punctuation">{</span>
      nodeId
      <span class="token operator">...</span> <span class="token keyword">on</span> Foo <span class="token punctuation">{</span>
        id
        title
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>You are not expecting an immediate result; first you have to trigger the event. To do so, back in your <code class="language-text">psql</code> session in terminal 2, execute:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> app_public<span class="token punctuation">.</span>foo <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Howdy!'</span><span class="token punctuation">)</span> returning <span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span>
    <span class="token string">'__node__'</span><span class="token punctuation">,</span> json_build_array<span class="token punctuation">(</span>
      <span class="token string">'foos'</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> app_public<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You should find that the event has been received by the client and the 'Howdy!'
node has come through. You can run the above a few more times, or experiment a
bit by changing the values if you like.</p>
<p>Finally to cancel the subscription, execute the following SQL:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'CANCEL_ALL_SUBSCRIPTIONS'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span><span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You should notice that your client is no longer subscribed.</p>
<p><strong>Bonus</strong>: the SQL commands in this walk-through can be automated with this handy
bash script:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -e
createdb subs <span class="token operator">||</span> <span class="token boolean">true</span>
psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
create schema if not exists app_public;
create table if not exists app_public.foo (
 id serial primary key,
 title text not null
);
create schema if not exists app_private;
create or replace function app_private.validate_subscription(topic text)
returns text as \$\$
 select 'CANCEL_ALL_SUBSCRIPTIONS'::text;
\$\$ language sql stable;
HERE</span>

<span class="token function">sleep</span> 1

psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
 do \$\$
 declare
   v_foo app_public.foo;
 begin
   insert into app_public.foo (title) values ('Howdy!') returning * into v_foo;
   perform pg_notify(
     'postgraphile:hello',
     json_build_object('__node__', json_build_array('foos', v_foo.id))::text
   );
 end;
 \$\$ language plpgsql;
HERE</span>

<span class="token function">sleep</span> 3

psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
 do \$\$
 declare
   v_foo app_public.foo;
 begin
   insert into app_public.foo (title) values ('Goodbye!') returning * into v_foo;
   perform pg_notify(
     'postgraphile:hello',
     json_build_object('__node__', json_build_array('foos', v_foo.id))::text
   );
   perform pg_notify(
     'CANCEL_ALL_SUBSCRIPTIONS',
     json_build_object()::text
   );
 end;
 \$\$ language plpgsql;
HERE</span></code></pre>
      </div>
<h4 id="advanced-setup"><a href="#advanced-setup" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Advanced setup</h4>
<p>If you need websockets to be listened for before your first HTTP request comes
in (most people don't need this) then you must create a <code class="language-text">rawHTTPServer</code>, mount
your express <code class="language-text">app</code> in it, and then add subscription support to the raw server
via the <code class="language-text">enhanceHttpServerWithSubscriptions</code> function, as shown below:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> postgraphile<span class="token punctuation">,</span> makePluginHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"postgraphile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> GraphileSupporter<span class="token punctuation">,</span>
  enhanceHttpServerWithSubscriptions<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@graphile/supporter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pluginHook <span class="token operator">=</span> <span class="token function">makePluginHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span>GraphileSupporter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rawHTTPServer <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postgraphileOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  pluginHook<span class="token punctuation">,</span>
  simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  websocketMiddlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// Add whatever middlewares you need here, note that</span>
    <span class="token comment">// they should only manipulate properties on req/res,</span>
    <span class="token comment">// they must not sent response data. e.g.:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   require('express-session')(),</span>
    <span class="token comment">//   require('passport').initialize(),</span>
    <span class="token comment">//   require('passport').session(),</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postgraphileMiddleware <span class="token operator">=</span> <span class="token function">postgraphile</span><span class="token punctuation">(</span>
  databaseUrl<span class="token punctuation">,</span>
  <span class="token string">"app_public"</span><span class="token punctuation">,</span>
  postgraphileOptions
<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>postgraphileMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">enhanceHttpServerWithSubscriptions</span><span class="token punctuation">(</span>
  rawHTTPServer<span class="token punctuation">,</span>
  postgraphileMiddleware<span class="token punctuation">,</span>
  postgraphileOptions
<span class="token punctuation">)</span><span class="token punctuation">;</span>

rawHTTPServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>The <code class="language-text">enhanceHttpServerWithSubscriptions</code> takes three arguments:</p>
<ol>
<li>the raw HTTP server from <code class="language-text">require(&#39;http&#39;).createServer()</code></li>
<li>the postgraphile middleware (this should be the <em>same</em> middleware that you mount into your Express app)</li>
<li>options, where you can optionally pass <code class="language-text">middlewares</code> to enable <code class="language-text">pgSettings(req) {...}</code> access to session-based things</li>
</ol></div></div><br data-reactid="261"/><br data-reactid="262"/><div class="col-xs-12 mt3 mb5" data-reactid="263"><div class="row between-xs" data-reactid="264"><div class="col-xs-6" data-reactid="265"><a class="" href="/postgraphile/security/" data-reactid="266"><span class="fas fa-fw fa-arrow-left" data-reactid="267"></span><!-- react-text: 268 --> <!-- /react-text --><span data-reactid="269">Security</span></a></div><div class="col-xs-6 tr" data-reactid="270"><a class="" href="/postgraphile/reserved-keywords/" data-reactid="271"><span data-reactid="272">Reserved Keywords</span><!-- react-text: 273 --> <!-- /react-text --><span class="fas fa-fw fa-arrow-right" data-reactid="274"></span></a></div></div></div></div></div></div></div></section><section class="mailinglist" data-reactid="275"><div class="container" data-reactid="276"><div class="row" data-reactid="277"><div class="col-xs-12" data-reactid="278"><div class="hero-block" data-reactid="279"><h3 data-reactid="280"><!-- react-text: 281 -->Questions, comments or feedback?<!-- /react-text --><br data-reactid="282"/><!-- react-text: 283 -->Email<!-- /react-text --><!-- react-text: 284 --> <!-- /react-text --><a href="mailto:info@graphile.org?subject=Documentation%20question/comment/feedback:)" data-reactid="285">info@graphile.org</a></h3><form action="//graphile.us16.list-manage.com/subscribe/post?u=d103f710cf00a9273b55e8e9b&amp;id=c3a9eb5c4e" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="" data-reactid="286"><div id="mc_embed_signup_scroll" class="center hero-block" data-reactid="287"><p data-reactid="288">Keep up to date on Graphile and PostGraphile features/changes. Subscribe to our occasional announcements newsletter:</p><div class="mc-field-group form-inline justify-content-center" data-reactid="289"><div class="form-group" data-reactid="290"><div class="mb2" data-reactid="291"><label class="label--small" for="mce-EMAIL" data-reactid="292">Email address:</label></div><input type="email" autocapitalize="off" autocomplete="off" autocorrect="off" class="input-text mb0-ns mb1" id="mce-EMAIL" name="EMAIL" spellcheck="false" value="" data-reactid="293"/><div style="position:absolute;left:-5000px;" aria-hidden="true" data-reactid="294"><input type="text" name="b_d103f710cf00a9273b55e8e9b_c3a9eb5c4e" tabindex="-1" value="" data-reactid="295"/></div><input type="submit" class="button--solid" id="mc-embedded-subscribe" name="subscribe" value="Subscribe" data-reactid="296"/></div><div id="mce-responses" class="clear" data-reactid="297"><div class="response" id="mce-error-response" style="display:none;" data-reactid="298"></div><div class="response" id="mce-success-response" style="display:none;" data-reactid="299"></div></div></div></div></form></div></div></div></div></section></div><footer class="bg-white pv5 bt b--black f6 lh-copy" data-reactid="300"><div class="container" data-reactid="301"><div class="row" data-reactid="302"><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="303"><h6 data-reactid="304">PostGraphile</h6><ul data-reactid="305"><li data-reactid="306"><a href="/postgraphile/introduction/" data-reactid="307">Introduction</a></li><li data-reactid="308"><a href="/postgraphile/security/" data-reactid="309">Security</a></li><li data-reactid="310"><a href="/postgraphile/extending/" data-reactid="311">Extending</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="312"><h6 data-reactid="313">Graphile Engine</h6><ul data-reactid="314"><li data-reactid="315"><a href="/graphile-build/" data-reactid="316">About</a></li><li data-reactid="317"><a href="/graphile-build/getting-started/" data-reactid="318">Getting Started</a></li><li data-reactid="319"><a href="/graphile-build/plugins/" data-reactid="320">Plugins</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset" data-reactid="321"><h6 data-reactid="322">Resources</h6><ul data-reactid="323"><li data-reactid="324"><a href="/news/" data-reactid="325"><i class="fas fa-bullhorn" data-reactid="326"></i><!-- react-text: 327 --> News<!-- /react-text --></a></li><li data-reactid="328"><a href="https://github.com/graphile" data-reactid="329"><i class="fab fa-github" data-reactid="330"></i><!-- react-text: 331 --> GitHub<!-- /react-text --></a></li><li data-reactid="332"><a href="http://discord.gg/graphile" data-reactid="333"><i class="fab fa-discord" data-reactid="334"></i><!-- react-text: 335 --> Chat (discord)<!-- /react-text --></a></li><li data-reactid="336"><a href="https://twitter.com/graphilehq" data-reactid="337"><i class="fab fa-twitter" data-reactid="338"></i><!-- react-text: 339 --> Twitter<!-- /react-text --></a></li><li data-reactid="340"><a href="/news/press-kit/" data-reactid="341"><i class="fas fa-file-archive" data-reactid="342"></i><!-- react-text: 343 --> Logos/etc<!-- /react-text --></a></li></ul></div><div class="col-xs-12 col-md-offset-1 col-md-5" data-reactid="344"><h6 data-reactid="345">About</h6><!-- react-text: 346 -->PostGraphile and Graphile Build are crowd-funded Open Source Software, developed and maintained primarily by<!-- /react-text --><!-- react-text: 347 --> <!-- /react-text --><a href="https://twitter.com/benjie" data-reactid="348">@Benjie</a><!-- react-text: 349 --> with the help of the community.<!-- /react-text --><br data-reactid="350"/><br data-reactid="351"/><!-- react-text: 352 -->You can support the projects via<!-- /react-text --><!-- react-text: 353 --> <!-- /react-text --><a href="/sponsor/" data-reactid="354">sponsorship</a><!-- react-text: 355 -->, by<!-- /react-text --><!-- react-text: 356 --> <!-- /react-text --><a href="/postgraphile/pricing/" data-reactid="357">going Pro</a><!-- react-text: 358 -->, or by paying for<!-- /react-text --><!-- react-text: 359 --> <!-- /react-text --><a href="/support/" data-reactid="360">Professional Services</a><!-- react-text: 361 -->. Your support is gratefully received 🙏<!-- /react-text --><br data-reactid="362"/><br data-reactid="363"/><!-- react-text: 364 -->This site is copyright © Benjie Gillam <!-- /react-text --><!-- react-text: 365 -->2018<!-- /react-text --><!-- react-text: 366 -->. Design and logos copyright © Benjie Gillam and Jof Arnold<!-- /react-text --><!-- react-text: 367 --> <!-- /react-text --><!-- react-text: 368 -->2018<!-- /react-text --><!-- react-text: 369 -->.<!-- /react-text --><br data-reactid="370"/><br data-reactid="371"/><!-- react-text: 372 -->Corrections and contributions to this website are gratefully received via<!-- /react-text --><!-- react-text: 373 --> <!-- /react-text --><a href="https://github.com/graphile/graphile.github.io" data-reactid="374">its GitHub repository</a><!-- react-text: 375 -->.<!-- /react-text --><br data-reactid="376"/><br data-reactid="377"/><!-- react-text: 378 -->PostGraphile was <!-- /react-text --><a href="/history/" data-reactid="379">originally authored</a><!-- react-text: 380 --> as PostGraphQL by<!-- /react-text --><!-- react-text: 381 --> <!-- /react-text --><a href="https://twitter.com/calebmer" data-reactid="382">Caleb Meredith</a><!-- react-text: 383 -->.<!-- /react-text --></div></div></div></footer></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-2691d2104d4e5983bce4.js","96961042003272":"component---src-templates-page-js-44912100fe5a923703fa.js","59784799166159":"component---src-templates-marketing-js-40e199c898662c5efde7.js","60335399758886":"path----557518bd178906f8d58a.js","45788430371641":"path---history-028db4d9fc02651dae23.js","88641327033989":"path---sponsor-da8d42de01cff570af29.js","128602041518144":"path---graphile-build-all-hooks-306bee2fa24ec06bf42a.js","64023390553510":"path---graphile-build-build-object-e75c795bcd6d1c420ccb.js","69504633912515":"path---graphile-build-context-object-1fbd901c1286c42a2a31.js","125892818282768":"path---graphile-build-default-plugins-f59bedf2716cf79d0026.js","109947277077173":"path---graphile-build-getting-started-b8178e6101f8ab804a8a.js","16210746157911":"path---graphile-build-graphile-build-23e3b8acb5e574c424d3.js","57552969484094":"path---graphile-build-hooks-bcbda5b0ec491b68dd67.js","109627700230002":"path---graphile-build-f41a9655e0ee6494c60a.js","36474596372704":"path---graphile-build-omitting-plugins-673b49d6e008d4eb740f.js","276285638780302":"path---graphile-build-plugin-options-4b3eaac85a31e20b7d7f.js","136546493962690":"path---graphile-build-plugins-8731310dab8e6924a693.js","277477532944301":"path---graphile-build-schema-builder-32795eb9838ac52115ad.js","192423053311925":"path---graphile-build-pg-security-bb5f713c4a29c3a61d75.js","194808618595402":"path---graphile-build-pg-settings-ca11f33b89ddb39f4653.js","208863975630277":"path---news-be582336c54ed6597134.js","219633165437141":"path---news-postgraphile-version-4-1-8c1ef3f72db223990089.js","143510993521902":"path---news-postgraphile-version-4-652d6947b34fa12ef584.js","72313494074136":"path---news-press-kit-00e109fc59595284941d.js","141666846945901":"path---support-c66547754a3d1669e3ce.js","235145966638131":"path---postgraphile-code-of-conduct-c89d9bf686fc95e7df50.js","114781403929568":"path---postgraphile-community-chat-12f7e867a34ac8da8799.js","86394197680347":"path---postgraphile-community-contributions-63e0c21dde869cc033ea.js","216163489569211":"path---postgraphile-community-plugins-e8507d548c62d92f82d9.js","99411096849217":"path---postgraphile-computed-columns-fd0df87ba48739f5d88f.js","245194823331250":"path---postgraphile-connections-173c521fcd7c016bbf84.js","226259727392765":"path---postgraphile-crud-mutations-781199af773451d4b0e3.js","209456356109321":"path---postgraphile-custom-mutations-8daa90e062aee9888397.js","262226386268176":"path---postgraphile-custom-queries-3c100ecbd8f09be53be5.js","58450730530065":"path---postgraphile-debugging-075781acba1f56fbca6a.js","183024611244872":"path---postgraphile-default-role-f80814cc59fd4d5b63dd.js","46110498460401":"path---postgraphile-evaluating-62ae719e385281e6a458.js","235675790195762":"path---postgraphile-examples-d661d9b5f96325e08c3e.js","1465359564156":"path---postgraphile-extending-602bcd21fced79613f30.js","29661158995595":"path---postgraphile-filtering-84589a59e04c93546f44.js","101562502586227":"path---postgraphile-function-gallery-2f2c76a64092ad8ec42f.js","101463202308976":"path---postgraphile-function-restrictions-5d215728d8fc2c5e92d8.js","34445096275681":"path---postgraphile-inflection-0740ad0b8e6f859346a5.js","231292683096477":"path---postgraphile-introduction-8481610e9755d6a622f1.js","33982096820675":"path---postgraphile-introspection-7ae1177e4378dd4d2298.js","131593726388413":"path---postgraphile-jwk-verification-e0e68e9e7982a1cbd10b.js","217512476184238":"path---postgraphile-jwt-guide-e68ecaad6371afb2d92f.js","64254551156649":"path---postgraphile-make-add-inflectors-plugin-b3fa699a1cc22973deb2.js","161082936966388":"path---postgraphile-make-change-nullability-plugin-36f006062d1f6c4ceac3.js","258216963914742":"path---postgraphile-make-plugin-by-combining-plugins-5ebdc203329ab5ff2bf8.js","81450269707069":"path---postgraphile-make-process-schema-plugin-488f7c586fefe940f33f.js","183453616913285":"path---postgraphile-make-wrap-resolvers-plugin-3d6645c210545c759e24.js","49645441935291":"path---postgraphile-namespaces-9b78349a194703f0443c.js","206205697905610":"path---postgraphile-node-id-83b9200f2ad8ee67ae49.js","245838197689590":"path---postgraphile-performance-6da97bd34a9c055d854a.js","193154730806080":"path---postgraphile-plugin-gallery-cab3782b48ffcd225d84.js","34112019379484":"path---postgraphile-plugins-1423cc30fe67b4f692f8.js","43306645800525":"path---postgraphile-postgresql-indexes-fa61da888bd8a74388eb.js","257659440118484":"path---postgraphile-procedures-5a21db1a59a202de1c08.js","20524195157075":"path---postgraphile-quick-start-guide-7827bf86387d2e1e1611.js","136696082986067":"path---postgraphile-relations-73f0213aecfa7224eaf7.js","187294999324209":"path---postgraphile-requirements-c936a03f3500b46d3391.js","126695865748518":"path---postgraphile-reserved-keywords-7741416ab22b44c75c64.js","143935096069691":"path---postgraphile-security-94a8a92034e322b3d691.js","244450434420656":"path---postgraphile-tables-c8040f9763b236fe26f7.js","247601703930759":"path---postgraphile-usage-ea9cdeebe740ea9a4ac6.js","270428963090724":"path---postgraphile-versioning-policy-545a66ae92a27482a44d.js","156260474427399":"path---postgraphile-why-nullable-c09e8a7008fb4c457df9.js","76338124382236":"path---graphile-build-look-ahead-0dca2b68299b0f97b323.js","187503077063819":"path---postgraphile-extending-raw-6f7050b619e27467bbe8.js","202678300341359":"path---postgraphile-functions-49bcd4338777c6373216.js","30601655320255":"path---postgraphile-make-extend-schema-plugin-10afe04e2b47a4131afe.js","85182451526728":"path---postgraphile-pricing-de5f9b91c4197d32ab87.js","163587040327238":"path---postgraphile-production-0f58f5b034565d17bea7.js","27297302318019":"path---postgraphile-smart-comments-3d293d9cb9eeb14dd503.js","174583816914262":"path---postgraphile-testing-jest-0e9987151795542c65a6.js","3265662318058":"path---postgraphile-usage-cli-434276b63ce5a34eaecb.js","148070795768796":"path---postgraphile-usage-library-da7126c326a8d81bf76c.js","272066437984048":"path---postgraphile-usage-schema-921785c9e50a06232386.js","87638492893048":"path---postgraphile-v-3-migration-9ff6e021b7ac57c1b422.js","57656932303775":"path---postgraphile-v-4-new-features-9196cad32b285ec36508.js","142629428675168":"path---index-9af5238ba8a8966def21.js","48764759135427":"path---postgraphile-41f8bb3e02937bae057e.js","112985368742066":"path---postgraphile-subscriptions-802ef5e7c574b56640d8.js","17839233601159":"path---postgraphile-postgresql-schema-design-ae763fec4b92d066d4ed.js","114276838955818":"component---src-layouts-index-js-ace7914a8fea060c15f6.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-e9c5ebe9f9d03df65cb6.js","/app-2691d2104d4e5983bce4.js","/path---postgraphile-subscriptions-802ef5e7c574b56640d8.js","/component---src-templates-page-js-44912100fe5a923703fa.js","/component---src-layouts-index-js-ace7914a8fea060c15f6.js"])/*]]>*/</script><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script></body></html>