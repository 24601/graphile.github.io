<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><script src="https://use.fontawesome.com/c72bfae6f9.js"></script><link rel="preload" href="/component---src-layouts-index-js-53c26317295bc637138f.js" as="script"/><link rel="preload" href="/component---src-templates-page-js-ec852048c4e46c858b13.js" as="script"/><link rel="preload" href="/path---postgraphile-subscriptions-32b4b539120e19e84ab8.js" as="script"/><link rel="preload" href="/app-d2fd2f63d7abdf2fa2e3.js" as="script"/><link rel="preload" href="/commons-3596aa1ab404ed60101f.js" as="script"/><title data-react-helmet="true">PostGraphile | GraphQL Subscriptions</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphile, PostGraphQL, Postgres-GraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><link rel="stylesheet" href="/styles.css?t=2018-09-21T09-58-37.244Z"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div tabindex="-1" data-reactroot="" data-reactid="1" data-react-checksum="1006274681"><div class="template-page postgraphile" data-reactid="2"><!-- react-empty: 3 --><header class="header content absolute z-999 w-100" data-reactid="4"><nav class="navbar" data-reactid="5"><div class="container" data-reactid="6"><input type="checkbox" class="navbar-toggler input-reset" id="toggle" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="7"/><div class="nav-controls nested-list-reset " data-reactid="8"><div class="navbar-crosses" data-reactid="9"><span class="line line-1" data-reactid="10"> </span><span class="line line-2" data-reactid="11"> </span><span class="line line-3" data-reactid="12"> </span></div><ul class="navbar-nav flex w-100" data-reactid="13"><li class="navbar-item" data-reactid="14"><a class="nav-link " href="/" data-reactid="15"><span class="home-icon fa fa-home" data-reactid="16"></span><!-- react-text: 17 --> <!-- /react-text --><span class="home" data-reactid="18">Home</span></a></li><!-- react-empty: 19 --><!-- react-empty: 20 --><!-- react-empty: 21 --><li class="navbar-item" data-reactid="22"><a class="nav-link " href="/postgraphile/" data-reactid="23">Overview</a></li><li class="navbar-item" data-reactid="24"><a class="nav-link active" href="/postgraphile/introduction/" data-reactid="25">Documentation</a></li><li class="navbar-item" data-reactid="26"><a class="nav-link " href="/postgraphile/pricing/" data-reactid="27">Go Pro!</a></li><!-- react-empty: 28 --><!-- react-empty: 29 --><!-- react-empty: 30 --><li class="navbar-item ml-auto navbar-item-right" data-reactid="31"><span class="searchbox-container" data-reactid="32"><input id="search-box" placeholder="Search" data-reactid="33"/><span class="fa fa-search searchbox-search" data-reactid="34"></span></span></li><li class="navbar-item navbar-item-right" data-reactid="35"><a class="nav-link " href="/support/" data-reactid="36">Services</a></li><li class="navbar-item navbar-item-right hide-when-small" data-reactid="37"><a class="nav-link" href="https://graphql-training.com" title="GraphQL Training in London, Europe and Remote" data-reactid="38"><!-- react-text: 39 -->GraphQL Training<!-- /react-text --><!-- react-text: 40 --> <!-- /react-text --><span class="fa fa-external-link-square" data-reactid="41"></span></a></li><li class="navbar-item navbar-item-right" data-reactid="42"><a class="nav-link nav-github-link flex items-center" href="https://github.com/graphile/postgraphile" data-reactid="43"><span class="f3 fa fa-github" data-reactid="44"></span><!-- react-text: 45 --> <!-- /react-text --><span class="github" data-reactid="46"><!-- react-text: 47 -->Github <!-- /react-text --><span class="fa fa-external-link-square" data-reactid="48"></span></span></a></li></ul></div></div></nav></header><div class="page-content" data-reactid="49"><section data-reactid="50"><div class="container" data-reactid="51"><div class="row between-xs" data-reactid="52"><aside class="sidebar col-xs-12 col-md-3 last-xs mt3" data-reactid="53"><section data-reactid="54"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="55"><span data-reactid="56">Overview</span></h4><div class="nested-list-reset" data-reactid="57"><ul class="page-list nav flex-column mb5" data-reactid="58"><li class="f6 lh-copy pv1" data-reactid="59"><a class="nav-link " href="/postgraphile/introduction/" data-reactid="60"><span data-reactid="61">Introduction</span></a></li><li class="f6 lh-copy pv1" data-reactid="62"><a class="nav-link " href="/postgraphile/examples/" data-reactid="63"><span data-reactid="64">Examples</span></a></li><li class="f6 lh-copy pv1" data-reactid="65"><a class="nav-link " href="/postgraphile/quick-start-guide/" data-reactid="66"><span data-reactid="67">Quick Start Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="68"><a class="nav-link " href="/postgraphile/requirements/" data-reactid="69"><span data-reactid="70">Requirements</span></a></li><li class="f6 lh-copy pv1" data-reactid="71"><a class="nav-link " href="/postgraphile/performance/" data-reactid="72"><span data-reactid="73">Performance</span></a></li><li class="f6 lh-copy pv1" data-reactid="74"><a class="nav-link " href="/postgraphile/connections/" data-reactid="75"><span data-reactid="76">Connections</span></a></li><li class="f6 lh-copy pv1" data-reactid="77"><a class="nav-link " href="/postgraphile/filtering/" data-reactid="78"><span data-reactid="79">Filtering</span></a></li><li class="f6 lh-copy pv1" data-reactid="80"><a class="nav-link " href="/postgraphile/relations/" data-reactid="81"><span data-reactid="82">Relations</span></a></li><li class="f6 lh-copy pv1" data-reactid="83"><a class="nav-link " href="/postgraphile/crud-mutations/" data-reactid="84"><span data-reactid="85">CRUD Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="86"><a class="nav-link " href="/postgraphile/computed-columns/" data-reactid="87"><span data-reactid="88">Computed Columns</span></a></li><li class="f6 lh-copy pv1" data-reactid="89"><a class="nav-link " href="/postgraphile/custom-queries/" data-reactid="90"><span data-reactid="91">Custom Queries</span></a></li><li class="f6 lh-copy pv1" data-reactid="92"><a class="nav-link " href="/postgraphile/custom-mutations/" data-reactid="93"><span data-reactid="94">Custom Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="95"><a class="nav-link " href="/postgraphile/smart-comments/" data-reactid="96"><span data-reactid="97">Smart Comments</span></a></li><li class="f6 lh-copy pv1" data-reactid="98"><a class="nav-link " href="/postgraphile/security/" data-reactid="99"><span data-reactid="100">Security</span></a></li><li class="f6 lh-copy pv1" data-reactid="101"><a class="nav-link " href="/postgraphile/introspection/" data-reactid="102"><span data-reactid="103">Introspection</span></a></li><li class="f6 lh-copy pv1" data-reactid="104"><a class="nav-link " href="/postgraphile/extending/" data-reactid="105"><span data-reactid="106">Schema Plugins</span></a></li><li class="f6 lh-copy pv1" data-reactid="107"><a class="nav-link " href="/postgraphile/plugins/" data-reactid="108"><span data-reactid="109">Server Plugins</span></a></li><li class="f6 lh-copy pv1" data-reactid="110"><a class="nav-link active" href="/postgraphile/subscriptions/" data-reactid="111"><span data-reactid="112">Subscriptions</span></a></li><li class="f6 lh-copy pv1" data-reactid="113"><a class="nav-link " href="/postgraphile/production/" data-reactid="114"><span data-reactid="115">Production Considerations</span></a></li><li class="f6 lh-copy pv1" data-reactid="116"><a class="nav-link " href="/postgraphile/reserved-keywords/" data-reactid="117"><span data-reactid="118">Reserved Keywords</span></a></li><li class="f6 lh-copy pv1" data-reactid="119"><a class="nav-link " href="/postgraphile/debugging/" data-reactid="120"><span data-reactid="121">Debugging</span></a></li></ul></div></section><section data-reactid="122"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="123"><span data-reactid="124">Guides</span></h4><div class="nested-list-reset" data-reactid="125"><ul class="page-list nav flex-column mb5" data-reactid="126"><li class="f6 lh-copy pv1" data-reactid="127"><a class="nav-link " href="/postgraphile/evaluating/" data-reactid="128"><span data-reactid="129">Evaluating for your Project</span></a></li><li class="f6 lh-copy pv1" data-reactid="130"><a class="nav-link " href="/postgraphile/jwt-guide/" data-reactid="131"><span data-reactid="132">PostGraphile JWT Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="133"><a class="nav-link " href="/postgraphile/default-role/" data-reactid="134"><span data-reactid="135">The Default Role</span></a></li><li class="f6 lh-copy pv1" data-reactid="136"><a class="nav-link " href="/postgraphile/procedures/" data-reactid="137"><span data-reactid="138">PostgreSQL Procedures</span></a></li><li class="f6 lh-copy pv1" data-reactid="139"><a class="nav-link " href="/postgraphile/postgresql-schema-design/" data-reactid="140"><span data-reactid="141">PostgreSQL Schema Design</span></a></li><li class="f6 lh-copy pv1" data-reactid="142"><a class="nav-link " href="/postgraphile/postgresql-indexes/" data-reactid="143"><span data-reactid="144">PostgreSQL Indexes</span></a></li><li class="f6 lh-copy pv1" data-reactid="145"><a class="nav-link " href="/postgraphile/v4-new-features/" data-reactid="146"><span data-reactid="147">v4 Feature Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="148"><a class="nav-link " href="/postgraphile/v3-migration/" data-reactid="149"><span data-reactid="150">v3 → v4 Migration Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="151"><a class="nav-link " href="/postgraphile/testing-jest/" data-reactid="152"><span data-reactid="153">Testing with Jest</span></a></li></ul></div></section><section data-reactid="154"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="155"><span data-reactid="156">Usage</span></h4><div class="nested-list-reset" data-reactid="157"><ul class="page-list nav flex-column mb5" data-reactid="158"><li class="f6 lh-copy pv1" data-reactid="159"><a class="nav-link " href="/postgraphile/usage-cli/" data-reactid="160"><span data-reactid="161">CLI Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="162"><a class="nav-link " href="/postgraphile/usage-library/" data-reactid="163"><span data-reactid="164">Library Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="165"><a class="nav-link " href="/postgraphile/usage-schema/" data-reactid="166"><span data-reactid="167">Schema-only Usage</span></a></li></ul></div></section><section data-reactid="168"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="169"><span data-reactid="170">Community</span></h4><div class="nested-list-reset" data-reactid="171"><ul class="page-list nav flex-column mb5" data-reactid="172"><li class="f6 lh-copy pv1" data-reactid="173"><a class="nav-link " href="/postgraphile/community-plugins/" data-reactid="174"><span data-reactid="175">Community Plugins</span></a></li><li class="f6 lh-copy pv1" data-reactid="176"><a class="nav-link " href="/postgraphile/community-chat/" data-reactid="177"><span data-reactid="178">Community Chat</span></a></li><li class="f6 lh-copy pv1" data-reactid="179"><a class="nav-link " href="/postgraphile/code-of-conduct/" data-reactid="180"><span data-reactid="181">Code of Conduct</span></a></li></ul></div></section><section data-reactid="182"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="183"><span data-reactid="184">FAQ</span></h4><div class="nested-list-reset" data-reactid="185"><ul class="page-list nav flex-column mb5" data-reactid="186"><li class="f6 lh-copy pv1" data-reactid="187"><a class="nav-link " href="/postgraphile/why-nullable/" data-reactid="188"><span data-reactid="189">Why is it nullable?</span></a></li></ul></div></section></aside><div class="col-xs-12 col-md-9 first-xs main-content" data-reactid="190"><div class="row" data-reactid="191"><div class="col-xs-12" style="width:100%;" data-reactid="192"><div class="edit-this-page" data-reactid="193"><a href="https://github.com/graphile/graphile.github.io/edit/develop/src/pages/postgraphile/subscriptions.md" data-reactid="194">📝 Edit this page</a></div><div data-reactid="195"><h2 id="graphql-subscriptions"><a href="#graphql-subscriptions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GraphQL Subscriptions</h2>
<p>PostGraphile Core doesn't yet have subscriptions support built in. There is
much talk about what a GraphQL subscriptions solution might look like in
<a href="https://github.com/graphile/postgraphile/issues/92">issue #92</a>.</p>
<p>Patreon backers (and those who have purchased the Pro plugin) may try out an
early simple subscriptions feature via the <a href="/postgraphile/plugins/">Supporter
Plugin</a>. We'd love to hear your feedback on this
implementation. The rest of this article details how to use this feature.</p>
<h2 id="simple-subscriptions-supporter"><a href="#simple-subscriptions-supporter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simple Subscriptions <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a></h2>
<h3 id="enabling-with-an-express-app"><a href="#enabling-with-an-express-app" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabling with an Express app</h3>
<p>With the CLI use <code class="language-text">--simple-subscriptions</code> to enable the subscriptions support.
With the library version use <code class="language-text">simpleSubscriptions: true</code>.</p>
<p>We emulate part of the express stack, so if you require sessions you can pass
additional connect/express middlewares (sorry, we don't support Koa middlewares
here at this time) via the options <code class="language-text">enhanceHttpServerWithSubscriptions</code>.</p>
<p>Here's an example:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> postgraphile<span class="token punctuation">,</span> makePluginHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"postgraphile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> PostGraphileSupporter
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@graphile/plugin-supporter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pluginHook <span class="token operator">=</span> <span class="token function">makePluginHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span>PostGraphileSupporter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postgraphileOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  pluginHook<span class="token punctuation">,</span>
  simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  websocketMiddlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// Add whatever middlewares you need here, note that</span>
    <span class="token comment">// they should only manipulate properties on req/res,</span>
    <span class="token comment">// they must not sent response data. e.g.:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   require('express-session')(),</span>
    <span class="token comment">//   require('passport').initialize(),</span>
    <span class="token comment">//   require('passport').session(),</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">postgraphile</span><span class="token punctuation">(</span>databaseUrl<span class="token punctuation">,</span> <span class="token string">"app_public"</span><span class="token punctuation">,</span> postgraphileOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<h4 id="advanced-setup"><a href="#advanced-setup" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Advanced setup</h4>
<p>If you need websockets to be listened for before your first HTTP request comes
in (most people don't need this) then you must create a <code class="language-text">rawHTTPServer</code>, mount
your express <code class="language-text">app</code> in it, and then add subscription support to the raw server
via the <code class="language-text">enhanceHttpServerWithSubscriptions</code> function, as shown below:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> postgraphile<span class="token punctuation">,</span> makePluginHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"postgraphile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> PostGraphileSupporter<span class="token punctuation">,</span>
  enhanceHttpServerWithSubscriptions
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@graphile/plugin-supporter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pluginHook <span class="token operator">=</span> <span class="token function">makePluginHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span>PostGraphileSupporter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rawHTTPServer <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postgraphileOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  pluginHook<span class="token punctuation">,</span>
  simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  websocketMiddlewares<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// Add whatever middlewares you need here, note that</span>
    <span class="token comment">// they should only manipulate properties on req/res,</span>
    <span class="token comment">// they must not sent response data. e.g.:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   require('express-session')(),</span>
    <span class="token comment">//   require('passport').initialize(),</span>
    <span class="token comment">//   require('passport').session(),</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postgraphileMiddleware <span class="token operator">=</span> <span class="token function">postgraphile</span><span class="token punctuation">(</span>
  databaseUrl<span class="token punctuation">,</span>
  <span class="token string">"app_public"</span><span class="token punctuation">,</span>
  postgraphileOptions
<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>postgraphileMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">enhanceHttpServerWithSubscriptions</span><span class="token punctuation">(</span>
  rawHTTPServer<span class="token punctuation">,</span>
  postgraphileMiddleware<span class="token punctuation">,</span>
  postgraphileOptions
<span class="token punctuation">)</span><span class="token punctuation">;</span>

rawHTTPServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>The <code class="language-text">enhanceHttpServerWithSubscriptions</code> takes three arguments:</p>
<ol>
<li>the raw HTTP server from <code class="language-text">require(&#39;http&#39;).createServer()</code></li>
<li>the postgraphile middleware (this should be the <em>same</em> middleware that you mount into your Express app)</li>
<li>options, where you can optionally pass <code class="language-text">middlewares</code> to enable <code class="language-text">pgSettings(req) {...}</code> access to session-based things</li>
</ol>
<h3 id="using"><a href="#using" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using</h3>
<p>To enable simple subscriptions support, use the <code class="language-text">--simple-subscriptions</code> CLI
flag (or <code class="language-text">simpleSubscriptions: true</code> middleware option).</p>
<p>This will expose a <code class="language-text">listen</code> subscription field that can be used for generic
subscriptions to a named topic which can be triggered using PostgreSQL's built
in LISTEN/NOTIFY functionality.</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">type ListenPayload <span class="token punctuation">{</span>
  <span class="token attr-name">query</span><span class="token punctuation">:</span> Query
  <span class="token attr-name">relatedNode</span><span class="token punctuation">:</span> Node
  <span class="token attr-name">relatedNodeId</span><span class="token punctuation">:</span> ID
<span class="token punctuation">}</span>

type Subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> String<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ListenPayload<span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<h3 id="topic-prefix"><a href="#topic-prefix" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Topic prefix</h3>
<p>All topics are automatically prefixed with <code class="language-text">postgraphile:</code> (but you can
customise this with the <code class="language-text">pgSubscriptionPrefix</code> setting if you're using the
middleware version) - GraphQL consumers will not need to know about this,
but you will need to remember to add it to your <code class="language-text">NOTIFY</code> topic otherwise
subscribers will not see the messages.</p>
<p>For example a user may perform the following subscription:</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relatedNodeId
    relatedNode <span class="token punctuation">{</span>
      nodeId
      <span class="token operator">...</span> <span class="token keyword">on</span> Foo <span class="token punctuation">{</span>
        id
        title
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>To cause the subscription to receive a message, you could run:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  <span class="token string">'{}'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Resulting in this GraphQL payload:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"listen"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"relatedNodeId"</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
      <span class="token property">"relatedNode"</span><span class="token operator">:</span> <span class="token null">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>Which is sufficient to know that the event <em>occurred</em>, but chances are that you
want to know more than this...</p>
<p>It's also possible to send a <code class="language-text">Node</code> along with your GraphQL payload using the
<code class="language-text">__node__</code> field on the <code class="language-text">pg_notify</code> body (which is interpreted as JSON). The
<code class="language-text">__node__</code> field is similar to the <code class="language-text">nodeId</code> (or <code class="language-text">id</code> if you use
<code class="language-text">--classic-ids</code>) field in your GraphQL requests, except it's the raw JSON
before it gets stringified and base64 encoded. (The reason for this is that
Postgres' JSON functions leave some optional spaces in, so when they are base64
encoded the strings do not match.)</p>
<p>Assuming that you have a table of the form
<code class="language-text">foos(id serial primary key, title text, ...)</code> you can add the <code class="language-text">__node__</code> field
as follows and the record with id=32 will be made available as the <code class="language-text">relatedNode</code>
in the GraphQL subscription payload:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span>
    <span class="token string">'__node__'</span><span class="token punctuation">,</span> json_build_array<span class="token punctuation">(</span><span class="token string">'foos'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Resulting in this GraphQL payload:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"listen"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"relatedNodeId"</span><span class="token operator">:</span> <span class="token string">"WyJmb29zIiwzMl0="</span><span class="token punctuation">,</span>
      <span class="token property">"relatedNode"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"nodeId"</span><span class="token operator">:</span> <span class="token string">"WyJmb29zIiwzMl0="</span><span class="token punctuation">,</span>
        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Howdy!"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<blockquote>
<p><strong>NOTE</strong>: This solution is still taking shape, so it's not yet certain how other fields
on the NOTIFY message JSON will be exposed via GraphQL. You are advised to
treat the content of this message JSON as if it's visible to the user, as at
some point it may be.</p>
</blockquote>
<blockquote>
<p><strong>NOTE</strong>: In PostgreSQL the channel is an "identifier" which by default is
limited to 63 characters. Subtracting the <code class="language-text">postgraphile:</code> prefix leaves 50
characters for your topic name.</p>
</blockquote>
<h3 id="subscription-security"><a href="#subscription-security" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscription security</h3>
<p>By default, any user may subscribe to any topic, whether logged in or not, and
they will remain subscribed until they close the connection themselves. This
can cause a number of security issues; so we give you a method to implement
security around subscriptions.</p>
<p>By specifying <code class="language-text">--subscription-authorization-function [fn]</code> on the PostGraphile CLI (or using the
<code class="language-text">subscriptionAuthorizationFunction</code> option) you can have PostGraphile call the
function you specified to ensure that the user is
allowed to subscribe to the relevant topic. The function must accept one text
argument <code class="language-text">topic</code> and must return a string or raise an exception (note: the <code class="language-text">topic</code>
argument WILL be sent including the <code class="language-text">postgraphile:</code> prefix).</p>
<p>A typical implementation will look like this:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span>
  app_hidden<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
  <span class="token keyword">IF</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">THEN</span>
    <span class="token keyword">RETURN</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    RAISE EXCEPTION <span class="token string">'Subscription denied'</span>
      <span class="token keyword">USING</span> errcode <span class="token operator">=</span> <span class="token string">'.....'</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql VOLATILE SECURITY <span class="token keyword">DEFINER</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You must define this function with your custom security logic. To use this
function you'd pass the CLI flag:
<code class="language-text">--subscription-authorization-function app_private.validate_subscription</code></p>
<p>The text value returned is used to tell the system when to cancel the
subscription - if you don't need this functionality then you may return a
<em>static</em> unique value, e.g. generate a random UUID (manually) and then return
this same UUID over and over from your function, e.g.:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> app_hidden<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
  <span class="token keyword">IF</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">THEN</span>
    <span class="token keyword">RETURN</span> <span class="token string">'4A2D27CD-7E67-4585-9AD8-50AF17D98E0B'</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    RAISE EXCEPTION <span class="token string">'Subscription denied'</span> <span class="token keyword">USING</span> errcode <span class="token operator">=</span> <span class="token string">'.....'</span><span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql VOLATILE SECURITY <span class="token keyword">DEFINER</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>When a message is published to the topic identified by the return value of this
function (NOTE: this topic will NOT be prefixed with <code class="language-text">postgraphile:</code> because it
should be private), the associated subscription will automatically be terminated.</p>
<h3 id="naming-your-topics"><a href="#naming-your-topics" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Naming your topics</h3>
<p>You might want to make the topic a combination of things, for example the
subject type and identifier - e.g. 'channel:123'. If you do this then your
function could determine which subject the user is attempting to subscribe to,
check the user has access to that subject, and finally return a PostgreSQL
topic that will be published to in the event the user is kicked from the
channel, e.g. <code class="language-text">&#39;channel:123:kick:987&#39;</code> (assuming '987' is the id
of the current user).</p>
<h3 id="example-walk-through"><a href="#example-walk-through" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example walk-through</h3>
<p>First, set up a <code class="language-text">.postgraphilerc.js</code> containing the following:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"@graphile/plugin-supporter"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    connection<span class="token punctuation">:</span> <span class="token string">"postgres://localhost/subs"</span><span class="token punctuation">,</span>
    schema<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"app_public"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    simpleSubscriptions<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Next, in terminal 1, run:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">createdb subs || true
postgraphile</code></pre>
      </div>
<p>In terminal 2, connect to the subs DB using <code class="language-text">psql subs</code> and run the following:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">schema</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_public<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">schema</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_private<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> app_public<span class="token punctuation">.</span>foo <span class="token punctuation">(</span>
 id <span class="token keyword">serial</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
 title <span class="token keyword">text</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span>
  app_private<span class="token punctuation">.</span>validate_subscription<span class="token punctuation">(</span>topic <span class="token keyword">text</span><span class="token punctuation">)</span>
  <span class="token keyword">returns</span> <span class="token keyword">text</span> <span class="token keyword">as</span>
$$
 <span class="token keyword">select</span> <span class="token string">'CANCEL_ALL_SUBSCRIPTIONS'</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
$$ <span class="token keyword">language</span> <span class="token keyword">sql</span> stable<span class="token punctuation">;</span></code></pre>
      </div>
<p>Then using a GraphQL client that supports subscriptions, such as <a href="https://github.com/graphcool/graphql-playground">GraphQL Playground</a>,
perform the following subscription:</p>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql">subscription <span class="token punctuation">{</span>
  listen<span class="token punctuation">(</span><span class="token attr-name">topic</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    relatedNodeId
    relatedNode <span class="token punctuation">{</span>
      nodeId
      <span class="token operator">...</span> <span class="token keyword">on</span> Foo <span class="token punctuation">{</span>
        id
        title
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>You are not expecting an immediate result; first you have to trigger the event. To do so, back in your <code class="language-text">psql</code> session in terminal 2, execute:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> app_public<span class="token punctuation">.</span>foo <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Howdy!'</span><span class="token punctuation">)</span> returning <span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'postgraphile:hello'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span>
    <span class="token string">'__node__'</span><span class="token punctuation">,</span> json_build_array<span class="token punctuation">(</span>
      <span class="token string">'foos'</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> app_public<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You should find that the event has been received by the client and the 'Howdy!'
node has come through. You can run the above a few more times, or experiment a
bit by changing the values if you like.</p>
<p>Finally to cancel the subscription, execute the following SQL:</p>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> pg_notify<span class="token punctuation">(</span>
  <span class="token string">'CANCEL_ALL_SUBSCRIPTIONS'</span><span class="token punctuation">,</span>
  json_build_object<span class="token punctuation">(</span><span class="token punctuation">)</span>::<span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>You should notice that your client is no longer subscribed.</p>
<p><strong>Bonus</strong>: the SQL commands in this walk-through can be automated with this handy
bash script:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -e
createdb subs <span class="token operator">||</span> <span class="token boolean">true</span>
psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
create schema if not exists app_public;
create table if not exists app_public.foo (
 id serial primary key,
 title text not null
);
create schema if not exists app_private;
create or replace function app_private.validate_subscription(topic text)
returns text as \$\$
 select 'CANCEL_ALL_SUBSCRIPTIONS'::text;
\$\$ language sql stable;
HERE</span>

<span class="token function">sleep</span> 1

psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
 do \$\$
 declare
   v_foo app_public.foo;
 begin
   insert into app_public.foo (title) values ('Howdy!') returning * into v_foo;
   perform pg_notify(
     'postgraphile:hello',
     json_build_object('__node__', json_build_array('foos', v_foo.id))::text
   );
 end;
 \$\$ language plpgsql;
HERE</span>

<span class="token function">sleep</span> 3

psql -1X -v ON_ERROR_STOP<span class="token operator">=</span>1 subs <span class="token operator">&lt;&lt;</span> <span class="token string">HERE
 do \$\$
 declare
   v_foo app_public.foo;
 begin
   insert into app_public.foo (title) values ('Goodbye!') returning * into v_foo;
   perform pg_notify(
     'postgraphile:hello',
     json_build_object('__node__', json_build_array('foos', v_foo.id))::text
   );
   perform pg_notify(
     'CANCEL_ALL_SUBSCRIPTIONS',
     json_build_object()::text
   );
 end;
 \$\$ language plpgsql;
HERE</span></code></pre>
      </div></div></div><br data-reactid="196"/><br data-reactid="197"/><div class="col-xs-12 mt3 mb5" data-reactid="198"><div class="row between-xs" data-reactid="199"><div class="col-xs-6" data-reactid="200"><a class="" href="/postgraphile/plugins/" data-reactid="201"><span class="fa fa-fw fa-long-arrow-left" data-reactid="202"></span><!-- react-text: 203 --> <!-- /react-text --><span data-reactid="204">Server Plugins</span></a></div><div class="col-xs-6 tr" data-reactid="205"><a class="" href="/postgraphile/production/" data-reactid="206"><span data-reactid="207">Production Considerations</span><!-- react-text: 208 --> <!-- /react-text --><span class="fa fa-fw fa-long-arrow-right" data-reactid="209"></span></a></div></div></div></div></div></div></div></section><section class="mailinglist" data-reactid="210"><div class="container" data-reactid="211"><div class="row" data-reactid="212"><div class="col-xs-12" data-reactid="213"><div class="hero-block" data-reactid="214"><h3 data-reactid="215"><!-- react-text: 216 -->Questions, comments or feedback?<!-- /react-text --><br data-reactid="217"/><!-- react-text: 218 -->Email<!-- /react-text --><!-- react-text: 219 --> <!-- /react-text --><a href="mailto:info@graphile.org?subject=Documentation%20question/comment/feedback:)" data-reactid="220">info@graphile.org</a></h3><form action="//graphile.us16.list-manage.com/subscribe/post?u=d103f710cf00a9273b55e8e9b&amp;id=c3a9eb5c4e" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="" data-reactid="221"><div id="mc_embed_signup_scroll" class="center hero-block" data-reactid="222"><p data-reactid="223">Keep up to date on Graphile and PostGraphile features/changes. Subscribe to our occasional announcements newsletter:</p><div class="mc-field-group form-inline justify-content-center" data-reactid="224"><div class="form-group" data-reactid="225"><div class="mb2" data-reactid="226"><label class="label--small" for="mce-EMAIL" data-reactid="227">Email address:</label></div><input type="email" autocapitalize="off" autocomplete="off" autocorrect="off" class="input-text mb0-ns mb1" id="mce-EMAIL" name="EMAIL" spellcheck="false" value="" data-reactid="228"/><div style="position:absolute;left:-5000px;" aria-hidden="true" data-reactid="229"><input type="text" name="b_d103f710cf00a9273b55e8e9b_c3a9eb5c4e" tabindex="-1" value="" data-reactid="230"/></div><input type="submit" class="button--solid" id="mc-embedded-subscribe" name="subscribe" value="Subscribe" data-reactid="231"/></div><div id="mce-responses" class="clear" data-reactid="232"><div class="response" id="mce-error-response" style="display:none;" data-reactid="233"></div><div class="response" id="mce-success-response" style="display:none;" data-reactid="234"></div></div></div></div></form></div></div></div></div></section></div><footer class="bg-white pv5 bt b--black f6 lh-copy" data-reactid="235"><div class="container" data-reactid="236"><div class="row" data-reactid="237"><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="238"><h6 data-reactid="239">PostGraphile</h6><ul data-reactid="240"><li data-reactid="241"><a href="/postgraphile/introduction/" data-reactid="242">Introduction</a></li><li data-reactid="243"><a href="/postgraphile/security/" data-reactid="244">Security</a></li><li data-reactid="245"><a href="/postgraphile/extending/" data-reactid="246">Extending</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="247"><h6 data-reactid="248">Graphile Build</h6><ul data-reactid="249"><li data-reactid="250"><a href="/graphile-build/" data-reactid="251">About</a></li><li data-reactid="252"><a href="/graphile-build/getting-started/" data-reactid="253">Getting Started</a></li><li data-reactid="254"><a href="/graphile-build/plugins/" data-reactid="255">Plugins</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset" data-reactid="256"><h6 data-reactid="257">Community</h6><ul data-reactid="258"><li data-reactid="259"><a href="https://github.com/graphile" data-reactid="260">GitHub</a></li><li data-reactid="261"><a href="https://gitter.im/graphile/postgraphile" data-reactid="262">Gitter chat</a></li><li data-reactid="263"><a href="https://twitter.com/benjie" data-reactid="264">Twitter</a></li></ul></div><div class="col-xs-12 col-md-offset-1 col-md-5" data-reactid="265"><h6 data-reactid="266">About</h6><!-- react-text: 267 -->PostGraphile and Graphile Build are Open Source Software, developed and maintained by <!-- /react-text --><a href="https://twitter.com/benjie" data-reactid="268">@Benjie</a><!-- react-text: 269 -->with the help of the community.<!-- /react-text --><br data-reactid="270"/><br data-reactid="271"/><!-- react-text: 272 -->You can support the projects via<!-- /react-text --><!-- react-text: 273 --> <!-- /react-text --><a href="https://www.patreon.com/benjie" target="_blank" data-reactid="274">Patreon</a><!-- react-text: 275 -->, by <!-- /react-text --><a href="/postgraphile/pricing/" data-reactid="276">going Pro</a><!-- react-text: 277 -->, or by paying for <!-- /react-text --><a href="/support/" data-reactid="278">Professional Services</a><!-- react-text: 279 -->. Your support is gratefully received 🙏<!-- /react-text --><br data-reactid="280"/><br data-reactid="281"/><!-- react-text: 282 -->This site is copyright © Benjie Gillam <!-- /react-text --><!-- react-text: 283 -->2018<!-- /react-text --><!-- react-text: 284 -->. Design and logos copyright © Benjie Gillam and Jof Arnold<!-- /react-text --><!-- react-text: 285 --> <!-- /react-text --><!-- react-text: 286 -->2018<!-- /react-text --><!-- react-text: 287 -->.<!-- /react-text --><br data-reactid="288"/><br data-reactid="289"/><!-- react-text: 290 -->Corrections and contributions to this website are gratefully received via<!-- /react-text --><!-- react-text: 291 --> <!-- /react-text --><a href="https://github.com/graphile/graphile.github.io" data-reactid="292">its GitHub repository</a><!-- react-text: 293 -->.<!-- /react-text --><br data-reactid="294"/><br data-reactid="295"/><!-- react-text: 296 -->PostGraphile was <!-- /react-text --><a href="/history/" data-reactid="297">originally authored</a><!-- react-text: 298 --> as PostGraphQL by<!-- /react-text --><!-- react-text: 299 --> <!-- /react-text --><a href="https://twitter.com/calebmer" data-reactid="300">Caleb Meredith</a><!-- react-text: 301 -->.<!-- /react-text --></div></div></div></footer></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-d2fd2f63d7abdf2fa2e3.js","96961042003272":"component---src-templates-page-js-ec852048c4e46c858b13.js","266772403791747":"component---src-templates-home-js-408d6540d13e20da37b8.js","59784799166159":"component---src-templates-marketing-js-9f9607cc4787f4dfabcf.js","60335399758886":"path----557518bd178906f8d58a.js","45788430371641":"path---history-a27927ff05ab2ef05b8e.js","142629428675168":"path---index-04361dfa1e873f59fc7b.js","192423053311925":"path---graphile-build-pg-security-fe828733c148ae099f27.js","133858743292129":"path---postgraphile-settings-ba1a3053b7ad1f4e51b2.js","128602041518144":"path---graphile-build-all-hooks-bb9edb693636344304bf.js","64023390553510":"path---graphile-build-build-object-12d21e63d1dbbf975df8.js","69504633912515":"path---graphile-build-context-object-caa89ded67d6a2e6b611.js","125892818282768":"path---graphile-build-default-plugins-6e29777d777bfb2ae576.js","109947277077173":"path---graphile-build-getting-started-951828878df9cbbaeb90.js","16210746157911":"path---graphile-build-graphile-build-48e33846580e6be81e96.js","57552969484094":"path---graphile-build-hooks-2f43ac7eb2519f86c543.js","36474596372704":"path---graphile-build-omitting-plugins-c83f72612072754014f2.js","276285638780302":"path---graphile-build-plugin-options-79b2a57d302d788eb919.js","136546493962690":"path---graphile-build-plugins-0d761982eaee3ea56990.js","277477532944301":"path---graphile-build-schema-builder-fd87e90cdde7f95f7729.js","141666846945901":"path---support-3d1d219a638e5f6326b3.js","235145966638131":"path---postgraphile-code-of-conduct-eae6a4ee73474e022094.js","114781403929568":"path---postgraphile-community-chat-3d0e60d495e211a7478c.js","216163489569211":"path---postgraphile-community-plugins-d5f91eb78a1810272f6b.js","99411096849217":"path---postgraphile-computed-columns-332cf8326972aee80171.js","245194823331250":"path---postgraphile-connections-040ff9f066f4f0613e72.js","226259727392765":"path---postgraphile-crud-mutations-1f1947cb8c1dc4ee52b3.js","209456356109321":"path---postgraphile-custom-mutations-2948ccb83165eda55e22.js","262226386268176":"path---postgraphile-custom-queries-29849c4c7c430737c399.js","58450730530065":"path---postgraphile-debugging-175eb035738a1adbf383.js","183024611244872":"path---postgraphile-default-role-b83f06e344d9a51099bd.js","46110498460401":"path---postgraphile-evaluating-7de42502702fb60fac1c.js","235675790195762":"path---postgraphile-examples-588408fee944a78e36b5.js","29661158995595":"path---postgraphile-filtering-260ec8783b236d54b944.js","101463202308976":"path---postgraphile-function-restrictions-2974b736b0908892ea2d.js","231292683096477":"path---postgraphile-introduction-0609c9b33458a8722a98.js","33982096820675":"path---postgraphile-introspection-155dca139fe0cc16ce4b.js","217512476184238":"path---postgraphile-jwt-guide-694af01a638c4908fdf7.js","245838197689590":"path---postgraphile-performance-a3476b6a5df63e0d147c.js","34112019379484":"path---postgraphile-plugins-917bf728ed232adf0ad2.js","43306645800525":"path---postgraphile-postgresql-indexes-adca4074906eebd5137a.js","20524195157075":"path---postgraphile-quick-start-guide-fc133cb491fa67b986ef.js","136696082986067":"path---postgraphile-relations-c7db569e66b00fee9c20.js","187294999324209":"path---postgraphile-requirements-971195cec8814a948b4e.js","126695865748518":"path---postgraphile-reserved-keywords-0d2e20ec6300766781e9.js","143935096069691":"path---postgraphile-security-5a82b344692209746fec.js","247601703930759":"path---postgraphile-usage-6fe14068e81b66c00d11.js","156260474427399":"path---postgraphile-why-nullable-90ba9afcbea478bb6ce4.js","109627700230002":"path---graphile-build-2db41d1ba8e5671d3014.js","76338124382236":"path---graphile-build-look-ahead-d3a6d9b88774cdb80982.js","48764759135427":"path---postgraphile-8176f65eccf83167cc34.js","85182451526728":"path---postgraphile-pricing-72d7e46231e8d1d715be.js","257659440118484":"path---postgraphile-procedures-bf07ca27201c6ce7e0e9.js","163587040327238":"path---postgraphile-production-3b921b90daf6c4a93442.js","27297302318019":"path---postgraphile-smart-comments-e202792e68f32a9aa7f4.js","112985368742066":"path---postgraphile-subscriptions-32b4b539120e19e84ab8.js","174583816914262":"path---postgraphile-testing-jest-f46bc4b5d21db84a4ce2.js","3265662318058":"path---postgraphile-usage-cli-a2d71de1a99edc944975.js","148070795768796":"path---postgraphile-usage-library-99f2f05251b242f754b6.js","272066437984048":"path---postgraphile-usage-schema-57c0080d4ed190472ffc.js","87638492893048":"path---postgraphile-v-3-migration-84799079bd7d454cfdfc.js","57656932303775":"path---postgraphile-v-4-new-features-aaf78bfdaf3786e13580.js","1465359564156":"path---postgraphile-extending-68316cb7560191eb26dd.js","17839233601159":"path---postgraphile-postgresql-schema-design-49ebac66e34409f72d8c.js","114276838955818":"component---src-layouts-index-js-53c26317295bc637138f.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-3596aa1ab404ed60101f.js","/app-d2fd2f63d7abdf2fa2e3.js","/path---postgraphile-subscriptions-32b4b539120e19e84ab8.js","/component---src-templates-page-js-ec852048c4e46c858b13.js","/component---src-layouts-index-js-53c26317295bc637138f.js"])/*]]>*/</script><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script></body></html>