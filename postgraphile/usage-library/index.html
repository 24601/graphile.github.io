<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"/><link rel="preload" href="/component---src-layouts-index-js-ace7914a8fea060c15f6.js" as="script"/><link rel="preload" href="/component---src-templates-page-js-44912100fe5a923703fa.js" as="script"/><link rel="preload" href="/path---postgraphile-usage-library-fda47dd3f196409e5294.js" as="script"/><link rel="preload" href="/app-85aa6ac030e1396efe54.js" as="script"/><link rel="preload" href="/commons-e9c5ebe9f9d03df65cb6.js" as="script"/><title data-react-helmet="true">PostGraphile | PostGraphile as a Library</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphile, PostGraphQL, Postgres-GraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><link rel="stylesheet" href="/styles.css?t=2019-01-24T15-48-24.891Z"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div tabindex="-1" data-reactroot="" data-reactid="1" data-react-checksum="1182240739"><div class="template-page postgraphile" data-reactid="2"><!-- react-empty: 3 --><header class="header content absolute z-999 w-100" data-reactid="4"><nav class="navbar" data-reactid="5"><div class="container" data-reactid="6"><input type="checkbox" class="navbar-toggler input-reset" id="toggle" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="7"/><div class="nav-controls nested-list-reset " data-reactid="8"><div class="navbar-crosses" data-reactid="9"><span class="line line-1" data-reactid="10"> </span><span class="line line-2" data-reactid="11"> </span><span class="line line-3" data-reactid="12"> </span></div><ul class="navbar-nav flex w-100" data-reactid="13"><li class="navbar-item" data-reactid="14"><a class="nav-link " href="/" data-reactid="15"><span class="home-icon fas fa-home" data-reactid="16"></span><!-- react-text: 17 --> <!-- /react-text --><span class="home" data-reactid="18">Home</span></a></li><!-- react-empty: 19 --><!-- react-empty: 20 --><li class="navbar-item" data-reactid="21"><a class="nav-link " href="/postgraphile/" data-reactid="22">Overview</a></li><li class="navbar-item" data-reactid="23"><a class="nav-link active" href="/postgraphile/introduction/" data-reactid="24">Documentation</a></li><li class="navbar-item" data-reactid="25"><a class="nav-link " href="/sponsor/" data-reactid="26">Sponsor</a></li><li class="navbar-item" data-reactid="27"><a class="hide-when-small nav-link " href="/postgraphile/pricing/" data-reactid="28">Go Pro!</a></li><!-- react-empty: 29 --><!-- react-empty: 30 --><!-- react-empty: 31 --><!-- react-empty: 32 --><!-- react-empty: 33 --><li class="navbar-item ml-auto navbar-item-right" data-reactid="34"><span class="searchbox-container" data-reactid="35"><input id="search-box" placeholder="Search" data-reactid="36"/><span class="fas fa-search searchbox-search" data-reactid="37"></span></span></li><li class="navbar-item navbar-item-right" data-reactid="38"><a class="nav-link " href="/support/" data-reactid="39"><span data-reactid="40"><span class="hide-when-small" data-reactid="41">Support and </span><!-- react-text: 42 -->Services<!-- /react-text --></span></a></li><li class="navbar-item navbar-item-right" data-reactid="43"><a class="nav-link nav-github-link flex items-center" href="https://github.com/graphile/postgraphile" data-reactid="44"><span class="f3 fab fa-github" data-reactid="45"></span><!-- react-text: 46 --> <!-- /react-text --><span class="github" data-reactid="47"><!-- react-text: 48 -->Github<!-- /react-text --><!-- react-text: 49 --> <!-- /react-text --><span class="fas fa-external-link-square-alt" data-reactid="50"></span></span></a></li></ul></div></div></nav></header><div class="page-content" data-reactid="51"><section data-reactid="52"><div class="container" data-reactid="53"><div class="row between-xs" data-reactid="54"><aside class="sidebar col-xs-12 col-md-3 last-xs mt3" data-reactid="55"><section data-reactid="56"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="57"><span data-reactid="58">Overview</span></h4><div class="nested-list-reset" data-reactid="59"><ul class="page-list nav flex-column mb5" data-reactid="60"><li class="f6 lh-copy pv1" data-reactid="61"><a class="nav-link " href="/postgraphile/introduction/" data-reactid="62"><span data-reactid="63">Introduction</span></a></li><li class="f6 lh-copy pv1" data-reactid="64"><a class="nav-link " href="/postgraphile/examples/" data-reactid="65"><span data-reactid="66"><strong>Example Gallery</strong></span></a></li><li class="f6 lh-copy pv1" data-reactid="67"><a class="nav-link " href="/postgraphile/usage/" data-reactid="68"><span data-reactid="69">Usage</span></a><ul class="page-list nav flex-column null" data-reactid="70"><li class="f6 lh-copy pv1" data-reactid="71"><a class="nav-link " href="/postgraphile/usage-cli/" data-reactid="72"><span data-reactid="73">CLI Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="74"><a class="nav-link active" href="/postgraphile/usage-library/" data-reactid="75"><span data-reactid="76">Library Usage</span></a></li><li class="f6 lh-copy pv1" data-reactid="77"><a class="nav-link " href="/postgraphile/usage-schema/" data-reactid="78"><span data-reactid="79">Schema-only Usage</span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="80"><a class="nav-link " href="/postgraphile/performance/" data-reactid="81"><span data-reactid="82">Performance</span></a></li><li class="f6 lh-copy pv1" data-reactid="83"><a class="nav-link " href="/postgraphile/requirements/" data-reactid="84"><span data-reactid="85">Requirements</span></a></li></ul></div></section><section data-reactid="86"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="87"><span data-reactid="88">Operation</span></h4><div class="nested-list-reset" data-reactid="89"><ul class="page-list nav flex-column mb5" data-reactid="90"><li class="f6 lh-copy pv1" data-reactid="91"><a class="nav-link " href="/postgraphile/quick-start-guide/" data-reactid="92"><span data-reactid="93">Quick Start Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="94"><a class="nav-link " href="/postgraphile/namespaces/" data-reactid="95"><span data-reactid="96">Namespaces</span></a></li><li class="f6 lh-copy pv1" data-reactid="97"><a class="nav-link " href="/postgraphile/inflection/" data-reactid="98"><span data-reactid="99">Inflection</span></a></li><li class="f6 lh-copy pv1" data-reactid="100"><a class="nav-link " href="/postgraphile/tables/" data-reactid="101"><span data-reactid="102">Tables</span></a><ul class="page-list nav flex-column null" data-reactid="103"><li class="f6 lh-copy pv1" data-reactid="104"><a class="nav-link " href="/postgraphile/relations/" data-reactid="105"><span data-reactid="106">Relations</span></a></li><li class="f6 lh-copy pv1" data-reactid="107"><a class="nav-link " href="/postgraphile/connections/" data-reactid="108"><span data-reactid="109">Connections</span></a></li><li class="f6 lh-copy pv1" data-reactid="110"><a class="nav-link " href="/postgraphile/filtering/" data-reactid="111"><span data-reactid="112">Filtering</span></a></li><li class="f6 lh-copy pv1" data-reactid="113"><a class="nav-link " href="/postgraphile/crud-mutations/" data-reactid="114"><span data-reactid="115">CRUD Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="116"><a class="nav-link " href="/postgraphile/node-id/" data-reactid="117"><span data-reactid="118">nodeId / id</span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="119"><a class="nav-link " href="/postgraphile/functions/" data-reactid="120"><span data-reactid="121">Functions</span></a><ul class="page-list nav flex-column null" data-reactid="122"><li class="f6 lh-copy pv1" data-reactid="123"><a class="nav-link " href="/postgraphile/computed-columns/" data-reactid="124"><span data-reactid="125">Computed Columns</span></a></li><li class="f6 lh-copy pv1" data-reactid="126"><a class="nav-link " href="/postgraphile/custom-queries/" data-reactid="127"><span data-reactid="128">Custom Queries</span></a></li><li class="f6 lh-copy pv1" data-reactid="129"><a class="nav-link " href="/postgraphile/custom-mutations/" data-reactid="130"><span data-reactid="131">Custom Mutations</span></a></li><li class="f6 lh-copy pv1" data-reactid="132"><a class="nav-link " href="/postgraphile/function-restrictions/" data-reactid="133"><span data-reactid="134">Function Restrictions</span></a></li><li class="f6 lh-copy pv1" data-reactid="135"><a class="nav-link " href="/postgraphile/function-gallery/" data-reactid="136"><span data-reactid="137"><strong>Function Gallery</strong></span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="138"><a class="nav-link " href="/postgraphile/views/" data-reactid="139"><span data-reactid="140">Views</span></a></li><li class="f6 lh-copy pv1" data-reactid="141"><a class="nav-link " href="/postgraphile/postgresql-indexes/" data-reactid="142"><span data-reactid="143">PostgreSQL Indexes</span></a></li><li class="f6 lh-copy pv1" data-reactid="144"><a class="nav-link " href="/postgraphile/security/" data-reactid="145"><span data-reactid="146">Security</span></a></li><li class="f6 lh-copy pv1" data-reactid="147"><a class="nav-link " href="/postgraphile/subscriptions/" data-reactid="148"><span data-reactid="149">Subscriptions</span></a></li><li class="f6 lh-copy pv1" data-reactid="150"><a class="nav-link " href="/postgraphile/reserved-keywords/" data-reactid="151"><span data-reactid="152">Reserved Keywords</span></a></li><li class="f6 lh-copy pv1" data-reactid="153"><a class="nav-link " href="/postgraphile/debugging/" data-reactid="154"><span data-reactid="155">Debugging</span></a></li></ul></div></section><section data-reactid="156"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="157"><span data-reactid="158">Customising</span></h4><div class="nested-list-reset" data-reactid="159"><ul class="page-list nav flex-column mb5" data-reactid="160"><li class="f6 lh-copy pv1" data-reactid="161"><a class="nav-link " href="/postgraphile/smart-comments/" data-reactid="162"><span data-reactid="163">Smart Comments</span></a></li><li class="f6 lh-copy pv1" data-reactid="164"><a class="nav-link " href="/postgraphile/extending/" data-reactid="165"><span data-reactid="166">Schema Plugins</span></a><ul class="page-list nav flex-column null" data-reactid="167"><li class="f6 lh-copy pv1" data-reactid="168"><a class="nav-link " href="/postgraphile/make-add-inflectors-plugin/" data-reactid="169"><span data-reactid="170">makeAddInflectorsPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="171"><a class="nav-link " href="/postgraphile/make-change-nullability-plugin/" data-reactid="172"><span data-reactid="173">makeChangeNullabilityPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="174"><a class="nav-link " href="/postgraphile/make-extend-schema-plugin/" data-reactid="175"><span data-reactid="176">makeExtendSchemaPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="177"><a class="nav-link " href="/postgraphile/make-process-schema-plugin/" data-reactid="178"><span data-reactid="179">makeProcessSchemaPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="180"><a class="nav-link " href="/postgraphile/make-wrap-resolvers-plugin/" data-reactid="181"><span data-reactid="182">makeWrapResolversPlugin</span></a></li><li class="f6 lh-copy pv1" data-reactid="183"><a class="nav-link " href="/postgraphile/make-plugin-by-combining-plugins/" data-reactid="184"><span data-reactid="185">makePluginByCombiningPlugins</span></a></li><li class="f6 lh-copy pv1" data-reactid="186"><a class="nav-link " href="/postgraphile/extending-raw/" data-reactid="187"><span data-reactid="188">Graphile Engine</span></a></li><li class="f6 lh-copy pv1" data-reactid="189"><a class="nav-link " href="/postgraphile/plugin-gallery/" data-reactid="190"><span data-reactid="191"><strong>Plugin Gallery</strong></span></a></li><li class="f6 lh-copy pv1" data-reactid="192"><a class="nav-link " href="/postgraphile/community-plugins/" data-reactid="193"><span data-reactid="194">Community Plugins</span></a></li></ul></li><li class="f6 lh-copy pv1" data-reactid="195"><a class="nav-link " href="/postgraphile/plugins/" data-reactid="196"><span data-reactid="197">Server Plugins</span></a></li></ul></div></section><section data-reactid="198"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="199"><span data-reactid="200">Guides</span></h4><div class="nested-list-reset" data-reactid="201"><ul class="page-list nav flex-column mb5" data-reactid="202"><li class="f6 lh-copy pv1" data-reactid="203"><a class="nav-link " href="/postgraphile/postgresql-schema-design/" data-reactid="204"><span data-reactid="205">PostgreSQL Schema Design</span></a></li><li class="f6 lh-copy pv1" data-reactid="206"><a class="nav-link " href="/postgraphile/evaluating/" data-reactid="207"><span data-reactid="208">Evaluating for your Project</span></a></li><li class="f6 lh-copy pv1" data-reactid="209"><a class="nav-link " href="/postgraphile/best-practices/" data-reactid="210"><span data-reactid="211">Best Practices</span></a></li><li class="f6 lh-copy pv1" data-reactid="212"><a class="nav-link " href="/postgraphile/production/" data-reactid="213"><span data-reactid="214">Production Considerations</span></a></li><li class="f6 lh-copy pv1" data-reactid="215"><a class="nav-link " href="/postgraphile/jwt-guide/" data-reactid="216"><span data-reactid="217">PostGraphile JWT Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="218"><a class="nav-link " href="/postgraphile/jwk-verification/" data-reactid="219"><span data-reactid="220">JWK Verification (e.g. Auth0)</span></a></li><li class="f6 lh-copy pv1" data-reactid="221"><a class="nav-link " href="/postgraphile/default-role/" data-reactid="222"><span data-reactid="223">The Default Role</span></a></li><li class="f6 lh-copy pv1" data-reactid="224"><a class="nav-link " href="/postgraphile/v4-new-features/" data-reactid="225"><span data-reactid="226">v4 Feature Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="227"><a class="nav-link " href="/postgraphile/v3-migration/" data-reactid="228"><span data-reactid="229">v3 → v4 Migration Guide</span></a></li><li class="f6 lh-copy pv1" data-reactid="230"><a class="nav-link " href="/postgraphile/testing-jest/" data-reactid="231"><span data-reactid="232">Testing with Jest</span></a></li></ul></div></section><section data-reactid="233"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="234"><span data-reactid="235">Community</span></h4><div class="nested-list-reset" data-reactid="236"><ul class="page-list nav flex-column mb5" data-reactid="237"><li class="f6 lh-copy pv1" data-reactid="238"><a class="nav-link " href="/postgraphile/community-contributions/" data-reactid="239"><span data-reactid="240">Community Contributions</span></a></li><li class="f6 lh-copy pv1" data-reactid="241"><a class="nav-link " href="/postgraphile/community-chat/" data-reactid="242"><span data-reactid="243">Community Chat</span></a></li><li class="f6 lh-copy pv1" data-reactid="244"><a class="nav-link " href="/postgraphile/code-of-conduct/" data-reactid="245"><span data-reactid="246">Code of Conduct</span></a></li></ul></div></section><section data-reactid="247"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="248"><span data-reactid="249">FAQ</span></h4><div class="nested-list-reset" data-reactid="250"><ul class="page-list nav flex-column mb5" data-reactid="251"><li class="f6 lh-copy pv1" data-reactid="252"><a class="nav-link " href="/postgraphile/introspection/" data-reactid="253"><span data-reactid="254">Introspection?</span></a></li><li class="f6 lh-copy pv1" data-reactid="255"><a class="nav-link " href="/postgraphile/why-nullable/" data-reactid="256"><span data-reactid="257">Why is it nullable?</span></a></li><li class="f6 lh-copy pv1" data-reactid="258"><a class="nav-link " href="/postgraphile/versioning-policy/" data-reactid="259"><span data-reactid="260">Versioning policy?</span></a></li></ul></div></section></aside><div class="col-xs-12 col-md-9 first-xs main-content" data-reactid="261"><div class="row" data-reactid="262"><div class="col-xs-12" style="width:100%;" data-reactid="263"><div class="edit-this-page" style="display:;" data-reactid="264"><a href="https://github.com/graphile/graphile.github.io/edit/develop/src/pages/postgraphile/usage-library.md" data-reactid="265">📝 Suggest improvements to this page</a></div><div data-reactid="266"><h2 id="using-postgraphile-as-a-library"><a href="#using-postgraphile-as-a-library" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using PostGraphile as a Library</h2>
<p>Some people may want to use PostGraphile as a dependency of their current
Node.js projects instead of as a CLI tool. If this is the approach you want to
take then you may either use PostGraphile as an HTTP middleware, or create and
execute queries against a PostGraphile schema using your own custom code. In
this article we will go the former, for the latter see <a href="/postgraphile/usage-schema/">Schema-only
Usage</a>.</p>
<h3 id="http-middleware"><a href="#http-middleware" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTP Middleware</h3>
<p>To mount a PostGraphile instance on your own web server there is an export
<code class="language-text">postgraphile</code> from the <code class="language-text">postgraphile</code> package that can be used as HTTP
middleware for the following HTTP frameworks:</p>
<ul>
<li><a href="http://npmjs.com/connect"><code class="language-text">connect</code></a></li>
<li><a href="https://www.npmjs.com/package/express"><code class="language-text">express</code></a></li>
<li><a href="https://nodejs.org/api/http.html">Vanilla <code class="language-text">http</code></a></li>
</ul>
<p><em>We also have alpha-quality support for <a href="https://www.npmjs.com/package/koa"><code class="language-text">koa</code>
2.0</a>, if you notice any problems <a href="https://www.github.com/graphile/postgraphile">please raise a GitHub issue about it.</a></em></p>
<p>To use PostGraphile with <code class="language-text">express</code>, for instance, just do the following:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> postgraphile <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"postgraphile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">postgraphile</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span> <span class="token operator">||</span> <span class="token string">"postgres:///"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>Or to use it with the built-in <code class="language-text">http</code> module:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> postgraphile <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"postgraphile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http
  <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token function">postgraphile</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span> <span class="token operator">||</span> <span class="token string">"postgres:///"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<h4 id="api-postgraphilepgconfig-schemaname-options"><a href="#api-postgraphilepgconfig-schemaname-options" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API: <code class="language-text">postgraphile(pgConfig, schemaName, options)</code></h4>
<p>The <code class="language-text">postgraphile</code> middleware factory function takes three arguments, all of which are optional. The below options are valid for <tt>postgraphile@<!-- LIBRARY_VERSION_BEGIN -->4.3.1<!-- LIBRARY_VERSION_END --></tt>.</p>
<ul>
<li><strong><code class="language-text">pgConfig</code></strong>: An object or string that will be passed to the <a href="https://www.npmjs.com/pg"><code class="language-text">pg</code></a> library and used to connect to a PostgreSQL backend, OR a pg.Pool to use.</li>
<li><strong><code class="language-text">schemaName</code></strong>: A string, or array of strings, which specifies the PostgreSQL schema(s) you to expose via PostGraphile; defaults to 'public'</li>
<li>
<p><strong><code class="language-text">options</code></strong>: An object containing other miscellaneous options. Options include: <!-- LIBRARY_DOCBLOCK_BEGIN --></p>
<ul>
<li><code class="language-text">watchPg</code>: When true, PostGraphile will update the GraphQL API whenever your database schema changes. This feature requires some changes to your database in the form of the <a href="https://github.com/graphile/graphile-engine/blob/master/packages/graphile-build-pg/res/watch-fixtures.sql"><code class="language-text">postgraphile_watch</code></a> schema; PostGraphile will try to add this itself but requires DB superuser privileges to do so. If PostGraphile can't install it, you can do so manually. PostGraphile will not drop the schema when it exits, to remove it you can execute: <code class="language-text">DROP SCHEMA postgraphile_watch CASCADE;</code></li>
<li><code class="language-text">pgDefaultRole</code>: The default Postgres role to use. If no role was provided in a provided JWT token, this role will be used.</li>
<li><code class="language-text">dynamicJson</code>: By default, JSON and JSONB fields are presented as strings (JSON encoded) from the GraphQL schema. Setting this to <code class="language-text">true</code> (recommended) enables raw JSON input and output, saving the need to parse / stringify JSON manually.</li>
<li><code class="language-text">setofFunctionsContainNulls</code>: If none of your <code class="language-text">RETURNS SETOF compound_type</code> functions mix NULLs with the results then you may set this true to reduce the nullables in the GraphQL schema.</li>
<li><code class="language-text">classicIds</code>: Enables classic ids for Relay support. Instead of using the field name <code class="language-text">nodeId</code> for globally unique ids, PostGraphile will instead use the field name <code class="language-text">id</code> for its globally unique ids. This means that table <code class="language-text">id</code> columns will also get renamed to <code class="language-text">rowId</code>.</li>
<li><code class="language-text">disableDefaultMutations</code>: Setting this to <code class="language-text">true</code> will prevent the creation of the default mutation types &#x26; fields. Database mutation will only be possible through Postgres functions.</li>
<li><code class="language-text">ignoreRBAC</code>: Set false (recommended) to exclude fields, queries and mutations that the user isn't permitted to access from the generated GraphQL schema; set this option true to skip these checks and create GraphQL fields and types for everything. The default is <code class="language-text">true</code>, in v5 the default will change to <code class="language-text">false</code>.</li>
<li><code class="language-text">ignoreIndexes</code>: Set false (recommended) to exclude filters, orderBy, and relations that would be expensive to access due to missing indexes. Changing this from true to false is a breaking change, but false to true is not, so we recommend you start with it set to <code class="language-text">false</code>. The default is <code class="language-text">true</code>, in v5 the default may change to <code class="language-text">false</code>.</li>
<li><code class="language-text">includeExtensionResources</code>: By default, tables and functions that come from extensions are excluded from the generated GraphQL schema as general applications don't need them to be exposed to the end user. You can use this flag to include them in the generated schema (not recommended).</li>
<li><code class="language-text">showErrorStack</code>: Enables adding a <code class="language-text">stack</code> field to the error response. Can be either the boolean <code class="language-text">true</code> (which results in a single stack string) or the string <code class="language-text">json</code> (which causes the stack to become an array with elements for each line of the stack). Recommended in development, not recommended in production.</li>
<li><code class="language-text">extendedErrors</code>: Extends the error response with additional details from the Postgres error. Can be any combination of <code class="language-text">[&#39;hint&#39;, &#39;detail&#39;, &#39;errcode&#39;]</code>. Default is <code class="language-text">[]</code>.</li>
<li><code class="language-text">handleErrors</code>: Enables ability to modify errors before sending them down to the client. Optionally can send down custom responses. If you use this then <code class="language-text">showErrorStack</code> and <code class="language-text">extendedError</code> may have no effect.</li>
<li><code class="language-text">appendPlugins</code>: An array of <a href="/graphile-build/plugins/">Graphile Engine</a> schema plugins to load after the default plugins.</li>
<li><code class="language-text">prependPlugins</code>: An array of <a href="/graphile-build/plugins/">Graphile Engine</a> schema plugins to load before the default plugins (you probably don't want this).</li>
<li><code class="language-text">replaceAllPlugins</code>: The full array of <a href="/graphile-build/plugins/">Graphile Engine</a> schema plugins to use for schema generation (you almost definitely don't want this!).</li>
<li><code class="language-text">skipPlugins</code>: An array of <a href="/graphile-build/plugins/">Graphile Engine</a> schema plugins to skip.</li>
<li><code class="language-text">readCache</code>: A file path string. Reads cached values from local cache file to improve startup time (you may want to do this in production).</li>
<li><code class="language-text">writeCache</code>: A file path string. Writes computed values to local cache file so startup can be faster (do this during the build phase).</li>
<li><code class="language-text">exportJsonSchemaPath</code>: Enables saving the detected schema, in JSON format, to the given location. The directories must exist already, if the file exists it will be overwritten.</li>
<li><code class="language-text">exportGqlSchemaPath</code>: Enables saving the detected schema, in GraphQL schema format, to the given location. The directories must exist already, if the file exists it will be overwritten.</li>
<li><code class="language-text">graphqlRoute</code>: The endpoint the GraphQL executer will listen on. Defaults to <code class="language-text">/graphql</code>.</li>
<li><code class="language-text">graphiqlRoute</code>: The endpoint the GraphiQL query interface will listen on (<strong>NOTE:</strong> GraphiQL will not be enabled unless the <code class="language-text">graphiql</code> option is set to <code class="language-text">true</code>). Defaults to <code class="language-text">/graphiql</code>.</li>
<li><code class="language-text">externalUrlBase</code>: If you are using watch mode, or have enabled GraphiQL, and you either mount PostGraphile under a path, or use PostGraphile behind some kind of proxy that puts PostGraphile under a subpath (or both!) then you must specify this setting so that PostGraphile can figure out it's external URL. (e.g. if you do <code class="language-text">app.use(&#39;/path/to&#39;, postgraphile(...))</code>), which is not officially supported, then you should pass <code class="language-text">externalUrlBase: &#39;/path/to&#39;</code>.) This setting should never end in a slash (<code class="language-text">/</code>). To specify that the external URL is the expected one, either omit this setting or set it to the empty string <code class="language-text">&#39;&#39;</code>.</li>
<li><code class="language-text">graphiql</code>: Set this to <code class="language-text">true</code> to enable the GraphiQL interface.</li>
<li><code class="language-text">enhanceGraphiql</code>: Set this to <code class="language-text">true</code> to add some enhancements to GraphiQL; intended for development usage only.</li>
<li><code class="language-text">enableCors</code>: Enables some generous CORS settings for the GraphQL endpoint. There are some costs associated when enabling this, if at all possible try to put your API behind a reverse proxy.</li>
<li><code class="language-text">bodySizeLimit</code>: Set the maximum size of HTTP request bodies that can be parsed (default 100kB). The size can be given as a human-readable string, such as '200kB' or '5MB' (case insensitive).</li>
<li><code class="language-text">enableQueryBatching</code>: [Experimental] Enable the middleware to process multiple GraphQL queries in one request.</li>
<li><code class="language-text">jwtSecret</code>: The secret for your JSON web tokens. This will be used to verify tokens in the <code class="language-text">Authorization</code> header, and signing JWT tokens you return in procedures.</li>
<li><code class="language-text">jwtVerifyOptions</code>: Options with which to perform JWT verification - see <a href="https://github.com/auth0/node-jsonwebtoken#jwtverifytoken-secretorpublickey-options-callback">https://github.com/auth0/node-jsonwebtoken#jwtverifytoken-secretorpublickey-options-callback</a> If 'audience' property is unspecified, it will default to ['postgraphile']; to prevent audience verification set it explicitly to null.</li>
<li><code class="language-text">jwtRole</code>: A comma separated list of strings that give a path in the jwt from which to extract the postgres role. If none is provided it will use the key <code class="language-text">role</code> on the root of the jwt.</li>
<li><code class="language-text">jwtPgTypeIdentifier</code>: The Postgres type identifier for the compound type which will be signed as a JWT token if ever found as the return type of a procedure. Can be of the form: <code class="language-text">my_schema.my_type</code>. You may use quotes as needed: <code class="language-text">&quot;my-special-schema&quot;.my_type</code>.</li>
<li><code class="language-text">jwtAudiences</code>: [DEPRECATED] The audience to use when verifing the JWT token. Deprecated, use <code class="language-text">jwtVerifyOptions.audience</code> instead.</li>
<li><code class="language-text">legacyRelations</code>: Some one-to-one relations were previously detected as one-to-many - should we export 'only' the old relation shapes, both new and old but mark the old ones as 'deprecated' (default), or 'omit' (recommended) the old relation shapes entirely.</li>
<li><code class="language-text">legacyJsonUuid</code>: ONLY use this option if you require the v3 typenames 'Json' and 'Uuid' over 'JSON' and 'UUID'.</li>
<li><code class="language-text">disableQueryLog</code>: Turns off GraphQL query logging. By default PostGraphile will log every GraphQL query it processes along with some other information. Set this to <code class="language-text">true</code> (recommended in production) to disable that feature.</li>
<li><code class="language-text">pgSettings</code>: A plain object specifying custom config values to set in the PostgreSQL transaction (accessed via <code class="language-text">current_setting(&#39;my.custom.setting&#39;)</code>) <strong>or</strong> an (optionally asynchronous) function which will return the same (or a Promise to the same) based on the incoming web request (e.g. to extract session data).</li>
<li><code class="language-text">additionalGraphQLContextFromRequest</code>: Some Graphile Engine schema plugins may need additional information available on the <code class="language-text">context</code> argument to the resolver - you can use this function to provide such information based on the incoming request - you can even use this to change the response [experimental], e.g. setting cookies.</li>
<li><code class="language-text">pluginHook</code>: [experimental] Plugin hook function, enables functionality within PostGraphile to be expanded with plugins. Generate with <code class="language-text">makePluginHook(plugins)</code> passing a list of plugin objects.</li>
<li><code class="language-text">simpleCollections</code>: Should we use relay pagination, or simple collections? "omit" (default) - relay connections only, "only" (not recommended) - simple collections only (no Relay connections), "both" - both.</li>
<li><code class="language-text">queryCacheMaxSize</code>: Max query cache size in MBs of queries. Default, 50MB.</li>
</ul>
</li>
</ul>
<!-- LIBRARY_DOCBLOCK_END -->
<p>The following options are not part of PostGraphile core, but are available from the Supporter and/or Pro plugins - see <a href="/postgraphile/pricing/">Go Pro!</a> for more information.</p>
<ul>
<li>
<p><strong><code class="language-text">options</code></strong>:</p>
<ul>
<li><code class="language-text">simpleSubscriptions</code>: <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a> ⚡️[experimental] set this to <code class="language-text">true</code> to add simple subscription support</li>
<li><code class="language-text">subscriptionAuthorizationFunction [fn]</code> <a href='/postgraphile/pricing/' class="plan-supporter"><span class='first-letter'>s</span><span class='rest'>upporter</span></a> ⚡️[experimental] set this to the name (excluding arguments/parentheses) of a PG function to call to check user is allowed to subscribe</li>
<li><code class="language-text">readOnlyConnection</code> <a href='/postgraphile/pricing/' class="plan-pro"><span class='first-letter'>p</span><span class='rest'>ro</span></a> ⚡️[experimental] set this to a PostgreSQL connection string to use for read-only queries (i.e. not mutations)</li>
<li><code class="language-text">defaultPaginationCap</code> <a href='/postgraphile/pricing/' class="plan-pro"><span class='first-letter'>p</span><span class='rest'>ro</span></a> ⚡️[experimental] integer, ensure all connections have first/last specified and are no large than this value (default: 50), set to -1 to disable; override via smart comment <code class="language-text">@paginationCap 50</code></li>
<li><code class="language-text">graphqlDepthLimit</code> <a href='/postgraphile/pricing/' class="plan-pro"><span class='first-letter'>p</span><span class='rest'>ro</span></a> ⚡️[experimental] integer, validate GraphQL queries are no deeper than the specified int (default: 16), set to -1 to disable</li>
<li><code class="language-text">graphqlCostLimit</code> <a href='/postgraphile/pricing/' class="plan-pro"><span class='first-letter'>p</span><span class='rest'>ro</span></a> ⚡️[experimental] integer, only allows queries with a computed cost below the specified int (default: 1000), set to -1 to disable</li>
<li><code class="language-text">exposeGraphQLCost</code> <a href='/postgraphile/pricing/' class="plan-pro"><span class='first-letter'>p</span><span class='rest'>ro</span></a> boolean, if true (default) then the calculated query cost will be exposed on the resulting payload</li>
</ul>
</li>
</ul>
<h3 id="exposing-http-request-data-to-postgresql"><a href="#exposing-http-request-data-to-postgresql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exposing HTTP request data to PostgreSQL</h3>
<h4 id="pgsettings-function"><a href="#pgsettings-function" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">pgSettings</code> function</h4>
<p>Using the <code class="language-text">pgSettings</code> functionality mentioned above you can extend the data
made available through <code class="language-text">current_setting(...)</code> within PostgreSQL. Instead of
passing an object you can pass an (optionally asynchronous) function which will
be executed for each request, and the results merged in with the other settings
PostGraphile automatically adds to the request.</p>
<p>For example:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token function">postgraphile</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span> schemaName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  pgSettings<span class="token punctuation">:</span> <span class="token keyword">async</span> req <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'user.id'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>passport<span class="token punctuation">.</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token string">'http.headers.x-something'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-something'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token string">'http.method'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token string">'http.url'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
      </div>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">function</span> get_x_something<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">text</span> <span class="token keyword">as</span> $$
  <span class="token keyword">select</span> current_setting<span class="token punctuation">(</span><span class="token string">'http.headers.x-something'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::<span class="token keyword">text</span><span class="token punctuation">;</span>
$$ <span class="token keyword">language</span> <span class="token keyword">sql</span> stable<span class="token punctuation">;</span></code></pre>
      </div>
<p>Everything returned by <code class="language-text">pgSettings</code> is applied to the current session with
<code class="language-text">set_config($key, $value, true)</code>; note that <code class="language-text">set_config</code> only supports string
values so it is best to only feed <code class="language-text">pgSettings</code> string values (we'll convert other
values using the <code class="language-text">String</code> constructor function, which may not have the effect
you intend.</p>
<p>You can use <code class="language-text">pgSettings</code> to define variables that your Postgres
functions/policies depend on, or to tweak internal Postgres settings. When
adding variables for your own usage, the keys <strong>must</strong> contain either one or
two period (<code class="language-text">.</code>) characters, and the prefix (the bit before the first period)
must not be used by any Postgres extension. Variables without periods will be
interpreted as internal Postgres settings, such as <code class="language-text">role</code>, and will be applied
by Postgres. All settings are automatically reset when the transaction
completes. Here's an example of switching the user into the Postgres 'visitor'
role, and applying the application setting <code class="language-text">jwt.claims.user_id</code>:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token function">postgraphile</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span> schemaName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  pgSettings<span class="token punctuation">:</span> <span class="token keyword">async</span> req <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'visitor'</span><span class="token punctuation">,</span>
    <span class="token string">'jwt.claims.user_id'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
      </div>
<div class="gatsby-highlight">
      <pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> get_current_user<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">TEXT</span> <span class="token keyword">AS</span> $$
  <span class="token keyword">SELECT</span> <span class="token keyword">current_user</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> <span class="token keyword">SQL</span> STABLE<span class="token punctuation">;</span></code></pre>
      </div>
<div class="gatsby-highlight">
      <pre class="language-graphql"><code class="language-graphql"><span class="token punctuation">{</span>
  getCurrentUser <span class="token comment"># returns visitor</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<!-- TODO: verify the above works. -->
<!-- TODO: move this to its own article? -->
<h3 id="mounting-postgraphile-middleware-under-a-subpath"><a href="#mounting-postgraphile-middleware-under-a-subpath" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mounting PostGraphile middleware under a subpath</h3>
<p>This isn't officially supported; however it should work in most cases. If
you're mounting under a subpath in express then <code class="language-text">app.use(&quot;/path/to&quot;, postgraphile())</code> should work automatically without requiring any options. If
you're using an external proxy then you must supply the base URL so that
PostGraphile knows where to tell the browser the assets are located. This is
all so that PostGraphile can reference different parts of itself correctly,
such as the location for the watch stream to put in the header, or the
GraphQL endpoint for GraphiQL to connect to.</p>
<p>A really complex use case of this would be this example:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token comment">// Assuming you combine both Express subpath AND an external</span>
<span class="token comment">// proxy which mounts your express app at `/myproxypath`, you</span>
<span class="token comment">// should provide options like this:</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token string">"/path/to"</span><span class="token punctuation">,</span>
  <span class="token function">postgraphile</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> schemas<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    externalUrlBase<span class="token punctuation">:</span> <span class="token string">"/myproxypath/path/to"</span><span class="token punctuation">,</span>
    graphqlRoute<span class="token punctuation">:</span> <span class="token string">"/graphql"</span><span class="token punctuation">,</span>
    graphiql<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    graphiqlRoute<span class="token punctuation">:</span> <span class="token string">"/graphiql"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Then you can load GraphiQL at `/myproxypath/path/to/graphiql`</span>
<span class="token comment">// and it will know to connect to GraphQL at</span>
<span class="token comment">// `/myproxypath/path/to/graphql`</span></code></pre>
      </div>
<h3 id="composing-postgraphile-middleware-with-other-middleware"><a href="#composing-postgraphile-middleware-with-other-middleware" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Composing PostGraphile middleware with other middleware</h3>
<p>Some use cases might require to mount other middleware before PostGraphile, for instance if requests to the GraphQL endpoint should be subject to an additional authorization / authentication mechanism.</p>
<p>With express, such a composition can be done like the following:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">// Example middleware, does nothing
function authMiddleware(req, res, next) {
  //...
  next();
}
// Mount middleware on the GraphQL endpoint
app.use(&#39;/graphql&#39;, authMiddleware);
// Mount PostGraphile after this middleware
app.use(postgraphile(connectionString, schema, options));</code></pre>
      </div>
<p>This example uses Express, but a similar approach is possible with other Node.js webservers.</p></div></div><br data-reactid="267"/><br data-reactid="268"/><div class="col-xs-12 mt3 mb5" data-reactid="269"><div class="row between-xs" data-reactid="270"><div class="col-xs-6" data-reactid="271"><a class="" href="/postgraphile/usage-cli/" data-reactid="272"><span class="fas fa-fw fa-arrow-left" data-reactid="273"></span><!-- react-text: 274 --> <!-- /react-text --><span data-reactid="275">CLI Usage</span></a></div><div class="col-xs-6 tr" data-reactid="276"><a class="" href="/postgraphile/usage-schema/" data-reactid="277"><span data-reactid="278">Schema-only Usage</span><!-- react-text: 279 --> <!-- /react-text --><span class="fas fa-fw fa-arrow-right" data-reactid="280"></span></a></div></div></div></div></div></div></div></section><section class="mailinglist" data-reactid="281"><div class="container" data-reactid="282"><div class="row" data-reactid="283"><div class="col-xs-12" data-reactid="284"><div class="hero-block" data-reactid="285"><h3 data-reactid="286"><!-- react-text: 287 -->Questions, comments or feedback?<!-- /react-text --><br data-reactid="288"/><!-- react-text: 289 -->Email<!-- /react-text --><!-- react-text: 290 --> <!-- /react-text --><a href="mailto:info@graphile.org?subject=Documentation%20question/comment/feedback:)" data-reactid="291">info@graphile.org</a></h3><form action="//graphile.us16.list-manage.com/subscribe/post?u=d103f710cf00a9273b55e8e9b&amp;id=c3a9eb5c4e" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="" data-reactid="292"><div id="mc_embed_signup_scroll" class="center hero-block" data-reactid="293"><p data-reactid="294">Keep up to date on Graphile and PostGraphile features/changes. Subscribe to our occasional announcements newsletter:</p><div class="mc-field-group form-inline justify-content-center" data-reactid="295"><div class="form-group" data-reactid="296"><div class="mb2" data-reactid="297"><label class="label--small" for="mce-EMAIL" data-reactid="298">Email address:</label></div><input type="email" autocapitalize="off" autocomplete="off" autocorrect="off" class="input-text mb0-ns mb1" id="mce-EMAIL" name="EMAIL" spellcheck="false" value="" data-reactid="299"/><div style="position:absolute;left:-5000px;" aria-hidden="true" data-reactid="300"><input type="text" name="b_d103f710cf00a9273b55e8e9b_c3a9eb5c4e" tabindex="-1" value="" data-reactid="301"/></div><input type="submit" class="button--solid" id="mc-embedded-subscribe" name="subscribe" value="Subscribe" data-reactid="302"/></div><div id="mce-responses" class="clear" data-reactid="303"><div class="response" id="mce-error-response" style="display:none;" data-reactid="304"></div><div class="response" id="mce-success-response" style="display:none;" data-reactid="305"></div></div></div></div></form></div></div></div></div></section></div><footer class="bg-white pv5 bt b--black f6 lh-copy" data-reactid="306"><div class="container" data-reactid="307"><div class="row" data-reactid="308"><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="309"><h6 data-reactid="310">PostGraphile</h6><ul data-reactid="311"><li data-reactid="312"><a href="/postgraphile/introduction/" data-reactid="313">Introduction</a></li><li data-reactid="314"><a href="/postgraphile/security/" data-reactid="315">Security</a></li><li data-reactid="316"><a href="/postgraphile/extending/" data-reactid="317">Extending</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="318"><h6 data-reactid="319">Graphile Engine</h6><ul data-reactid="320"><li data-reactid="321"><a href="/graphile-build/" data-reactid="322">About</a></li><li data-reactid="323"><a href="/graphile-build/getting-started/" data-reactid="324">Getting Started</a></li><li data-reactid="325"><a href="/graphile-build/plugins/" data-reactid="326">Plugins</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset" data-reactid="327"><h6 data-reactid="328">Resources</h6><ul data-reactid="329"><li data-reactid="330"><a href="/news/" data-reactid="331"><i class="fas fa-bullhorn" data-reactid="332"></i><!-- react-text: 333 --> News<!-- /react-text --></a></li><li data-reactid="334"><a href="https://github.com/graphile" data-reactid="335"><i class="fab fa-github" data-reactid="336"></i><!-- react-text: 337 --> GitHub<!-- /react-text --></a></li><li data-reactid="338"><a href="http://discord.gg/graphile" data-reactid="339"><i class="fab fa-discord" data-reactid="340"></i><!-- react-text: 341 --> Chat (discord)<!-- /react-text --></a></li><li data-reactid="342"><a href="https://twitter.com/graphilehq" data-reactid="343"><i class="fab fa-twitter" data-reactid="344"></i><!-- react-text: 345 --> Twitter<!-- /react-text --></a></li><li data-reactid="346"><a href="/news/press-kit/" data-reactid="347"><i class="fas fa-file-archive" data-reactid="348"></i><!-- react-text: 349 --> Logos/etc<!-- /react-text --></a></li></ul></div><div class="col-xs-12 col-md-offset-1 col-md-5" data-reactid="350"><h6 data-reactid="351">About</h6><!-- react-text: 352 -->PostGraphile and Graphile Build are crowd-funded Open Source Software, developed and maintained primarily by<!-- /react-text --><!-- react-text: 353 --> <!-- /react-text --><a href="https://twitter.com/benjie" data-reactid="354">@Benjie</a><!-- react-text: 355 --> with the help of the community.<!-- /react-text --><br data-reactid="356"/><br data-reactid="357"/><!-- react-text: 358 -->You can support the projects via<!-- /react-text --><!-- react-text: 359 --> <!-- /react-text --><a href="/sponsor/" data-reactid="360">sponsorship</a><!-- react-text: 361 -->, by<!-- /react-text --><!-- react-text: 362 --> <!-- /react-text --><a href="/postgraphile/pricing/" data-reactid="363">going Pro</a><!-- react-text: 364 -->, or by paying for<!-- /react-text --><!-- react-text: 365 --> <!-- /react-text --><a href="/support/" data-reactid="366">Professional Services</a><!-- react-text: 367 -->. Your support is gratefully received 🙏<!-- /react-text --><br data-reactid="368"/><br data-reactid="369"/><!-- react-text: 370 -->This site is copyright © Benjie Gillam <!-- /react-text --><!-- react-text: 371 -->2019<!-- /react-text --><!-- react-text: 372 -->. Design and logos copyright © Benjie Gillam and Jof Arnold<!-- /react-text --><!-- react-text: 373 --> <!-- /react-text --><!-- react-text: 374 -->2019<!-- /react-text --><!-- react-text: 375 -->.<!-- /react-text --><br data-reactid="376"/><br data-reactid="377"/><!-- react-text: 378 -->Corrections and contributions to this website are gratefully received via<!-- /react-text --><!-- react-text: 379 --> <!-- /react-text --><a href="https://github.com/graphile/graphile.github.io" data-reactid="380">its GitHub repository</a><!-- react-text: 381 -->.<!-- /react-text --><br data-reactid="382"/><br data-reactid="383"/><!-- react-text: 384 -->PostGraphile was <!-- /react-text --><a href="/history/" data-reactid="385">originally authored</a><!-- react-text: 386 --> as PostGraphQL by<!-- /react-text --><!-- react-text: 387 --> <!-- /react-text --><a href="https://twitter.com/calebmer" data-reactid="388">Caleb Meredith</a><!-- react-text: 389 -->.<!-- /react-text --></div></div></div></footer></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-85aa6ac030e1396efe54.js","96961042003272":"component---src-templates-page-js-44912100fe5a923703fa.js","59784799166159":"component---src-templates-marketing-js-40e199c898662c5efde7.js","60335399758886":"path----557518bd178906f8d58a.js","45788430371641":"path---history-01b2cde14baec0163b9e.js","88641327033989":"path---sponsor-da8d42de01cff570af29.js","192423053311925":"path---graphile-build-pg-security-c2a3c13ff51c9b422135.js","194808618595402":"path---graphile-build-pg-settings-5256620d73d6c2115682.js","208863975630277":"path---news-be582336c54ed6597134.js","219633165437141":"path---news-postgraphile-version-4-1-8c19c22da57dc5522988.js","143510993521902":"path---news-postgraphile-version-4-aea54e95d1ed6902a77f.js","72313494074136":"path---news-press-kit-f560f192e7cf2306efbf.js","128602041518144":"path---graphile-build-all-hooks-0d015d1ced05530292a8.js","64023390553510":"path---graphile-build-build-object-c0d3534b8867d8fdeb83.js","69504633912515":"path---graphile-build-context-object-3916935fc546f835cedc.js","125892818282768":"path---graphile-build-default-plugins-8ebb82046c39d6021631.js","109947277077173":"path---graphile-build-getting-started-da6de9c38b85a7ac0c80.js","16210746157911":"path---graphile-build-graphile-build-118e4fde376a262dbff1.js","57552969484094":"path---graphile-build-hooks-528d74d00f6ce46e049e.js","109627700230002":"path---graphile-build-f41a9655e0ee6494c60a.js","36474596372704":"path---graphile-build-omitting-plugins-17963f10691fb45afd46.js","276285638780302":"path---graphile-build-plugin-options-065ca347fa058fae6226.js","136546493962690":"path---graphile-build-plugins-25e85685dd7f2c7e0b5f.js","277477532944301":"path---graphile-build-schema-builder-c05318b732e310e4727d.js","141666846945901":"path---support-c66547754a3d1669e3ce.js","47492079316131":"path---postgraphile-best-practices-26410f83db6da2615f6d.js","235145966638131":"path---postgraphile-code-of-conduct-cbf6fe502dc04e0e96d8.js","114781403929568":"path---postgraphile-community-chat-c18f86dd3ca2d460a77a.js","86394197680347":"path---postgraphile-community-contributions-2427590a509bc0363c2e.js","216163489569211":"path---postgraphile-community-plugins-8a13e9c387cd519616de.js","99411096849217":"path---postgraphile-computed-columns-1dda27264903ad727d2f.js","245194823331250":"path---postgraphile-connections-97384e74041638af1895.js","226259727392765":"path---postgraphile-crud-mutations-431395eea2ab472bdc57.js","209456356109321":"path---postgraphile-custom-mutations-9e9c973107097359dc01.js","262226386268176":"path---postgraphile-custom-queries-6c6bc369b0bf6f49e0ef.js","58450730530065":"path---postgraphile-debugging-bef0c427692d23e26ca4.js","183024611244872":"path---postgraphile-default-role-045e0e88b22d3a3c95d1.js","46110498460401":"path---postgraphile-evaluating-d9b9f27685ec0d7c8f0e.js","235675790195762":"path---postgraphile-examples-329d051b43f79db4b7a2.js","1465359564156":"path---postgraphile-extending-ed549ae45ba6f27ec960.js","29661158995595":"path---postgraphile-filtering-f1dfa97a48f8794b125b.js","101562502586227":"path---postgraphile-function-gallery-171e4603be9342cbd23c.js","101463202308976":"path---postgraphile-function-restrictions-98a1c089da72f9dfb7f4.js","34445096275681":"path---postgraphile-inflection-44625b2122b1f6a77237.js","231292683096477":"path---postgraphile-introduction-32804a05bbf5f9a38970.js","33982096820675":"path---postgraphile-introspection-f422f8449b5f82e0591c.js","131593726388413":"path---postgraphile-jwk-verification-678a52f664e8a47abfef.js","64254551156649":"path---postgraphile-make-add-inflectors-plugin-5065ee8d08e6114f6567.js","217512476184238":"path---postgraphile-jwt-guide-57a1e7cbb13da54c83aa.js","161082936966388":"path---postgraphile-make-change-nullability-plugin-14e80fd8916d7bdee6e0.js","258216963914742":"path---postgraphile-make-plugin-by-combining-plugins-025ac968e0297682e814.js","81450269707069":"path---postgraphile-make-process-schema-plugin-2927a33517d30f87445f.js","183453616913285":"path---postgraphile-make-wrap-resolvers-plugin-a820c8f1557831f93391.js","49645441935291":"path---postgraphile-namespaces-1e5dd3f1682021a68fa1.js","206205697905610":"path---postgraphile-node-id-854ed9bd758c6fb2c977.js","245838197689590":"path---postgraphile-performance-1859a0474acb00af1e58.js","193154730806080":"path---postgraphile-plugin-gallery-9d119a8fd218290510ce.js","34112019379484":"path---postgraphile-plugins-3e184dfdf957aafa1416.js","43306645800525":"path---postgraphile-postgresql-indexes-e70ebc49d459909f2761.js","257659440118484":"path---postgraphile-procedures-0c365d4eedcd72cda817.js","20524195157075":"path---postgraphile-quick-start-guide-9d524b7a882e01369b0f.js","136696082986067":"path---postgraphile-relations-27dfe91a94c8f1034a53.js","187294999324209":"path---postgraphile-requirements-326e1a087a7bb2dfc9eb.js","126695865748518":"path---postgraphile-reserved-keywords-453a49267ee46f8407b9.js","143935096069691":"path---postgraphile-security-dac35dd7176ecf2035da.js","244450434420656":"path---postgraphile-tables-43e3336bdb601ffe0164.js","247601703930759":"path---postgraphile-usage-fee00eca33179c7c37ba.js","270428963090724":"path---postgraphile-versioning-policy-a670aa3d7189b5da0098.js","71082389294910":"path---postgraphile-views-2ebe70bc9aa76834b82a.js","156260474427399":"path---postgraphile-why-nullable-a17f63568947b9e784a7.js","76338124382236":"path---graphile-build-look-ahead-d322cce77b6d331e59af.js","187503077063819":"path---postgraphile-extending-raw-af215c96015760f5d550.js","202678300341359":"path---postgraphile-functions-e7c4dab67967045c2679.js","30601655320255":"path---postgraphile-make-extend-schema-plugin-749b8262d3453107789d.js","85182451526728":"path---postgraphile-pricing-de5f9b91c4197d32ab87.js","163587040327238":"path---postgraphile-production-bb98ba68d73c348d55e1.js","27297302318019":"path---postgraphile-smart-comments-b5c712c8f22567efc0e7.js","174583816914262":"path---postgraphile-testing-jest-3a0bdf364c5e98c27b44.js","3265662318058":"path---postgraphile-usage-cli-f628dd4b56930762e83b.js","272066437984048":"path---postgraphile-usage-schema-50dfbd1b252c49b8fd0d.js","87638492893048":"path---postgraphile-v-3-migration-53c729c31d7bb14f2e7b.js","57656932303775":"path---postgraphile-v-4-new-features-643820b8973c79f46dea.js","142629428675168":"path---index-9af5238ba8a8966def21.js","48764759135427":"path---postgraphile-41f8bb3e02937bae057e.js","112985368742066":"path---postgraphile-subscriptions-8ff68a2f3895027fc271.js","148070795768796":"path---postgraphile-usage-library-fda47dd3f196409e5294.js","17839233601159":"path---postgraphile-postgresql-schema-design-4b52ff926377d5cc1e1e.js","114276838955818":"component---src-layouts-index-js-ace7914a8fea060c15f6.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-e9c5ebe9f9d03df65cb6.js","/app-85aa6ac030e1396efe54.js","/path---postgraphile-usage-library-fda47dd3f196409e5294.js","/component---src-templates-page-js-44912100fe5a923703fa.js","/component---src-layouts-index-js-ace7914a8fea060c15f6.js"])/*]]>*/</script><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script></body></html>