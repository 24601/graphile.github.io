<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNK4X8M');</script><script src="https://use.fontawesome.com/c72bfae6f9.js"></script><link rel="preload" href="/component---src-layouts-index-js-5b458069f989776282f8.js" as="script"/><link rel="preload" href="/component---src-templates-page-js-2afc0beefd3a360b7a68.js" as="script"/><link rel="preload" href="/path---graphile-build-pg-security-96c09579a81e1e0dbb0d.js" as="script"/><link rel="preload" href="/app-a4b82654ce794f4925ab.js" as="script"/><link rel="preload" href="/commons-097a3c7bcbdcfe23a531.js" as="script"/><title data-react-helmet="true">Graphile | Security</title><meta data-react-helmet="true" name="description" content="Utilities to build powerful and performant GraphQL APIs"/><meta data-react-helmet="true" name="keywords" content="GraphQL, API, Graph, PostgreSQL, PostGraphile, PostGraphQL, Postgres-GraphQL, server, plugins, introspection, reflection"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><link rel="stylesheet" href="/styles.css?t=2018-03-02T12-04-53.665Z"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNK4X8M" height="0" width="0" style="display:none;visibility:hidden;"></iframe></noscript><div id="___gatsby"><div tabindex="-1" data-reactroot="" data-reactid="1" data-react-checksum="-35788216"><div class="template-page" data-reactid="2"><!-- react-empty: 3 --><header class="header content absolute z-999 w-100" data-reactid="4"><nav class="navbar" data-reactid="5"><div class="container" data-reactid="6"><input type="checkbox" class="navbar-toggler input-reset" id="toggle" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" data-reactid="7"/><div class="nav-controls nested-list-reset " data-reactid="8"><div class="navbar-crosses" data-reactid="9"><span class="line line-1" data-reactid="10"> </span><span class="line line-2" data-reactid="11"> </span><span class="line line-3" data-reactid="12"> </span></div><ul class="navbar-nav flex w-100" data-reactid="13"><li class="navbar-item" data-reactid="14"><a class="nav-link " href="/" data-reactid="15"><span class="home-icon fa fa-home" data-reactid="16"></span><!-- react-text: 17 --> <!-- /react-text --><span class="home" data-reactid="18">Home</span></a></li><li class="navbar-item" data-reactid="19"><a class="nav-link " href="/postgraphile/" data-reactid="20">PostGraphile</a></li><li class="navbar-item" data-reactid="21"><a class="nav-link " href="/graphile-build/" data-reactid="22">Graphile Build</a></li><li class="navbar-item" data-reactid="23"><a class="nav-link " href="/support/" data-reactid="24">Support</a></li><li class="navbar-item" data-reactid="25"><a class="nav-link" href="https://graphql-training.com" title="GraphQL Training in London, Europe and Remote" data-reactid="26">GraphQL Training</a></li><li class="navbar-item ml-auto navbar-item-right" data-reactid="27"><span class="searchbox-container" data-reactid="28"><input id="search-box" placeholder="Search" data-reactid="29"/><span class="fa fa-search searchbox-search" data-reactid="30"></span></span></li><li class="navbar-item navbar-item-right" data-reactid="31"><a class="nav-link nav-github-link flex items-center" href="https://github.com/graphile/graphile-build" data-reactid="32"><span class="f3 fa fa-github" data-reactid="33"></span><!-- react-text: 34 --> <!-- /react-text --><span class="github" data-reactid="35">Github</span></a></li></ul></div></div></nav></header><div class="page-content" data-reactid="36"><section data-reactid="37"><div class="container" data-reactid="38"><div class="row between-xs" data-reactid="39"><aside class="sidebar col-xs-12 col-md-3 last-xs mt3" data-reactid="40"><section data-reactid="41"><h4 class="f6 ttu fw6 mt0 mb3 bb pb2" data-reactid="42">Usage</h4><div class="nested-list-reset" data-reactid="43"><ul class="page-list nav flex-column mb5" data-reactid="44"><li class="f6 lh-copy pv1" data-reactid="45"><a class="nav-link " href="/postgraphile/settings/" data-reactid="46">Settings</a></li></ul></div></section></aside><div class="col-xs-12 col-md-9 first-xs main-content" data-reactid="47"><div class="row" data-reactid="48"><div class="col-xs-12" style="width:100%;" data-reactid="49"><h2 id="security"><a href="#security" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Security</h2>
<p>Traditionally in web application architectures the security is implemented in
the server layer and the database is treated as a simple store of data - people
tend to figure that this reduces the workload on the database and thus
increases scalability. As their application grows, they start needing other
services to interact with the database too - which can mean that they need to
duplicate the authentication/authorization logic in multiple places which can
lead to discrepancies and increases the surface area for potential issues.</p>
<p>Instead, we advise that you protect your lowest level - the data itself. By
doing so you can be sure that no matter how many services interact with your
database they will all be protected by the same underlying permissions logic
which you only need to maintain in one place.</p>
<p>PostgreSQL already had a powerful permissions system built in with it's roles
and grants; but in PostgreSQL 9.5 Row Level Security policies were introduced.
These allow your application to be considerably more specific about permissions,
moving from table- and column-based permissions to row-level permissions.</p>
<p>When enabled, all rows are by default not visible to any roles (except database
administration roles and the role who created the database/table); and
permission is selectively granted with the use of policies.</p>
<p>If you already have a secure database schema that implements these technologies
to protect your data at the lowest levels then you can leverage
<code>postgraphile</code> to generate a powerful, secure and fast API in minimal
time. All you need to do is pass a pre-authenticated pgClient to the <code>graphql</code>
resolve function.</p>
<h3 id="example"><a href="#example" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example</h3>
<div class="gatsby-highlight">
      <pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createPostGraphileSchema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postgraphile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pgPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">pg<span class="token punctuation">.</span>Pool</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createPostGraphileSchema</span><span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'users_schema'</span><span class="token punctuation">,</span> <span class="token string">'posts_schema'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      dynamicJson<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      pgJwtSecret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>JWT_SECRET<span class="token punctuation">,</span>
      pgJwtTypeIdentifier<span class="token punctuation">:</span> <span class="token string">'users_schema.jwt_type'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fetch a postgres client from the pool</span>
  <span class="token keyword">const</span> pgClient <span class="token operator">=</span> <span class="token keyword">await</span> pgPool<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Start a transaction so we can apply settings local to the transaction</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// The following statement is equivalent to (but faster than):</span>
    <span class="token comment">//    await pgClient.query("set local role to 'postgraphile_user'");</span>
    <span class="token comment">//    await pgClient.query("set local jwt.claims.user_id to '27'");</span>
    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`select
<span class="gatsby-highlight-code-line">      set_config('role', 'postgraphile_user', true),
</span><span class="gatsby-highlight-code-line">      set_config('jwt.claims.user_id', '27', true)
</span>    `</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">graphql</span><span class="token punctuation">(</span>
      schema<span class="token punctuation">,</span>
      query<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">      <span class="token comment">/* CONTEXT > */</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        pgClient<span class="token punctuation">:</span> pgClient<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">/* &lt; CONTEXT */</span>
</span>      variables
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// commit the transaction (or rollback if there was an error) to clear the local settings</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
    <span class="token comment">// Release the pgClient back to the pool.</span>
    <span class="token keyword">await</span> pgClient<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">runQuery</span><span class="token punctuation">(</span>
  <span class="token string">"query MyQuery { allPosts { nodes { id, title, author: userByAuthorId { username } } } }"</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>result <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pgPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>TODO: ensure this example works.</p>
<p>To see how this works in a real application, check out
<a href="https://github.com/graphile/postgraphile/blob/master/src/postgraphile/withPostGraphileContext.ts"><code>withPostGraphileContext</code> in
PostGraphile</a></p></div><br data-reactid="50"/><br data-reactid="51"/><div class="col-xs-12 mt3 mb5" data-reactid="52"><div class="row between-xs" data-reactid="53"><div class="col-xs-6" data-reactid="54"></div><div class="col-xs-6 tr" data-reactid="55"></div></div></div></div></div></div></div></section></div><footer class="bg-white pv5 bt b--black f6 lh-copy" data-reactid="56"><div class="container" data-reactid="57"><div class="row" data-reactid="58"><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="59"><h6 data-reactid="60">PostGraphile</h6><ul data-reactid="61"><li data-reactid="62"><a href="/postgraphile/introduction/" data-reactid="63">Introduction</a></li><li data-reactid="64"><a href="/postgraphile/security/" data-reactid="65">Security</a></li><li data-reactid="66"><a href="/postgraphile/extending/" data-reactid="67">Extending</a></li></ul></div><div class="col-xs-12 col-md-2 nested-list-reset " data-reactid="68"><h6 data-reactid="69">Graphile Build</h6><ul data-reactid="70"><li data-reactid="71"><a href="/graphile-build/" data-reactid="72">About</a></li><li data-reactid="73"><a href="/graphile-build/getting-started/" data-reactid="74">Getting Started</a></li><li data-reactid="75"><a href="/graphile-build/plugins/" data-reactid="76">Plugins</a></li></ul></div><div class="col-xs-12 col-md-4 nested-list-reset" data-reactid="77"><h6 data-reactid="78">Community</h6><ul data-reactid="79"><li data-reactid="80"><a href="https://github.com/graphile" data-reactid="81">GitHub</a></li><li data-reactid="82"><a href="https://gitter.im/graphile/postgraphile" data-reactid="83">Gitter chat</a></li><li data-reactid="84"><a href="https://twitter.com/benjie" data-reactid="85">Twitter</a></li></ul></div><div class="col-xs-12 col-md-4" data-reactid="86"><h6 data-reactid="87">About</h6><!-- react-text: 88 -->PostGraphile and Graphile Build are Open Source Software, maintained by <!-- /react-text --><a href="https://twitter.com/benjie" data-reactid="89">Benjie Gillam</a><!-- react-text: 90 -->.<!-- /react-text --><br data-reactid="91"/><!-- react-text: 92 -->PostGraphile was <!-- /react-text --><a href="/history/" data-reactid="93">originally authored</a><!-- react-text: 94 --> as PostGraphQL by<!-- /react-text --><!-- react-text: 95 --> <!-- /react-text --><a href="https://twitter.com/calebmer" data-reactid="96">Caleb Meredith</a><!-- react-text: 97 -->.<!-- /react-text --><br data-reactid="98"/><br data-reactid="99"/><!-- react-text: 100 -->This site is copyright © Benjie Gillam <!-- /react-text --><!-- react-text: 101 -->2018<!-- /react-text --><!-- react-text: 102 -->. Design and logo copyright © Jof Arnold <!-- /react-text --><!-- react-text: 103 -->2018<!-- /react-text --><!-- react-text: 104 -->.<!-- /react-text --></div></div></div></footer></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-a4b82654ce794f4925ab.js","96961042003272":"component---src-templates-page-js-2afc0beefd3a360b7a68.js","59784799166159":"component---src-templates-marketing-js-3842ad12e778e1fe7110.js","60335399758886":"path----557518bd178906f8d58a.js","45788430371641":"path---history-70229d6424daa094bd0d.js","128602041518144":"path---graphile-build-all-hooks-f2875a364f0b6e8cdce9.js","64023390553510":"path---graphile-build-build-object-b1292e881c43d4768080.js","142629428675168":"path---index-b469f47a2642e25d5657.js","125892818282768":"path---graphile-build-default-plugins-3cc0947bf52501ebf2e0.js","69504633912515":"path---graphile-build-context-object-9271464eb50cebdfa878.js","109947277077173":"path---graphile-build-getting-started-890c0598ee25bb431171.js","16210746157911":"path---graphile-build-graphile-build-8a9bff3d9f8cfa9f3ba0.js","57552969484094":"path---graphile-build-hooks-49d9064f894b41e8b7c2.js","36474596372704":"path---graphile-build-omitting-plugins-faf01539e9afb32608ed.js","276285638780302":"path---graphile-build-plugin-options-a5fc3aaf496bfa5438e2.js","76338124382236":"path---graphile-build-look-ahead-872603b45566bc36b5f3.js","109627700230002":"path---graphile-build-ee68eb725e099e39487c.js","136546493962690":"path---graphile-build-plugins-124eb0b4d056fc2a354f.js","277477532944301":"path---graphile-build-schema-builder-ddd076cdf7e25137fd92.js","192423053311925":"path---graphile-build-pg-security-96c09579a81e1e0dbb0d.js","133858743292129":"path---postgraphile-settings-f58a65f305f073caed2a.js","245194823331250":"path---postgraphile-connections-0ff8b4ff597511e5f5eb.js","99411096849217":"path---postgraphile-computed-columns-2c0cf97792e93248c995.js","209456356109321":"path---postgraphile-custom-mutations-f1672c839fb23cd54356.js","226259727392765":"path---postgraphile-crud-mutations-f7c8903f282d1247f904.js","183024611244872":"path---postgraphile-default-role-c382656c43c24f56d0d5.js","262226386268176":"path---postgraphile-custom-queries-9906f2c7e1a9063df6b1.js","46110498460401":"path---postgraphile-evaluating-f91edbfd1e355be7fa8d.js","1465359564156":"path---postgraphile-extending-c4d9542dab4cdd6d529e.js","29661158995595":"path---postgraphile-filtering-8ab1296bf9a70e72576c.js","231292683096477":"path---postgraphile-introduction-7d479bb8949b602518a1.js","33982096820675":"path---postgraphile-introspection-185d15a5906bdf60bac1.js","48764759135427":"path---postgraphile-074c190f76fa919d3168.js","217512476184238":"path---postgraphile-jwt-guide-cc9a94db9163144e8677.js","245838197689590":"path---postgraphile-performance-fae4c58881247475ba85.js","43306645800525":"path---postgraphile-postgresql-indexes-2a88d62102407b8617ec.js","17839233601159":"path---postgraphile-postgresql-schema-design-33cc2637657bed5887b9.js","257659440118484":"path---postgraphile-procedures-41a59cdb5f614dc0d0bd.js","136696082986067":"path---postgraphile-relations-e424a66a362f6711b1b8.js","20524195157075":"path---postgraphile-quick-start-guide-54d0d8ad6b74663cdf6a.js","187294999324209":"path---postgraphile-requirements-a71cd507c566cbb5d252.js","143935096069691":"path---postgraphile-security-9105797a7ae0b3cba2be.js","3265662318058":"path---postgraphile-usage-cli-c5998f90495ae79bbcda.js","87638492893048":"path---postgraphile-v-3-migration-5ef8d443a4752f239784.js","141666846945901":"path---support-3fe4e178677e74370cc1.js","148070795768796":"path---postgraphile-usage-library-208b9912c174ac364859.js","272066437984048":"path---postgraphile-usage-schema-5d42185330ff831dc1dd.js","247601703930759":"path---postgraphile-usage-0fe5ef23d799cba5087a.js","114276838955818":"component---src-layouts-index-js-5b458069f989776282f8.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-097a3c7bcbdcfe23a531.js","/app-a4b82654ce794f4925ab.js","/path---graphile-build-pg-security-96c09579a81e1e0dbb0d.js","/component---src-templates-page-js-2afc0beefd3a360b7a68.js","/component---src-layouts-index-js-5b458069f989776282f8.js"])/*]]>*/</script><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script></body></html>